var sc=Object.defineProperty;var ic=(n,e,t)=>e in n?sc(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Me=(n,e,t)=>(ic(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const wt="4.28.4";let ji=!1,Xt,$a,Na,ds,La,Ua,Da,Ma,Ba;function ac(n,e={auto:!1}){if(ji)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(Xt)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${Xt}'\``);ji=e.auto,Xt=n.kind,$a=n.fetch,n.Request,n.Response,n.Headers,Na=n.FormData,n.Blob,ds=n.File,La=n.ReadableStream,Ua=n.getMultipartRequestOptions,Da=n.getDefaultAgent,Ma=n.fileFromPath,Ba=n.isFsReadStream}class oc{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function cc({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,r,s,i;try{t=fetch,r=Request,s=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:s,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new oc(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}Xt||ac(cc(),{auto:!0});let $=class extends Error{},ce=class fs extends ${constructor(e,t,r,s){super(`${fs.makeMessage(e,t,r)}`),this.status=e,this.headers=s;const i=t;this.error=i,this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,t,r){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e)return new gr({cause:ms(t)});const i=t==null?void 0:t.error;return e===400?new Gs(e,i,r,s):e===401?new Ws(e,i,r,s):e===403?new Qs(e,i,r,s):e===404?new Xs(e,i,r,s):e===409?new Ys(e,i,r,s):e===422?new ei(e,i,r,s):e===429?new ti(e,i,r,s):e>=500?new ri(e,i,r,s):new fs(e,i,r,s)}},Ge=class extends ce{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},gr=class extends ce{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},Tn=class extends gr{constructor({message:e}={}){super({message:e??"Request timed out."})}},Gs=class extends ce{constructor(){super(...arguments),this.status=400}},Ws=class extends ce{constructor(){super(...arguments),this.status=401}},Qs=class extends ce{constructor(){super(...arguments),this.status=403}},Xs=class extends ce{constructor(){super(...arguments),this.status=404}},Ys=class extends ce{constructor(){super(...arguments),this.status=409}},ei=class extends ce{constructor(){super(...arguments),this.status=422}},ti=class extends ce{constructor(){super(...arguments),this.status=429}},ri=class extends ce{};const uc=Object.freeze(Object.defineProperty({__proto__:null,APIConnectionError:gr,APIConnectionTimeoutError:Tn,APIError:ce,APIUserAbortError:Ge,AuthenticationError:Ws,BadRequestError:Gs,ConflictError:Ys,InternalServerError:ri,NotFoundError:Xs,OpenAIError:$,PermissionDeniedError:Qs,RateLimitError:ti,UnprocessableEntityError:ei},Symbol.toStringTag,{value:"Module"}));class Ze{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;const s=new lc;async function*i(){if(!e.body)throw t.abort(),new $("Attempted to iterate over a response with no body");const o=new ut,c=$i(e.body);for await(const u of c)for(const l of o.decode(u)){const h=s.decode(l);h&&(yield h)}for(const u of o.flush()){const l=s.decode(u);l&&(yield l)}}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const c of i())if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null){let u;try{u=JSON.parse(c.data)}catch(l){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),l}if(u&&u.error)throw new ce(void 0,u.error,void 0,void 0);yield u}}o=!0}catch(c){if(c instanceof Error&&c.name==="AbortError")return;throw c}finally{o||t.abort()}}return new Ze(a,t)}static fromReadableStream(e,t){let r=!1;async function*s(){const a=new ut,o=$i(e);for await(const c of o)for(const u of a.decode(c))yield u;for(const c of a.flush())yield c}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new Ze(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new Ze(()=>s(e),this.controller),new Ze(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new La({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:i,done:a}=await t.next();if(a)return s.close();const o=r.encode(JSON.stringify(i)+`
`);s.enqueue(o)}catch(i){s.error(i)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}}class lc{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=hc(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}class ut{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const r=ut.NEWLINE_CHARS.has(t[t.length-1]||"");let s=t.split(ut.NEWLINE_REGEXP);return s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new $(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new $(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new $("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}ut.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","","\u2028","\u2029"]);ut.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function hc(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function $i(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const Fa=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",dc=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&za(n),za=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",fc=n=>dc(n)||Fa(n)||Ba(n);async function qa(n,e,t={}){var s;if(n=await n,Fa(n)){const i=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new ds([i],e,t)}const r=await pc(n);if(e||(e=gc(n)??"unknown_file"),!t.type){const i=(s=r[0])==null?void 0:s.type;typeof i=="string"&&(t={...t,type:i})}return new ds(r,e,t)}async function pc(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(za(n))e.push(await n.arrayBuffer());else if(yc(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${mc(n)}`);return e}function mc(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function gc(n){var e;return Fn(n.name)||Fn(n.filename)||((e=Fn(n.path))==null?void 0:e.split(/[\\/]/).pop())}const Fn=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},yc=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Ni=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",sr=async n=>{const e=await _c(n.body);return Ua(e,n)},_c=async n=>{const e=new Na;return await Promise.all(Object.entries(n||{}).map(([t,r])=>ps(e,t,r))),e},ps=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(fc(t)){const r=await qa(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>ps(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>ps(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Cr={},bc=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},wc=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},vr;async function Va(n){const{response:e}=n;if(n.options.stream)return xt("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Ze.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){const i=await e.json();return xt("response",e.status,e.url,e.headers,i),i}const s=await e.text();return xt("response",e.status,e.url,e.headers,s),s}class Sn extends Promise{constructor(e,t=Va){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Sn(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class vc{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:s,fetch:i}){this.baseURL=e,this.maxRetries=zn("maxRetries",t),this.timeout=zn("timeout",r),this.httpAgent=s,this.fetch=i??$a}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Pc(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ic()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:t,...s})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){var p;const{method:t,path:r,query:s,headers:i={}}=e,a=Ni(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(a),c=this.buildURL(r,s);"timeout"in e&&zn("timeout",e.timeout);const u=e.timeout??this.timeout,l=e.httpAgent??this.httpAgent??Da(c),h=u+1e3;typeof((p=l==null?void 0:l.options)==null?void 0:p.timeout)=="number"&&h>(l.options.timeout??0)&&(l.options.timeout=h),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const d=this.buildHeaders({options:e,headers:i,contentLength:o});return{req:{method:t,...a&&{body:a},headers:d,...l&&{agent:l},signal:e.signal??null},url:c,timeout:u}}buildHeaders({options:e,headers:t,contentLength:r}){const s={};r&&(s["content-length"]=r);const i=this.defaultHeaders(e);return Mi(s,i),Mi(s,t),Ni(e.body)&&Xt!=="node"&&delete s["content-type"],this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,s){return ce.generate(e,t,r,s)}request(e,t=null){return new Sn(this.makeRequest(e,t))}async makeRequest(e,t){var l,h;const r=await e;t==null&&(t=r.maxRetries??this.maxRetries),await this.prepareOptions(r);const{req:s,url:i,timeout:a}=this.buildRequest(r);if(await this.prepareRequest(s,{url:i,options:r}),xt("request",i,r,s.headers),(l=r.signal)!=null&&l.aborted)throw new Ge;const o=new AbortController,c=await this.fetchWithTimeout(i,s,a,o).catch(ms);if(c instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new Ge;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new Tn:new gr({cause:c})}const u=kc(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const b=`retrying, ${t} attempts remaining`;return xt(`response (error; ${b})`,c.status,i,u),this.retryRequest(r,t,u)}const d=await c.text().catch(b=>ms(b).message),f=Tc(d),p=f?void 0:d;throw xt(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,u,p),this.makeStatusError(c.status,f,p,u)}return{response:c,options:r,controller:o}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new Ac(this,r,e)}buildURL(e,t){const r=Cc(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return Ja(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new $(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,s){const{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...a}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let s;const i=r==null?void 0:r["retry-after-ms"];if(i){const o=parseFloat(i);Number.isNaN(o)||(s=o)}const a=r==null?void 0:r["retry-after"];if(a&&!s){const o=parseFloat(a);Number.isNaN(o)?s=Date.parse(a)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Za(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${wt}`}}class Ha{constructor(e,t,r,s){vr.set(this,void 0),bc(this,vr,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new $("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[s,i]of r)e.url.searchParams.set(s,i);t.query=void 0,t.path=e.url.toString()}return await wc(this,vr,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(vr=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Ac extends Sn{constructor(e,t,r){super(t,async s=>new r(e,s.response,await Va(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const kc=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),Ec={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},xe=n=>typeof n=="object"&&n!==null&&!Ja(n)&&Object.keys(n).every(e=>Ka(Ec,e)),Oc=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":wt,"X-Stainless-OS":Ui(Deno.build.os),"X-Stainless-Arch":Li(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":wt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":wt,"X-Stainless-OS":Ui(process.platform),"X-Stainless-Arch":Li(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=xc();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":wt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":wt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function xc(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const Li=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Ui=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Di;const Pc=()=>Di??(Di=Oc()),Tc=n=>{try{return JSON.parse(n)}catch{return}},Sc=new RegExp("^(?:[a-z]+:)?//","i"),Cc=n=>Sc.test(n),Za=n=>new Promise(e=>setTimeout(e,n)),zn=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new $(`${n} must be an integer`);if(e<0)throw new $(`${n} must be a positive integer`);return e},ms=n=>n instanceof Error?n:new Error(n),qn=n=>{var e,t,r,s;if(typeof process<"u")return((e=Cr==null?void 0:Cr[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(s=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:s.trim()};function Ja(n){if(!n)return!0;for(const e in n)return!1;return!0}function Ka(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Mi(n,e){for(const t in e){if(!Ka(e,t))continue;const r=t.toLowerCase();if(!r)continue;const s=e[t];s===null?delete n[r]:s!==void 0&&(n[r]=s)}}function xt(n,...e){typeof process<"u"&&Cr.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}const Ic=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Rc=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";class ni extends Ha{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class De extends Ha{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}}class M{constructor(e){this._client=e}}let Ur=class extends M{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}};Ur||(Ur={});let Dr=class extends M{constructor(){super(...arguments),this.completions=new Ur(this._client)}};(function(n){n.Completions=Ur})(Dr||(Dr={}));class Mr extends M{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}Mr||(Mr={});class Br extends M{create(e,t){return this._client.post("/audio/transcriptions",sr({body:e,...t}))}}Br||(Br={});class Fr extends M{create(e,t){return this._client.post("/audio/translations",sr({body:e,...t}))}}Fr||(Fr={});class zr extends M{constructor(){super(...arguments),this.transcriptions=new Br(this._client),this.translations=new Fr(this._client),this.speech=new Mr(this._client)}}(function(n){n.Transcriptions=Br,n.Translations=Fr,n.Speech=Mr})(zr||(zr={}));let qr=class extends M{create(e,t,r){return this._client.post(`/assistants/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/assistants/${e}/files`,si,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}};class si extends De{}(function(n){n.AssistantFilesPage=si})(qr||(qr={}));class Vr extends M{constructor(){super(...arguments),this.files=new qr(this._client)}create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/assistants",ii,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}class ii extends De{}(function(n){n.AssistantsPage=ii,n.Files=qr,n.AssistantFilesPage=si})(Vr||(Vr={}));function Bi(n){return typeof n.parse=="function"}const Pt=n=>(n==null?void 0:n.role)==="assistant",Ga=n=>(n==null?void 0:n.role)==="function",Wa=n=>(n==null?void 0:n.role)==="tool";var fe=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},C=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Y,Ir,Rr,Ht,Zt,jr,Jt,Ce,Kt,$r,Nr,vt,gs,Hr,ys,_s,bs,ws,Qa,vs;const Fi=10;class Xa{constructor(){Y.add(this),this.controller=new AbortController,Ir.set(this,void 0),Rr.set(this,()=>{}),Ht.set(this,()=>{}),Zt.set(this,void 0),jr.set(this,()=>{}),Jt.set(this,()=>{}),Ce.set(this,{}),this._chatCompletions=[],this.messages=[],Kt.set(this,!1),$r.set(this,!1),Nr.set(this,!1),vt.set(this,!1),ws.set(this,e=>{if(fe(this,$r,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Ge),e instanceof Ge)return fe(this,Nr,!0,"f"),this._emit("abort",e);if(e instanceof $)return this._emit("error",e);if(e instanceof Error){const t=new $(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new $(String(e)))}),fe(this,Ir,new Promise((e,t)=>{fe(this,Rr,e,"f"),fe(this,Ht,t,"f")}),"f"),fe(this,Zt,new Promise((e,t)=>{fe(this,jr,e,"f"),fe(this,Jt,t,"f")}),"f"),C(this,Ir,"f").catch(()=>{}),C(this,Zt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},C(this,ws,"f"))},0)}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Ga(e)||Wa(e))&&e.content)this._emit("functionCallResult",e.content);else if(Pt(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Pt(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}_connected(){this.ended||(C(this,Rr,"f").call(this),this._emit("connect"))}get ended(){return C(this,Kt,"f")}get errored(){return C(this,$r,"f")}get aborted(){return C(this,Nr,"f")}abort(){this.controller.abort()}on(e,t){return(C(this,Ce,"f")[e]||(C(this,Ce,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=C(this,Ce,"f")[e];if(!r)return this;const s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(C(this,Ce,"f")[e]||(C(this,Ce,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{fe(this,vt,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){fe(this,vt,!0,"f"),await C(this,Zt,"f")}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new $("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),C(this,Y,"m",gs).call(this)}async finalMessage(){return await this.done(),C(this,Y,"m",Hr).call(this)}async finalFunctionCall(){return await this.done(),C(this,Y,"m",ys).call(this)}async finalFunctionCallResult(){return await this.done(),C(this,Y,"m",_s).call(this)}async totalUsage(){return await this.done(),C(this,Y,"m",bs).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(C(this,Kt,"f"))return;e==="end"&&(fe(this,Kt,!0,"f"),C(this,jr,"f").call(this));const r=C(this,Ce,"f")[e];if(r&&(C(this,Ce,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){const s=t[0];!C(this,vt,"f")&&!(r!=null&&r.length)&&Promise.reject(s),C(this,Ht,"f").call(this,s),C(this,Jt,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=t[0];!C(this,vt,"f")&&!(r!=null&&r.length)&&Promise.reject(s),C(this,Ht,"f").call(this,s),C(this,Jt,"f").call(this,s),this._emit("end")}}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=C(this,Y,"m",Hr).call(this);t&&this._emit("finalMessage",t);const r=C(this,Y,"m",gs).call(this);r&&this._emit("finalContent",r);const s=C(this,Y,"m",ys).call(this);s&&this._emit("finalFunctionCall",s);const i=C(this,Y,"m",_s).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",C(this,Y,"m",bs).call(this))}async _createChatCompletion(e,t,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),C(this,Y,"m",Qa).call(this,t);const i=await e.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(i)}async _runChatCompletion(e,t,r){for(const s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var d;const s="function",{function_call:i="auto",stream:a,...o}=t,c=typeof i!="string"&&(i==null?void 0:i.name),{maxChatCompletions:u=Fi}=r||{},l={};for(const f of t.functions)l[f.name||f.function.name]=f;const h=t.functions.map(f=>({name:f.name||f.function.name,parameters:f.parameters,description:f.description}));for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<u;++f){const g=(d=(await this._createChatCompletion(e,{...o,function_call:i,functions:h,messages:[...this.messages]},r)).choices[0])==null?void 0:d.message;if(!g)throw new $("missing message in ChatCompletion response");if(!g.function_call)return;const{name:m,arguments:b}=g.function_call,A=l[m];if(A){if(c&&c!==m){const H=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,name:m,content:H});continue}}else{const H=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${h.map(X=>JSON.stringify(X.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:m,content:H});continue}let k;try{k=Bi(A)?await A.parse(b):b}catch(H){this._addMessage({role:s,name:m,content:H instanceof Error?H.message:String(H)});continue}const x=await A.function(k,this),O=C(this,Y,"m",vs).call(this,x);if(this._addMessage({role:s,name:m,content:O}),c)return}}async _runTools(e,t,r){var d,f;const s="tool",{tool_choice:i="auto",stream:a,...o}=t,c=typeof i!="string"&&((d=i==null?void 0:i.function)==null?void 0:d.name),{maxChatCompletions:u=Fi}=r||{},l={};for(const p of t.tools)p.type==="function"&&(l[p.function.name||p.function.function.name]=p.function);const h="tools"in t?t.tools.map(p=>p.type==="function"?{type:"function",function:{name:p.function.name||p.function.function.name,parameters:p.function.parameters,description:p.function.description}}:p):void 0;for(const p of t.messages)this._addMessage(p,!1);for(let p=0;p<u;++p){const m=(f=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:f.message;if(!m)throw new $("missing message in ChatCompletion response");if(!m.tool_calls)return;for(const b of m.tool_calls){if(b.type!=="function")continue;const A=b.id,{name:k,arguments:x}=b.function,O=l[k];if(O){if(c&&c!==k){const K=`Invalid tool_call: ${JSON.stringify(k)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,tool_call_id:A,content:K});continue}}else{const K=`Invalid tool_call: ${JSON.stringify(k)}. Available options are: ${h.map(Bn=>JSON.stringify(Bn.function.name)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:A,content:K});continue}let H;try{H=Bi(O)?await O.parse(x):x}catch(K){const Bn=K instanceof Error?K.message:String(K);this._addMessage({role:s,tool_call_id:A,content:Bn});continue}const X=await O.function(H,this),dt=C(this,Y,"m",vs).call(this,X);if(this._addMessage({role:s,tool_call_id:A,content:dt}),c)return}}}}Ir=new WeakMap,Rr=new WeakMap,Ht=new WeakMap,Zt=new WeakMap,jr=new WeakMap,Jt=new WeakMap,Ce=new WeakMap,Kt=new WeakMap,$r=new WeakMap,Nr=new WeakMap,vt=new WeakMap,ws=new WeakMap,Y=new WeakSet,gs=function(){return C(this,Y,"m",Hr).call(this).content??null},Hr=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Pt(t))return{...t,content:t.content??null}}throw new $("stream ended without producing a ChatCompletionMessage with role=assistant")},ys=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(Pt(s)&&(s!=null&&s.function_call))return s.function_call;if(Pt(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(t=s.tool_calls.at(-1))==null?void 0:t.function}},_s=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ga(t)&&t.content!=null||Wa(t)&&t.content!=null&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(i=>i.type==="function"&&i.id===t.tool_call_id))}))return t.content}},bs=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Qa=function(e){if(e.n!=null&&e.n>1)throw new $("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},vs=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class ir extends Xa{static runFunctions(e,t,r){const s=new ir,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,r){const s=new ir,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}_addMessage(e){super._addMessage(e),Pt(e)&&e.content&&this._emit("content",e.content)}}var pe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Vn=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},we,Be,Hn,Zn,Ar,zi;class ar extends Xa{constructor(){super(...arguments),we.add(this),Be.set(this,void 0)}get currentChatCompletionSnapshot(){return pe(this,Be,"f")}static fromReadableStream(e){const t=new ar;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const s=new ar;return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,r){var a;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),pe(this,we,"m",Hn).call(this);const i=await e.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of i)pe(this,we,"m",Zn).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new Ge;return this._addChatCompletion(pe(this,we,"m",Ar).call(this))}async _fromReadableStream(e,t){var a;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),pe(this,we,"m",Hn).call(this),this._connected();const s=Ze.fromReadableStream(e,this.controller);let i;for await(const o of s)i&&i!==o.id&&this._addChatCompletion(pe(this,we,"m",Ar).call(this)),pe(this,we,"m",Zn).call(this,o),i=o.id;if((a=s.controller.signal)!=null&&a.aborted)throw new Ge;return this._addChatCompletion(pe(this,we,"m",Ar).call(this))}[(Be=new WeakMap,we=new WeakSet,Hn=function(){this.ended||Vn(this,Be,void 0,"f")},Zn=function(t){var a,o,c;if(this.ended)return;const r=pe(this,we,"m",zi).call(this,t);this._emit("chunk",t,r);const s=(o=(a=t.choices[0])==null?void 0:a.delta)==null?void 0:o.content,i=(c=r.choices[0])==null?void 0:c.message;s!=null&&(i==null?void 0:i.role)==="assistant"&&(i!=null&&i.content)&&this._emit("content",s,i.content)},Ar=function(){if(this.ended)throw new $("stream has ended, this shouldn't happen");const t=pe(this,Be,"f");if(!t)throw new $("request ended without sending any chunks");return Vn(this,Be,void 0,"f"),jc(t)},zi=function(t){var r,s,i;let a=pe(this,Be,"f");const{choices:o,...c}=t;a?Object.assign(a,c):a=Vn(this,Be,{...c,choices:[]},"f");for(const{delta:u,finish_reason:l,index:h,logprobs:d=null,...f}of t.choices){let p=a.choices[h];if(p||(p=a.choices[h]={finish_reason:l,index:h,message:{},logprobs:d,...f}),d)if(!p.logprobs)p.logprobs=Object.assign({},d);else{const{content:x,...O}=d;Object.assign(p.logprobs,O),x&&((r=p.logprobs).content??(r.content=[]),p.logprobs.content.push(...x))}if(l&&(p.finish_reason=l),Object.assign(p,f),!u)continue;const{content:g,function_call:m,role:b,tool_calls:A,...k}=u;if(Object.assign(p.message,k),g&&(p.message.content=(p.message.content||"")+g),b&&(p.message.role=b),m&&(p.message.function_call?(m.name&&(p.message.function_call.name=m.name),m.arguments&&((s=p.message.function_call).arguments??(s.arguments=""),p.message.function_call.arguments+=m.arguments)):p.message.function_call=m),A){p.message.tool_calls||(p.message.tool_calls=[]);for(const{index:x,id:O,type:H,function:X,...dt}of A){const K=(i=p.message.tool_calls)[x]??(i[x]={});Object.assign(K,dt),O&&(K.id=O),H&&(K.type=H),X&&(K.function??(K.function={arguments:""})),X!=null&&X.name&&(K.function.name=X.name),X!=null&&X.arguments&&(K.function.arguments+=X.arguments)}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",s=>{const i=t.shift();i?i(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s(void 0);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise(i=>t.push(i)).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0})}}toReadableStream(){return new Ze(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function jc(n){const{id:e,choices:t,created:r,model:s,system_fingerprint:i,...a}=n;return{...a,id:e,choices:t.map(({message:o,finish_reason:c,index:u,logprobs:l,...h})=>{if(!c)throw new $(`missing finish_reason for choice ${u}`);const{content:d=null,function_call:f,tool_calls:p,...g}=o,m=o.role;if(!m)throw new $(`missing role for choice ${u}`);if(f){const{arguments:b,name:A}=f;if(b==null)throw new $(`missing function_call.arguments for choice ${u}`);if(!A)throw new $(`missing function_call.name for choice ${u}`);return{...h,message:{content:d,function_call:{arguments:b,name:A},role:m},finish_reason:c,index:u,logprobs:l}}return p?{...h,index:u,finish_reason:c,logprobs:l,message:{...g,role:m,content:d,tool_calls:p.map((b,A)=>{const{function:k,type:x,id:O,...H}=b,{arguments:X,name:dt,...K}=k||{};if(O==null)throw new $(`missing choices[${u}].tool_calls[${A}].id
${kr(n)}`);if(x==null)throw new $(`missing choices[${u}].tool_calls[${A}].type
${kr(n)}`);if(dt==null)throw new $(`missing choices[${u}].tool_calls[${A}].function.name
${kr(n)}`);if(X==null)throw new $(`missing choices[${u}].tool_calls[${A}].function.arguments
${kr(n)}`);return{...H,id:O,type:x,function:{...K,name:dt,arguments:X}}})}}:{...h,message:{...g,content:d,role:m},finish_reason:c,index:u,logprobs:l}}),created:r,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}}}function kr(n){return JSON.stringify(n)}class Tt extends ar{static fromReadableStream(e){const t=new Tt;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const s=new Tt,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,r){const s=new Tt,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}}let Ya=class extends M{runFunctions(e,t){return e.stream?Tt.runFunctions(this._client.chat.completions,e,t):ir.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?Tt.runTools(this._client.chat.completions,e,t):ir.runTools(this._client.chat.completions,e,t)}stream(e,t){return ar.createChatCompletion(this._client.chat.completions,e,t)}};class Zr extends M{constructor(){super(...arguments),this.completions=new Ya(this._client)}}(function(n){n.Completions=Ya})(Zr||(Zr={}));let Jr=class extends M{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/messages/${t}/files/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return xe(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/messages/${t}/files`,ai,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}};class ai extends De{}(function(n){n.MessageFilesPage=ai})(Jr||(Jr={}));class Kr extends M{constructor(){super(...arguments),this.files=new Jr(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,oi,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}}class oi extends De{}(function(n){n.ThreadMessagesPage=oi,n.Files=Jr,n.MessageFilesPage=ai})(Kr||(Kr={}));class Gr extends M{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return xe(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,ci,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}}class ci extends De{}(function(n){n.RunStepsPage=ci})(Gr||(Gr={}));class Wr extends M{constructor(){super(...arguments),this.steps=new Gr(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/runs`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,ui,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}submitToolOutputs(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}}class ui extends De{}(function(n){n.RunsPage=ui,n.Steps=Gr,n.RunStepsPage=ci})(Wr||(Wr={}));class Qr extends M{constructor(){super(...arguments),this.runs=new Wr(this._client),this.messages=new Kr(this._client)}create(e={},t){return xe(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}(function(n){n.Runs=Wr,n.RunsPage=ui,n.Messages=Kr,n.ThreadMessagesPage=oi})(Qr||(Qr={}));class Xr extends M{constructor(){super(...arguments),this.chat=new Zr(this._client),this.assistants=new Vr(this._client),this.threads=new Qr(this._client)}}(function(n){n.Chat=Zr,n.Assistants=Vr,n.AssistantsPage=ii,n.Threads=Qr})(Xr||(Xr={}));class Yr extends M{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}Yr||(Yr={});let en=class extends M{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};en||(en={});class tn extends M{create(e,t){return this._client.post("/files",sr({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/files",li,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Za(t),a=await this.retrieve(e),Date.now()-i>r)throw new Tn({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return a}}class li extends ni{}(function(n){n.FileObjectsPage=li})(tn||(tn={}));class rn extends M{create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",hi,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return xe(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,di,{query:t,...r})}}class hi extends De{}class di extends De{}(function(n){n.FineTuningJobsPage=hi,n.FineTuningJobEventsPage=di})(rn||(rn={}));class nn extends M{constructor(){super(...arguments),this.jobs=new rn(this._client)}}(function(n){n.Jobs=rn,n.FineTuningJobsPage=hi,n.FineTuningJobEventsPage=di})(nn||(nn={}));class sn extends M{createVariation(e,t){return this._client.post("/images/variations",sr({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",sr({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}sn||(sn={});class an extends M{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",fi,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class fi extends ni{}(function(n){n.ModelsPage=fi})(an||(an={}));class on extends M{create(e,t){return this._client.post("/moderations",{body:e,...t})}}on||(on={});var eo;let V=class extends vc{constructor({baseURL:e=qn("OPENAI_BASE_URL"),apiKey:t=qn("OPENAI_API_KEY"),organization:r=qn("OPENAI_ORG_ID")??null,...s}={}){if(t===void 0)throw new $("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&Rc())throw new $(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Yr(this),this.chat=new Dr(this),this.embeddings=new en(this),this.files=new tn(this),this.images=new sn(this),this.audio=new zr(this),this.moderations=new on(this),this.models=new an(this),this.fineTuning=new nn(this),this.beta=new Xr(this),this._options=i,this.apiKey=t,this.organization=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};eo=V;V.OpenAI=eo;V.OpenAIError=$;V.APIError=ce;V.APIConnectionError=gr;V.APIConnectionTimeoutError=Tn;V.APIUserAbortError=Ge;V.NotFoundError=Xs;V.ConflictError=Ys;V.RateLimitError=ti;V.BadRequestError=Gs;V.AuthenticationError=Ws;V.InternalServerError=ri;V.PermissionDeniedError=Qs;V.UnprocessableEntityError=ei;const{OpenAIError:Up,APIError:Dp,APIConnectionError:Mp,APIConnectionTimeoutError:$c,APIUserAbortError:Nc,NotFoundError:Bp,ConflictError:Fp,RateLimitError:zp,BadRequestError:qp,AuthenticationError:Vp,InternalServerError:Hp,PermissionDeniedError:Zp,UnprocessableEntityError:Jp}=uc;(function(n){n.toFile=qa,n.fileFromPath=Ma,n.Page=ni,n.CursorPage=De,n.Completions=Yr,n.Chat=Dr,n.Embeddings=en,n.Files=tn,n.FileObjectsPage=li,n.Images=sn,n.Audio=zr,n.Moderations=on,n.Models=an,n.ModelsPage=fi,n.FineTuning=nn,n.Beta=Xr})(V||(V={}));function pi(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Lc=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const Uc=pi(Lc);var to={exports:{}};const Dc=/[\p{Lu}]/u,Mc=/[\p{Ll}]/u,qi=/^[\p{Lu}](?![\p{Lu}])/gu,ro=/([\p{Alpha}\p{N}_]|$)/u,no=/[_.\- ]+/,Bc=new RegExp("^"+no.source),Vi=new RegExp(no.source+ro.source,"gu"),Hi=new RegExp("\\d+"+ro.source,"gu"),Fc=(n,e,t)=>{let r=!1,s=!1,i=!1;for(let a=0;a<n.length;a++){const o=n[a];r&&Dc.test(o)?(n=n.slice(0,a)+"-"+n.slice(a),r=!1,i=s,s=!0,a++):s&&i&&Mc.test(o)?(n=n.slice(0,a-1)+"-"+n.slice(a-1),i=s,s=!1,r=!0):(r=e(o)===o&&t(o)!==o,i=s,s=t(o)===o&&e(o)!==o)}return n},zc=(n,e)=>(qi.lastIndex=0,n.replace(qi,t=>e(t))),qc=(n,e)=>(Vi.lastIndex=0,Hi.lastIndex=0,n.replace(Vi,(t,r)=>e(r)).replace(Hi,t=>e(t))),so=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(i=>i.trim()).filter(i=>i.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?i=>i.toLowerCase():i=>i.toLocaleLowerCase(e.locale),r=e.locale===!1?i=>i.toUpperCase():i=>i.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Fc(n,t,r)),n=n.replace(Bc,""),e.preserveConsecutiveUppercase?n=zc(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),qc(n,r))};to.exports=so;to.exports.default=so;function Vc(n,e){return(e==null?void 0:e[n])||Uc(n)}function Hc(n,e,t){const r={};for(const s in n)Object.hasOwn(n,s)&&(r[e(s,t)]=n[s]);return r}function Zi(n){return Array.isArray(n)?[...n]:{...n}}function Zc(n,e){const t=Zi(n);for(const[r,s]of Object.entries(e)){const[i,...a]=r.split(".").reverse();let o=t;for(const c of a.reverse()){if(o[c]===void 0)break;o[c]=Zi(o[c]),o=o[c]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return t}function io(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class We{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,io(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof We||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let i=this,a=r;const[o,...c]=s.split(".").reverse();for(const u of c.reverse()){if(!(u in i)||i[u]===void 0)return;(!(u in a)||a[u]===void 0)&&(typeof i[u]=="object"&&i[u]!=null?a[u]={}:Array.isArray(i[u])&&(a[u]=[])),i=i[u],a=a[u]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Hc(Object.keys(t).length?Zc(r,t):r,Vc,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function Dt(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}class yr extends We{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if(e==="human")return new or({...this});if(e==="ai")return new Rt({...this});if(e==="system")return new cr({...this});if(e==="function")return new ur({...this});if(_r.isInstance(this))return new lr({...this});throw new Error("Unknown message type.")}}function Ji(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}class Mt extends yr{static _mergeAdditionalKwargs(e,t){var s,i;const r={...e};for(const[a,o]of Object.entries(t))if(r[a]===void 0)r[a]=o;else{if(typeof r[a]!=typeof o)throw new Error(`additional_kwargs[${a}] already exists in the message chunk, but with a different type.`);if(typeof r[a]=="string")r[a]=r[a]+o;else if(!Array.isArray(r[a])&&typeof r[a]=="object")r[a]=this._mergeAdditionalKwargs(r[a],o);else if(a==="tool_calls"&&Ji(r[a])&&Ji(o))for(const c of o)((s=r[a])==null?void 0:s[c.index])!==void 0?r[a]=(i=r[a])==null?void 0:i.map((u,l)=>l!==c.index?u:{...u,...c,function:{name:c.function.name??u.function.name,arguments:(u.function.arguments??"")+(c.function.arguments??"")}}):r[a][c.index]=c;else throw new Error(`additional_kwargs[${a}] already exists in this message chunk.`)}return r}}class cn extends yr{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class or extends Mt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new or({content:Dt(this.content,e.content),additional_kwargs:or._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class ao extends yr{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class Rt extends Mt{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new Rt({content:Dt(this.content,e.content),additional_kwargs:Rt._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class Jc extends yr{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class cr extends Mt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new cr({content:Dt(this.content,e.content),additional_kwargs:cr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class ur extends Mt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new ur({content:Dt(this.content,e.content),additional_kwargs:ur._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:this.name??""})}}class un extends Mt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new un({content:Dt(this.content,e.content),additional_kwargs:un._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),tool_call_id:this.tool_call_id})}}class _r extends yr{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return _r}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}function mi(n){return typeof(n==null?void 0:n._getType)=="function"}function Kc(n){return mi(n)&&typeof n.concat=="function"}function Gt(n){if(typeof n=="string")return new cn(n);if(mi(n))return n;const[e,t]=n;if(e==="human"||e==="user")return new cn({content:t});if(e==="ai"||e==="assistant")return new ao({content:t});if(e==="system")return new Jc({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}class lr extends Mt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new lr({content:Dt(this.content,e.content),additional_kwargs:lr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function oo(n,e="Human",t="AI"){const r=[];for(const s of n){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=t;else if(s._getType()==="system")i="System";else if(s._getType()==="function")i="Function";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"";r.push(`${i}: ${a}${s.content}`)}return r.join(`
`)}const Ki="__run";class Cn{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Cn({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class hr extends Cn{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new hr({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}var Jn={};const Gc=()=>typeof window<"u"&&typeof window.document<"u",Wc=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Qc=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),co=()=>typeof Deno<"u",Xc=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!co(),Yc=()=>{let n;return Gc()?n="browser":Xc()?n="node":Wc()?n="webworker":Qc()?n="jsdom":co()?n="deno":n="other",n};let Kn;async function eu(){return Kn===void 0&&(Kn={library:"langchain-js",runtime:Yc()}),Kn}function q(n){try{return typeof process<"u"?Jn==null?void 0:Jn[n]:void 0}catch{return}}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var tu=typeof window=="object"?window:{},S="0123456789abcdef".split(""),ru=[-2147483648,8388608,32768,128],me=[24,16,8,0],Z=[];function be(n){n?(Z[0]=Z[16]=Z[1]=Z[2]=Z[3]=Z[4]=Z[5]=Z[6]=Z[7]=Z[8]=Z[9]=Z[10]=Z[11]=Z[12]=Z[13]=Z[14]=Z[15]=0,this.blocks=Z):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}be.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===tu.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,s,i=n.length||0,a=this.blocks;r<i;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),e)for(s=this.start;r<i&&s<64;++r)a[s>>2]|=n[r]<<me[s++&3];else for(s=this.start;r<i&&s<64;++r)t=n.charCodeAt(r),t<128?a[s>>2]|=t<<me[s++&3]:t<2048?(a[s>>2]|=(192|t>>6)<<me[s++&3],a[s>>2]|=(128|t&63)<<me[s++&3]):t<55296||t>=57344?(a[s>>2]|=(224|t>>12)<<me[s++&3],a[s>>2]|=(128|t>>6&63)<<me[s++&3],a[s>>2]|=(128|t&63)<<me[s++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),a[s>>2]|=(240|t>>18)<<me[s++&3],a[s>>2]|=(128|t>>12&63)<<me[s++&3],a[s>>2]|=(128|t>>6&63)<<me[s++&3],a[s>>2]|=(128|t&63)<<me[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=a[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};be.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=ru[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};be.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4,i,a,o,c=this.blocks;for(a=16;a<80;++a)o=c[a-3]^c[a-8]^c[a-14]^c[a-16],c[a]=o<<1|o>>>31;for(a=0;a<20;a+=5)i=e&t|~e&r,o=n<<5|n>>>27,s=o+i+s+1518500249+c[a]<<0,e=e<<30|e>>>2,i=n&e|~n&t,o=s<<5|s>>>27,r=o+i+r+1518500249+c[a+1]<<0,n=n<<30|n>>>2,i=s&n|~s&e,o=r<<5|r>>>27,t=o+i+t+1518500249+c[a+2]<<0,s=s<<30|s>>>2,i=r&s|~r&n,o=t<<5|t>>>27,e=o+i+e+1518500249+c[a+3]<<0,r=r<<30|r>>>2,i=t&r|~t&s,o=e<<5|e>>>27,n=o+i+n+1518500249+c[a+4]<<0,t=t<<30|t>>>2;for(;a<40;a+=5)i=e^t^r,o=n<<5|n>>>27,s=o+i+s+1859775393+c[a]<<0,e=e<<30|e>>>2,i=n^e^t,o=s<<5|s>>>27,r=o+i+r+1859775393+c[a+1]<<0,n=n<<30|n>>>2,i=s^n^e,o=r<<5|r>>>27,t=o+i+t+1859775393+c[a+2]<<0,s=s<<30|s>>>2,i=r^s^n,o=t<<5|t>>>27,e=o+i+e+1859775393+c[a+3]<<0,r=r<<30|r>>>2,i=t^r^s,o=e<<5|e>>>27,n=o+i+n+1859775393+c[a+4]<<0,t=t<<30|t>>>2;for(;a<60;a+=5)i=e&t|e&r|t&r,o=n<<5|n>>>27,s=o+i+s-1894007588+c[a]<<0,e=e<<30|e>>>2,i=n&e|n&t|e&t,o=s<<5|s>>>27,r=o+i+r-1894007588+c[a+1]<<0,n=n<<30|n>>>2,i=s&n|s&e|n&e,o=r<<5|r>>>27,t=o+i+t-1894007588+c[a+2]<<0,s=s<<30|s>>>2,i=r&s|r&n|s&n,o=t<<5|t>>>27,e=o+i+e-1894007588+c[a+3]<<0,r=r<<30|r>>>2,i=t&r|t&s|r&s,o=e<<5|e>>>27,n=o+i+n-1894007588+c[a+4]<<0,t=t<<30|t>>>2;for(;a<80;a+=5)i=e^t^r,o=n<<5|n>>>27,s=o+i+s-899497514+c[a]<<0,e=e<<30|e>>>2,i=n^e^t,o=s<<5|s>>>27,r=o+i+r-899497514+c[a+1]<<0,n=n<<30|n>>>2,i=s^n^e,o=r<<5|r>>>27,t=o+i+t-899497514+c[a+2]<<0,s=s<<30|s>>>2,i=r^s^n,o=t<<5|t>>>27,e=o+i+e-899497514+c[a+3]<<0,r=r<<30|r>>>2,i=t^r^s,o=e<<5|e>>>27,n=o+i+n-899497514+c[a+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0};be.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return S[n>>28&15]+S[n>>24&15]+S[n>>20&15]+S[n>>16&15]+S[n>>12&15]+S[n>>8&15]+S[n>>4&15]+S[n&15]+S[e>>28&15]+S[e>>24&15]+S[e>>20&15]+S[e>>16&15]+S[e>>12&15]+S[e>>8&15]+S[e>>4&15]+S[e&15]+S[t>>28&15]+S[t>>24&15]+S[t>>20&15]+S[t>>16&15]+S[t>>12&15]+S[t>>8&15]+S[t>>4&15]+S[t&15]+S[r>>28&15]+S[r>>24&15]+S[r>>20&15]+S[r>>16&15]+S[r>>12&15]+S[r>>8&15]+S[r>>4&15]+S[r&15]+S[s>>28&15]+S[s>>24&15]+S[s>>20&15]+S[s>>16&15]+S[s>>12&15]+S[s>>8&15]+S[s>>4&15]+S[s&15]};be.prototype.toString=be.prototype.hex;be.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,s>>24&255,s>>16&255,s>>8&255,s&255]};be.prototype.array=be.prototype.digest;be.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const nu=n=>new be(!0).update(n).hex(),Gi=(...n)=>nu(n.join("_"));class su{}const iu=new Map;class gi extends su{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Gi(e,t))??null)}async update(e,t,r){this.cache.set(Gi(e,t),r)}static global(){return new gi(iu)}}class uo extends We{}class lo extends uo{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new cn(this.value)]}}class au extends uo{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return oo(this.messages)}toChatMessages(){return this.messages}}var In={exports:{}},ho={};function de(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var ou=de;de.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};de.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};de.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};de.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};de.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};de.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};de.prototype.start=de.prototype.try;de.prototype.errors=function(){return this._errors};de.prototype.attempts=function(){return this._attempts};de.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var s=this._errors[r],i=s.message,a=(n[i]||0)+1;n[i]=a,a>=t&&(e=s,t=a)}return e};(function(n){var e=ou;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)r[s]=t[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<r.retries;a++)i.push(this.createTimeout(a,r));return t&&t.forever&&!i.length&&i.push(this.createTimeout(a,r)),i.sort(function(o,c){return o-c}),i},n.createTimeout=function(t,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(t,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var o=s[a],c=t[o];t[o]=(function(l){var h=n.operation(r),d=Array.prototype.slice.call(arguments,1),f=d.pop();d.push(function(p){h.retry(p)||(p&&(arguments[0]=h.mainError()),f.apply(this,arguments))}),h.attempt(function(){l.apply(t,d)})}).bind(t,c),t[o].options=r}}})(ho);var cu=ho;const uu=cu,lu=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class fo extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const hu=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},du=n=>lu.includes(n),po=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const s=uu.operation(e);s.attempt(async i=>{try{t(await n(i))}catch(a){if(!(a instanceof Error)){r(new TypeError(`Non-error was thrown: "${a}". You should only throw errors.`));return}if(a instanceof fo)s.stop(),r(a.originalError);else if(a instanceof TypeError&&!du(a.message))s.stop(),r(a);else{hu(a,i,e);try{await e.onFailedAttempt(a)}catch(o){r(o);return}s.retry(a)||r(s.mainError())}}})});In.exports=po;In.exports.default=po;In.exports.AbortError=fo;var fu=In.exports;const ln=pi(fu);var mo={},go={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function s(c,u,l){this.fn=c,this.context=u,this.once=l||!1}function i(c,u,l,h,d){if(typeof l!="function")throw new TypeError("The listener must be a function");var f=new s(l,h||c,d),p=t?t+u:u;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],f]:c._events[p].push(f):(c._events[p]=f,c._eventsCount++),c}function a(c,u){--c._eventsCount===0?c._events=new r:delete c._events[u]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var u=[],l,h;if(this._eventsCount===0)return u;for(h in l=this._events)e.call(l,h)&&u.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(l)):u},o.prototype.listeners=function(u){var l=t?t+u:u,h=this._events[l];if(!h)return[];if(h.fn)return[h.fn];for(var d=0,f=h.length,p=new Array(f);d<f;d++)p[d]=h[d].fn;return p},o.prototype.listenerCount=function(u){var l=t?t+u:u,h=this._events[l];return h?h.fn?1:h.length:0},o.prototype.emit=function(u,l,h,d,f,p){var g=t?t+u:u;if(!this._events[g])return!1;var m=this._events[g],b=arguments.length,A,k;if(m.fn){switch(m.once&&this.removeListener(u,m.fn,void 0,!0),b){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,l),!0;case 3:return m.fn.call(m.context,l,h),!0;case 4:return m.fn.call(m.context,l,h,d),!0;case 5:return m.fn.call(m.context,l,h,d,f),!0;case 6:return m.fn.call(m.context,l,h,d,f,p),!0}for(k=1,A=new Array(b-1);k<b;k++)A[k-1]=arguments[k];m.fn.apply(m.context,A)}else{var x=m.length,O;for(k=0;k<x;k++)switch(m[k].once&&this.removeListener(u,m[k].fn,void 0,!0),b){case 1:m[k].fn.call(m[k].context);break;case 2:m[k].fn.call(m[k].context,l);break;case 3:m[k].fn.call(m[k].context,l,h);break;case 4:m[k].fn.call(m[k].context,l,h,d);break;default:if(!A)for(O=1,A=new Array(b-1);O<b;O++)A[O-1]=arguments[O];m[k].fn.apply(m[k].context,A)}}return!0},o.prototype.on=function(u,l,h){return i(this,u,l,h,!1)},o.prototype.once=function(u,l,h){return i(this,u,l,h,!0)},o.prototype.removeListener=function(u,l,h,d){var f=t?t+u:u;if(!this._events[f])return this;if(!l)return a(this,f),this;var p=this._events[f];if(p.fn)p.fn===l&&(!d||p.once)&&(!h||p.context===h)&&a(this,f);else{for(var g=0,m=[],b=p.length;g<b;g++)(p[g].fn!==l||d&&!p[g].once||h&&p[g].context!==h)&&m.push(p[g]);m.length?this._events[f]=m.length===1?m[0]:m:a(this,f)}return this},o.prototype.removeAllListeners=function(u){var l;return u?(l=t?t+u:u,this._events[l]&&a(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(go);var pu=go.exports,Rn={exports:{}},mu=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const gu=mu;class yo extends Error{constructor(e){super(e),this.name="TimeoutError"}}const _o=(n,e,t)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const i=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(c){s(c)}return}const a=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new yo(a);typeof n.cancel=="function"&&n.cancel(),s(o)},e);gu(n.then(r,s),()=>{clearTimeout(i)})});Rn.exports=_o;Rn.exports.default=_o;Rn.exports.TimeoutError=yo;var yu=Rn.exports,yi={},_i={};Object.defineProperty(_i,"__esModule",{value:!0});function _u(n,e,t){let r=0,s=n.length;for(;s>0;){const i=s/2|0;let a=r+i;t(n[a],e)<=0?(r=++a,s-=i+1):s=i}return r}_i.default=_u;Object.defineProperty(yi,"__esModule",{value:!0});const bu=_i;class wu{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const s=bu.default(this._queue,r,(i,a)=>a.priority-i.priority);this._queue.splice(s,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}yi.default=wu;Object.defineProperty(mo,"__esModule",{value:!0});const vu=pu,bo=yu,Au=yi,Er=()=>{},ku=new bo.TimeoutError;class Eu extends vu{constructor(e){var t,r,s,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Er,this._resolveIdle=Er,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Au.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(i=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Er,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Er,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,s)=>{const i=async()=>{this._pendingCount++,this._intervalCount++;try{const a=this._timeout===void 0&&t.timeout===void 0?e():bo.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&s(ku)});r(await a)}catch(a){s(a)}this._next()};this._queue.enqueue(i,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var je=mo.default=Eu;const Ou=[400,401,402,403,404,405,406,407,408,409],xu=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("TimeoutError")||n.name==="TimeoutError"||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&Ou.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}};let jn=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??xu;const t="default"in je?je.default:je;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>ln(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var $n={};$n.byteLength=Su;$n.toByteArray=Iu;$n.fromByteArray=$u;var Ae=[],he=[],Pu=typeof Uint8Array<"u"?Uint8Array:Array,Gn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var ft=0,Tu=Gn.length;ft<Tu;++ft)Ae[ft]=Gn[ft],he[Gn.charCodeAt(ft)]=ft;he[45]=62;he[95]=63;function wo(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function Su(n){var e=wo(n),t=e[0],r=e[1];return(t+r)*3/4-r}function Cu(n,e,t){return(e+t)*3/4-t}function Iu(n){var e,t=wo(n),r=t[0],s=t[1],i=new Pu(Cu(n,r,s)),a=0,o=s>0?r-4:r,c;for(c=0;c<o;c+=4)e=he[n.charCodeAt(c)]<<18|he[n.charCodeAt(c+1)]<<12|he[n.charCodeAt(c+2)]<<6|he[n.charCodeAt(c+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=he[n.charCodeAt(c)]<<2|he[n.charCodeAt(c+1)]>>4,i[a++]=e&255),s===1&&(e=he[n.charCodeAt(c)]<<10|he[n.charCodeAt(c+1)]<<4|he[n.charCodeAt(c+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function Ru(n){return Ae[n>>18&63]+Ae[n>>12&63]+Ae[n>>6&63]+Ae[n&63]}function ju(n,e,t){for(var r,s=[],i=e;i<t;i+=3)r=(n[i]<<16&16711680)+(n[i+1]<<8&65280)+(n[i+2]&255),s.push(Ru(r));return s.join("")}function $u(n){for(var e,t=n.length,r=t%3,s=[],i=16383,a=0,o=t-r;a<o;a+=i)s.push(ju(n,a,a+i>o?o:a+i));return r===1?(e=n[t-1],s.push(Ae[e>>2]+Ae[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],s.push(Ae[e>>10]+Ae[e>>4&63]+Ae[e<<2&63]+"=")),s.join("")}var Nu=Object.defineProperty,Lu=(n,e,t)=>e in n?Nu(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Uu=(n,e,t)=>(Lu(n,typeof e!="symbol"?e+"":e,t),t);function Du(n,e){let t=Array.from({length:n.length},(r,s)=>({start:s,end:s+1}));for(;t.length>1;){let r=null;for(let s=0;s<t.length-1;s++){const i=n.slice(t[s].start,t[s+1].end),a=e.get(i.join(","));a!=null&&(r==null||a<r[0])&&(r=[a,s])}if(r!=null){const s=r[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function Mu(n,e){return n.length===1?[e.get(n.join(","))]:Du(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function Bu(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var As=class{constructor(n,e){Me(this,"specialTokens");Me(this,"inverseSpecialTokens");Me(this,"patStr");Me(this,"textEncoder",new TextEncoder);Me(this,"textDecoder",new TextDecoder("utf-8"));Me(this,"rankMap",new Map);Me(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[i,a,...o]=s.split(" "),c=Number.parseInt(a,10);return o.forEach((u,l)=>r[u]=c+l),r},{});for(const[r,s]of Object.entries(t)){const i=$n.toByteArray(r);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,i])=>(r[i]=this.textEncoder.encode(s),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),s=As.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(u=>!a.has(u)):t);if(o.size>0){const u=As.specialTokenRegex([...o]),l=n.match(u);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let c=0;for(;;){let u=null,l=c;for(;s.lastIndex=l,u=s.exec(n),!(u==null||a.has(u[0]));)l=u.index+1;const h=(u==null?void 0:u.index)??n.length;for(const f of n.substring(c,h).matchAll(r)){const p=this.textEncoder.encode(f[0]),g=this.rankMap.get(p.join(","));if(g!=null){i.push(g);continue}i.push(...Mu(p,this.rankMap))}if(u==null)break;let d=this.specialTokens[u[0]];i.push(d),c=u.index+u[0].length}return i}decode(n){const e=[];let t=0;for(let i=0;i<n.length;++i){const a=n[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let s=0;for(const i of e)r.set(i,s),s+=i.length;return this.textDecoder.decode(r)}},vo=As;Uu(vo,"specialTokenRegex",n=>new RegExp(n.map(e=>Bu(e)).join("|"),"g"));function Fu(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}const Or={},zu=new jn({});async function qu(n){return n in Or||(Or[n]=zu.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new vo(e)).catch(e=>{throw delete Or[n],e})),await Or[n]}async function Vu(n){return qu(Fu(n))}let xr;const Hu=new Uint8Array(16);function Zu(){if(!xr&&(xr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!xr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return xr(Hu)}const Ju=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Ku(n){return typeof n=="string"&&Ju.test(n)}const G=[];for(let n=0;n<256;++n)G.push((n+256).toString(16).slice(1));function Gu(n,e=0){return G[n[e+0]]+G[n[e+1]]+G[n[e+2]]+G[n[e+3]]+"-"+G[n[e+4]]+G[n[e+5]]+"-"+G[n[e+6]]+G[n[e+7]]+"-"+G[n[e+8]]+G[n[e+9]]+"-"+G[n[e+10]]+G[n[e+11]]+G[n[e+12]]+G[n[e+13]]+G[n[e+14]]+G[n[e+15]]}const Wu=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Wi={randomUUID:Wu};function ve(n,e,t){if(Wi.randomUUID&&!e&&!n)return Wi.randomUUID();n=n||{};const r=n.random||(n.rng||Zu)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=r[s];return e}return Gu(r)}var Wn={};class Qu{}class br extends Qu{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,io(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:typeof process<"u"?(Wn==null?void 0:Wn.LANGCHAIN_CALLBACKS_BACKGROUND)!=="true":!0}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever)}copy(){return new this.constructor(this)}toJSON(){return We.prototype.toJSON.call(this)}toJSONNotImplemented(){return We.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends br{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ve()}),Object.assign(this,e)}}return new t}}var bi={exports:{}};bi.exports;(function(n){const t=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,r=(i=0)=>(a,o,c)=>`\x1B[${38+i};2;${a};${o};${c}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,c]of Object.entries(a)){for(const[u,l]of Object.entries(c))a[u]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},c[u]=a[u],i.set(l[0],l[1]);Object.defineProperty(a,o,{value:c,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=t(),a.color.ansi16m=r(),a.bgColor.ansi256=t(10),a.bgColor.ansi16m=r(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,c,u)=>o===c&&c===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:u}=c.groups;u.length===3&&(u=u.split("").map(h=>h+h).join(""));const l=Number.parseInt(u,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(n,"exports",{enumerable:!0,get:s})})(bi);var Xu=bi.exports;const Ao=pi(Xu);function Qn(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function Yu(n){return n.replace(/[-:.]/g,"")}function el(n,e){return Yu(`${new Date(n).toISOString().slice(0,-1)}000Z`)+e}class Nn extends br{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var s;const t=el(e.start_time,e.id),r={...e};if(r.parent_run_id!==void 0){const i=this.runMap.get(r.parent_run_id);i&&(this._addChildRun(i,r),i.child_execution_order=Math.max(i.child_execution_order,r.child_execution_order),r.trace_id=i.trace_id,i.dotted_order!==void 0&&(r.dotted_order=[i.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((s=this.onRunCreate)==null?void 0:s.call(this,r))}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,s,i,a,o,c){var f;const u=this._getExecutionOrder(s),l=Date.now(),h=o?{...i,metadata:o}:i,d={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:h??{},tags:a||[]};return await this._startTrace(d),await((f=this.onLLMStart)==null?void 0:f.call(this,d)),d}async handleChatModelStart(e,t,r,s,i,a,o,c){var f;const u=this._getExecutionOrder(s),l=Date.now(),h=o?{...i,metadata:o}:i,d={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:u,child_runs:[],child_execution_order:u,run_type:"llm",extra:h??{},tags:a||[]};return await this._startTrace(d),await((f=this.onLLMStart)==null?void 0:f.call(this,d)),d}async handleLLMEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,s,i,a,o,c){var d;const u=this._getExecutionOrder(s),l=Date.now(),h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:u,child_execution_order:u,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(h),await((d=this.onChainStart)==null?void 0:d.call(this,h)),h}async handleChainEnd(e,t,r,s,i){var o;const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=Qn(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=Qn(i.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleChainError(e,t,r,s,i){var o;const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=Qn(i.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleToolStart(e,t,r,s,i,a,o){var h;const c=this._getExecutionOrder(s),u=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{input:t},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(l),await((h=this.onToolStart)==null?void 0:h.call(this,l)),l}async handleToolEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentAction)==null?void 0:i.call(this,r))}async handleAgentEnd(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}async handleRetrieverStart(e,t,r,s,i,a,o){var h;const c=this._getExecutionOrder(s),u=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{query:t},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(l),await((h=this.onRetrieverStart)==null?void 0:h.call(this,l)),l}async handleRetrieverEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,t,r,s,i,a){var c;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:a==null?void 0:a.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:a==null?void 0:a.chunk})),o}}function re(n,e){return`${n.open}${e}${n.close}`}function ge(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function Fe(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:ie}=Ao;class Qi extends Nn{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)t.push(s),r=s;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?re(Ao.bold,o):o}).join(" > ");return re(ie.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.green,"[chain/start]")} [${t}] Entering Chain run with input: ${ge(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.cyan,"[chain/end]")} [${t}] [${Fe(e)}] Exiting Chain run with output: ${ge(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.red,"[chain/error]")} [${t}] [${Fe(e)}] Chain run errored with error: ${ge(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${re(ie.green,"[llm/start]")} [${t}] Entering LLM run with input: ${ge(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.cyan,"[llm/end]")} [${t}] [${Fe(e)}] Exiting LLM run with output: ${ge(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.red,"[llm/error]")} [${t}] [${Fe(e)}] LLM run errored with error: ${ge(e.error,"[error]")}`)}onToolStart(e){var r;const t=this.getBreadcrumbs(e);console.log(`${re(ie.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,s;const t=this.getBreadcrumbs(e);console.log(`${re(ie.cyan,"[tool/end]")} [${t}] [${Fe(e)}] Exiting Tool run with output: "${(s=(r=e.outputs)==null?void 0:r.output)==null?void 0:s.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.red,"[tool/error]")} [${t}] [${Fe(e)}] Tool run errored with error: ${ge(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${ge(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.cyan,"[retriever/end]")} [${t}] [${Fe(e)}] Exiting Retriever run with output: ${ge(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${re(ie.red,"[retriever/error]")} [${t}] [${Fe(e)}] Retriever run errored with error: ${ge(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${re(ie.blue,"[agent/action]")} [${r}] Agent selected action: ${ge(t.actions[t.actions.length-1],"[action]")}`)}}const tl=[400,401,403,404,405,406,407,408],rl=[409];class Xi{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const t="default"in je?je.default:je;this.queue=new t({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>ln(()=>e(...t).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const i=s==null?void 0:s.response,a=i==null?void 0:i.status;if(a){if(tl.includes(+a))throw s;if(rl.includes(+a))return;r&&await r(i)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}function Yi(n){return typeof(n==null?void 0:n._getType)=="function"}function ea(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var Yt={};let Te;const nl=()=>typeof window<"u"&&typeof window.document<"u",sl=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",il=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),ko=()=>typeof Deno<"u",al=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!ko(),ol=()=>Te||(nl()?Te="browser":al()?Te="node":sl()?Te="webworker":il()?Te="jsdom":ko()?Te="deno":Te="other",Te);let Xn;async function cl(){if(Xn===void 0){const n=ol(),e=hl();Xn={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Eo,...e}}return Xn}function ul(){const n=ll()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,s]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof s=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function ll(){try{return typeof process<"u"&&Yt?Object.entries(Yt).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function rt(n){try{return typeof process<"u"?Yt==null?void 0:Yt[n]:void 0}catch{return}}let Yn;function hl(){if(Yn!==void 0)return Yn;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=rt(t);r!==void 0&&(e[t]=r)}return Yn=e,e}async function ta(n){const e=await cl(),t=ul();return n.map(r=>{const s=r.extra??{},i=s.metadata;return r.extra={...s,runtime:{...e,...s==null?void 0:s.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...i}},r})}const dl=()=>{const n=rt("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;const e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},fl=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},ze=async(n,e)=>{const t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function pl(n){const e=[];for await(const t of n)e.push(t);return e}function es(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function B(n){if(!Ku(n))throw new Error(`Invalid UUID: ${n}`)}const ml=async n=>{if((n==null?void 0:n.status)===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};class gl{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}}const yl=20971520;class wi{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new gl}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=wi.getDefaultClientConfig();this.tracingSampleRate=dl(),this.apiUrl=es(e.apiUrl??t.apiUrl)??"",this.apiKey=es(e.apiKey??t.apiKey),this.webUrl=es(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Xi(e.callerOptions??{}),this.batchIngestCaller=new Xi({...e.callerOptions??{},onFailedResponseHook:ml}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit}static getDefaultClientConfig(){const e=rt("LANGCHAIN_API_KEY"),t=rt("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=rt("LANGCHAIN_HIDE_INPUTS")==="true",s=rt("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:fl(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={"User-Agent":`langsmith-js/${Eo}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs?{}:e}processOutputs(e){return this.hideOutputs?{}:e}prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",s=`${this.apiUrl}${e}?${r}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);return i}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));const i=`${this.apiUrl}${e}?${t}`,a=await this.caller.call(fetch,i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!a.ok)throw new Error(`Failed to fetch ${e}: ${a.status} ${a.statusText}`);const o=await a.json();if(o.length===0||(yield o,o.length<s))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",s="runs"){const i=t?{...t}:{};for(;;){const o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(i)})).json();if(!o||!o[s])break;yield o[s];const c=o.cursors;if(!c||!c.next)break;i.cursor=c.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const s of e)this.sampledPostUuids.has(s.id)&&(r.push(s),this.sampledPostUuids.delete(s.id));return r}else{const r=[];for(const s of e)Math.random()<this.tracingSampleRate&&(r.push(s),this.sampledPostUuids.add(s.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){const r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const s=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),s}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms)});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const s=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){this.processRunOperation({action:"create",item:s}).catch(console.error);return}const i=await ta([s]),a=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(i[0]),signal:AbortSignal.timeout(this.timeout_ms)});await ze(a,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){var u,l;if(e===void 0&&t===void 0)return;let r=(e==null?void 0:e.map(h=>this.prepareRunCreateOrUpdateInputs(h)))??[],s=(t==null?void 0:t.map(h=>this.prepareRunCreateOrUpdateInputs(h)))??[];if(r.length>0&&s.length>0){const h=r.reduce((f,p)=>(p.id&&(f[p.id]=p),f),{}),d=[];for(const f of s)f.id!==void 0&&h[f.id]?h[f.id]={...h[f.id],...f}:d.push(f);r=Object.values(h),s=d}const i={post:this._filterForSampling(r),patch:this._filterForSampling(s,!0)};if(!i.post.length&&!i.patch.length)return;if(r=await ta(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const h of i.post)await this.createRun(h);for(const h of i.patch)h.id!==void 0&&await this.updateRun(h.id,h);return}const a=((l=(u=this.serverInfo)==null?void 0:u.batch_ingest_config)==null?void 0:l.size_limit_bytes)??yl,o={post:[],patch:[]};let c=0;for(const h of["post","patch"]){const d=h,f=i[d].reverse();let p=f.pop();for(;p!==void 0;){const g=JSON.stringify(p);c>0&&c+g.length>a&&(await this._postBatchIngestRuns(JSON.stringify(o)),c=0,o.post=[],o.patch=[]),c+=g.length,o[d].push(p),p=f.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms)});await ze(r,"batch create run")}async updateRun(e,t){B(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const s={...this.headers,"Content-Type":"application/json"},i=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await ze(i,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){B(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let s;t.session_id?s=t.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:rt("LANGCHAIN_PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await pl(this.listRuns({id:e.child_run_ids})),r={},s={};t.sort((i,a)=>((i==null?void 0:i.dotted_order)??"").localeCompare((a==null?void 0:a.dotted_order)??""));for(const i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),s[i.id]=i}e.child_runs=r[e.id]||[];for(const i in r)i!==e.id&&(s[i].child_runs=r[i]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:c,runType:u,error:l,id:h,query:d,filter:f,traceFilter:p,limit:g}=e;let m=[];if(t&&(m=Array.isArray(t)?t:[t]),r){const A=Array.isArray(r)?r:[r],k=await Promise.all(A.map(x=>this.readProject({projectName:x}).then(O=>O.id)));m.push(...k)}const b={session:m.length?m:null,run_type:u,reference_example:a,query:d,filter:f,trace_filter:p,execution_order:c,parent_run:s?[s]:null,start_time:o?o.toISOString():null,error:l,id:h,limit:g,trace:i};for await(const A of this._getCursorPaginatedList("/runs/query",b))yield*A}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||ve()};B(e);const i=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();if(i===null||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){B(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await ze(t,"unshare run")}async readRunSharedLink(e){B(e);const r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const a of t)r.append("id",a);return B(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),B(e);const s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};B(e);const i=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){B(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await ze(t,"unshare dataset")}async readSharedDataset(e){return B(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,u=i||{};r&&(u.metadata=r);const l={name:e,extra:u,description:t};a!==null&&(l.reference_dataset_id=a);const h=await this.caller.call(fetch,c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),d=await h.json();if(!h.ok)throw new Error(`Failed to create session ${e}: ${h.status} ${h.statusText}`);return d}async updateProject(e,{name:t=null,description:r=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=i;s&&(c={...c||{},metadata:s});const u={name:t,extra:c,description:r,end_time:a?new Date(a).toISOString():null},l=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms)}),h=await l.json();if(!l.ok)throw new Error(`Failed to update project ${e}: ${l.status} ${l.statusText}`);return h}async hasProject({projectId:e,projectName:t}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)B(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(fetch,`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});try{const a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let s="/sessions";const i=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)B(e),s+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&i.append("include_stats",r.toString());const a=await this._get(s,i);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=a[0]}else o=a;return o}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:s,referenceDatasetName:i,referenceFree:a}={}){const o=new URLSearchParams;if(e!==void 0)for(const c of e)o.append("id",c);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),s!==void 0)o.append("reference_dataset",s);else if(i!==void 0){const c=await this.readDataset({datasetName:i});o.append("reference_dataset",c.id)}a!==void 0&&o.append("reference_free",a.toString());for await(const c of this._getPaginated("/sessions",o))yield*c}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,B(r);const s=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await ze(s,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:s,description:i,dataType:a,name:o}){const c=`${this.apiUrl}/datasets/upload`,u=new FormData;u.append("file",e,t),r.forEach(d=>{u.append("input_keys",d)}),s.forEach(d=>{u.append("output_keys",d)}),i&&u.append("description",i),a&&u.append("data_type",a),o&&u.append("name",o);const l=await this.caller.call(fetch,c,{method:"POST",headers:this.headers,body:u,signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok){const d=await l.json();throw d.detail&&d.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${l.status} ${l.statusText}`)}return await l.json()}async createDataset(e,{description:t,dataType:r}={}){const s={name:e,description:t};r&&(s.data_type=r);const i=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok){const o=await i.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${i.status} ${i.statusText}`)}return await i.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)B(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(r,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=i[0]}else a=i;return a}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:s,datasetNameContains:i}={}){const a="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const c of r)o.append("id",c);s!==void 0&&o.append("name",s),i!==void 0&&o.append("name_contains",i);for await(const c of this._getPaginated(a,o))yield*c}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)B(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");const i=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to delete ${r}: ${i.status} ${i.statusText}`);await i.json()}async createExample(e,t,{datasetId:r,datasetName:s,createdAt:i,exampleId:a}){let o=r;if(o===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:s})).id);const c=i||new Date,u={dataset_id:o,inputs:e,outputs:t,created_at:c==null?void 0:c.toISOString(),id:a},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createExamples(e){const{inputs:t,outputs:r,sourceRunIds:s,exampleIds:i,datasetId:a,datasetName:o}=e;let c=a;if(c===void 0&&o===void 0)throw new Error("Must provide either datasetName or datasetId");if(c!==void 0&&o!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");c===void 0&&(c=(await this.readDataset({datasetName:o})).id);const u=t.map((d,f)=>({dataset_id:c,inputs:d,outputs:r?r[f]:void 0,id:i?i[f]:void 0,source_run_id:s?s[f]:void 0})),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const s=e.map(a=>Yi(a)?ea(a):a),i=Yi(t)?ea(t):t;return this.createExample({input:s},{output:i},r)}async readExample(e){B(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r}={}){let s;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)s=e;else if(t!==void 0)s=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const i=new URLSearchParams({dataset:s});if(r!==void 0)for(const a of r)i.append("id",a);for await(const a of this._getPaginated("/examples",i))yield*a}async deleteExample(e){B(e);const t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){B(e);const r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:s,referenceExample:i}={loadChildRuns:!1}){let a;if(typeof e=="string")a=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)a=e;else throw new Error(`Invalid run type: ${typeof e}`);a.reference_example_id!==null&&a.reference_example_id!==void 0&&(i=await this.readExample(a.reference_example_id));const o=await t.evaluateRun(a,i);let c=r??{};o.evaluatorInfo&&(c={...c,...o.evaluatorInfo});const u=o.targetRunId??a.id;return await this.createFeedback(u,o.key,{score:o==null?void 0:o.score,value:o==null?void 0:o.value,comment:o==null?void 0:o.comment,correction:o==null?void 0:o.correction,sourceInfo:c,feedbackSourceType:"model",sourceRunId:o==null?void 0:o.sourceRunId})}async createFeedback(e,t,{score:r,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:u,feedbackId:l,eager:h=!1}){var m;const d={type:c??"api",metadata:o??{}};u!==void 0&&(d==null?void 0:d.metadata)!==void 0&&!d.metadata.__run&&(d.metadata.__run={run_id:u}),(d==null?void 0:d.metadata)!==void 0&&((m=d.metadata.__run)==null?void 0:m.run_id)!==void 0&&B(d.metadata.__run.run_id);const f={id:l??ve(),run_id:e,key:t,score:r,value:s,correction:i,comment:a,feedback_source:d},p=`${this.apiUrl}/feedback`+(h?"/eager":""),g=await this.caller.call(fetch,p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms)});return await ze(g,"create feedback"),f}async updateFeedback(e,{score:t,value:r,correction:s,comment:i}){const a={};t!=null&&(a.score=t),r!=null&&(a.value=r),s!=null&&(a.correction=s),i!=null&&(a.comment=i),B(e);const o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});await ze(o,"update feedback")}async readFeedback(e){B(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){B(e);const t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e&&s.append("run",e.join(",")),t)for(const i of t)s.append("key",i);if(r)for(const i of r)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}}const Eo="0.1.8";class _l extends Nn{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:s}=e;this.projectName=r??q("LANGCHAIN_PROJECT")??q("LANGCHAIN_SESSION"),this.exampleId=t,this.client=s??new wi({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await eu()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}async function bl(){return new _l}let ts;function wl(){const n="default"in je?je.default:je;return new n({autoStart:!0,concurrency:1})}async function Q(n,e){e===!0?await n():(typeof ts>"u"&&(ts=wl()),ts.add(n))}function vl(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}class Al{setHandler(e){return this.setHandlers([e])}}class Ln{constructor(e,t,r,s,i,a,o,c){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:c})}async handleText(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleText: ${s}`)}},t.awaitHandlers)))}}class kl extends Ln{getChild(e){const t=new ne(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch{console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${s}`)}},t.awaitHandlers)))}}class ra extends Ln{async handleLLMNewToken(e,t,r,s,i,a){await Promise.all(this.handlers.map(o=>Q(async()=>{var c;if(!o.ignoreLLM)try{await((c=o.handleLLMNewToken)==null?void 0:c.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(u){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${s}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${s}`)}},t.awaitHandlers)))}}class El extends Ln{getChild(e){const t=new ne(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,s,i){await Promise.all(this.handlers.map(a=>Q(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainError)==null?void 0:o.call(a,e,this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${a.constructor.name}, handleChainError: ${c}`)}},a.awaitHandlers)))}async handleChainEnd(e,t,r,s,i){await Promise.all(this.handlers.map(a=>Q(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainEnd)==null?void 0:o.call(a,e,this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${a.constructor.name}, handleChainEnd: ${c}`)}},a.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${s}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${s}`)}},t.awaitHandlers)))}}class Ol extends Ln{getChild(e){const t=new ne(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${s}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Q(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${s}`)}},t.awaitHandlers)))}}class ne extends Al{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0){return Promise.all(t.map(async u=>{const l=ve();return await Promise.all(this.handlers.map(h=>Q(async()=>{var d;if(!h.ignoreLLM)try{await((d=h.handleLLMStart)==null?void 0:d.call(h,e,[u],l,this._parentRunId,i,this.tags,this.metadata,c))}catch(f){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`)}},h.awaitHandlers))),new ra(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0){return Promise.all(t.map(async u=>{const l=ve();return await Promise.all(this.handlers.map(h=>Q(async()=>{var d,f;if(!h.ignoreLLM)try{if(h.handleChatModelStart)await((d=h.handleChatModelStart)==null?void 0:d.call(h,e,[u],l,this._parentRunId,i,this.tags,this.metadata,c));else if(h.handleLLMStart){const p=oo(u);await((f=h.handleLLMStart)==null?void 0:f.call(h,e,[p],l,this._parentRunId,i,this.tags,this.metadata,c))}}catch(p){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`)}},h.awaitHandlers))),new ra(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>Q(async()=>{var u;if(!c.ignoreChain)try{await((u=c.handleChainStart)==null?void 0:u.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(l){console.error(`Error in handler ${c.constructor.name}, handleChainStart: ${l}`)}},c.awaitHandlers))),new El(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>Q(async()=>{var u;if(!c.ignoreAgent)try{await((u=c.handleToolStart)==null?void 0:u.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${c.constructor.name}, handleToolStart: ${l}`)}},c.awaitHandlers))),new Ol(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>Q(async()=>{var u;if(!c.ignoreRetriever)try{await((u=c.handleRetrieverStart)==null?void 0:u.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${l}`)}},c.awaitHandlers))),new kl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new ne(this._parentRunId);for(const s of this.handlers){const i=this.inheritableHandlers.includes(s);r.addHandler(s,i)}for(const s of this.tags){const i=this.inheritableTags.includes(s);r.addTags([s],i)}for(const s of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(s);r.addMetadata({[s]:this.metadata[s]},i)}for(const s of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===s.name)||r.addHandler(s,t);return r}static fromHandlers(e){class t extends br{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ve()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,s,i,a,o){let c;(e||t)&&(Array.isArray(e)||!e?(c=new ne,c.setHandlers((e==null?void 0:e.map(hn))??[],!0)):c=e,c=c.copy(Array.isArray(t)?t.map(hn):t==null?void 0:t.handlers,!1));const u=q("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=q("LANGCHAIN_TRACING_V2")==="true",h=l||(q("LANGCHAIN_TRACING")??!1);if(u||h){if(c||(c=new ne),u&&!c.handlers.some(d=>d.name===Qi.prototype.name)){const d=new Qi;c.addHandler(d,!0)}h&&!c.handlers.some(d=>d.name==="langchain_tracer")&&l&&c.addHandler(await bl(),!0)}return(r||s)&&c&&(c.addTags(r??[]),c.addTags(s??[],!1)),(i||a)&&c&&(c.addMetadata(i??{}),c.addMetadata(a??{},!1)),c}}function hn(n){return"name"in n?n:br.fromMethods(n)}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const xl=Object.prototype.hasOwnProperty;function ks(n,e){return xl.call(n,e)}function Es(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)ks(n,t)&&e.push(t);return e}function ke(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Os(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function pt(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function Pl(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function xs(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(xs(n[t]))return!0}else if(typeof n=="object"){const t=Es(n),r=t.length;for(var e=0;e<r;e++)if(xs(n[t[e]]))return!0}}return!1}function na(n,e){const t=[n];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&t.push(`${r}: ${s}`)}return t.join(`
`)}class Tl extends Error{constructor(e,t,r,s,i){super(na(e,{name:t,index:r,operation:s,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=na(e,{name:t,index:r,operation:s,tree:i})}}const z=Tl,Ot={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Ps(t,this.path);r&&(r=ke(r));const s=er(t,{op:"remove",path:this.from}).removed;return er(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=Ps(t,this.from);return er(t,{op:"add",path:this.path,value:ke(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:fn(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var Sl={add:function(n,e,t){return Os(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Ot.move,copy:Ot.copy,test:Ot.test,_get:Ot._get};function Ps(n,e){if(e=="")return n;var t={op:"_get",path:e};return er(n,t),t.value}function er(n,e,t=!1,r=!0,s=!0,i=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):Ts(e,0)),e.path===""){let a={newDocument:n};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=n,a;if(e.op==="move"||e.op==="copy")return a.newDocument=Ps(n,e.from),e.op==="move"&&(a.removed=n),a;if(e.op==="test"){if(a.test=fn(n,e.value),a.test===!1)throw new z("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return a.newDocument=n,a}else{if(e.op==="remove")return a.removed=n,a.newDocument=null,a;if(e.op==="_get")return e.value=n,a;if(t)throw new z("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,n);return a}}else{r||(n=ke(n));const o=(e.path||"").split("/");let c=n,u=1,l=o.length,h,d,f;for(typeof t=="function"?f=t:f=Ts;;){if(d=o[u],d&&d.indexOf("~")!=-1&&(d=Pl(d)),s&&(d=="__proto__"||d=="prototype"&&u>0&&o[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&h===void 0&&(c[d]===void 0?h=o.slice(0,u).join("/"):u==l-1&&(h=e.path),h!==void 0&&f(e,0,n,h)),u++,Array.isArray(c)){if(d==="-")d=c.length;else{if(t&&!Os(d))throw new z("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,n);Os(d)&&(d=~~d)}if(u>=l){if(t&&e.op==="add"&&d>c.length)throw new z("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,n);const p=Sl[e.op].call(e,c,d,n);if(p.test===!1)throw new z("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return p}}else if(u>=l){const p=Ot[e.op].call(e,c,d,n);if(p.test===!1)throw new z("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return p}if(c=c[d],t&&u<l&&(!c||typeof c!="object"))throw new z("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,n)}}}function dn(n,e,t,r=!0,s=!0){if(t&&!Array.isArray(e))throw new z("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=ke(n));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=er(n,e[a],t,!0,s,a),n=i[a].newDocument;return i.newDocument=n,i}function Ts(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new z("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Ot[n.op]){if(typeof n.path!="string")throw new z("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new z('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new z("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new z("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&xs(n.value))throw new z("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var s=n.path.split("/").length,i=r.split("/").length;if(s!==i+1&&s!==i)throw new z("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new z("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var a={op:"_get",path:n.from,value:void 0},o=Cl([a],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new z("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new z("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Cl(n,e,t){try{if(!Array.isArray(n))throw new z("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)dn(ke(e),ke(n),t||!0);else{t=t||Ts;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(s){if(s instanceof z)return s;throw s}}function fn(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),s,i,a;if(t&&r){if(i=n.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!fn(n[s],e[s]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!fn(n[a],e[a]))return!1;return!0}return n!==n&&e!==e}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function Oo(n,e,t,r,s){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Es(e),a=Es(n),o=!1,c=a.length-1;c>=0;c--){var u=a[c],l=n[u];if(ks(e,u)&&!(e[u]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var h=e[u];typeof l=="object"&&l!=null&&typeof h=="object"&&h!=null&&Array.isArray(l)===Array.isArray(h)?Oo(l,h,t,r+"/"+pt(u),s):l!==h&&(s&&t.push({op:"test",path:r+"/"+pt(u),value:ke(l)}),t.push({op:"replace",path:r+"/"+pt(u),value:ke(h)}))}else Array.isArray(n)===Array.isArray(e)?(s&&t.push({op:"test",path:r+"/"+pt(u),value:ke(l)}),t.push({op:"remove",path:r+"/"+pt(u)}),o=!0):(s&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}))}if(!(!o&&i.length==a.length))for(var c=0;c<i.length;c++){var u=i[c];!ks(n,u)&&e[u]!==void 0&&t.push({op:"add",path:r+"/"+pt(u),value:ke(e[u])})}}}function Il(n,e,t=!1){var r=[];return Oo(n,e,r,"",t),r}class Ne extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new Ne({start(r){return s();function s(){return t.read().then(({done:i,value:a})=>{if(i){r.close();return}return r.enqueue(a),s()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Ne({async pull(t){const{value:r,done:s}=await e.next();s&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function xo(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){const i=await n.next();for(const a of t)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function ot(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,s]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=ot(t[r],s):t[r]=s;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class Bt{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,s)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,s):this.firstResult.then(i=>r(void 0),s)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function Rl(n,e,t,...r){const s=new Bt(e,t),i=await s.setup;return{output:n(s,i,...r),setup:i}}class qe{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=dn({},t);return new dr({ops:t,state:r[r.length-1].newDocument})}}class dr extends qe{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=dn(this.state,e.ops);return new dr({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=dn({},e.ops);return new dr({ops:e.ops,state:t[t.length-1].newDocument})}}async function sa(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function ia(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function jl(n){return n!==void 0&&n.message!==void 0}class aa extends Nn{constructor(e){super(e),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ne.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new qe({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new qe({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await sa(e,this._schemaFormat)),await this.writer.write(new qe({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await sa(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await ia(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const s=new qe({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const t=new qe({ops:[{op:"replace",path:"/final_output",value:await ia(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const i=e.inputs.messages!==void 0;let a;i?jl(r==null?void 0:r.chunk)?a=r==null?void 0:r.chunk:a=new Rt(t):a=t;const o=new qe({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}}class $l{getStore(){}run(e,t){t()}}class Nl{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new $l}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}}const Ss=new Nl,rs=25;async function ct(n){return ne.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function oa(...n){const e=W();for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags")e[r]=[...new Set(e[r].concat(t[r]??[]))];else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){const s=e.callbacks,i=t.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(hn(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(hn(o),!0);e.callbacks=a}else e.callbacks=new ne(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{const s=r;e[s]=t[s]??e[s]}return e}const Ll=new Set(["string","number","boolean"]);function W(n){var r;const e=n??Ss.getInstance().getStore();let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(e&&(t={...t,...e}),e!=null&&e.configurable)for(const s of Object.keys(e.configurable))Ll.has(typeof e.configurable[s])&&!((r=t.metadata)!=null&&r[s])&&(t.metadata||(t.metadata={}),t.metadata[s]=e.configurable[s]);return t}function ae(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:s,configurable:i}={}){const a=W(n);return e!==void 0&&(delete a.runName,a.callbacks=e),r!==void 0&&(a.recursionLimit=r),t!==void 0&&(a.maxConcurrency=t),s!==void 0&&(a.runName=s),i!==void 0&&(a.configurable={...a.configurable,...i}),a}class Po extends Nn{constructor({config:e,onStart:t,onEnd:r,onError:s}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}class Ul{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const s=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||s.some(i=>{var a;return(a=this.includeTags)==null?void 0:a.includes(i)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&s.every(i=>{var a;return!((a=this.excludeTags)!=null&&a.includes(i))})),r}}function te(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class J extends We{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new St({bound:this,kwargs:e,config:{}})}map(){return new pn({bound:this})}withRetry(e){return new Dl({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new St({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Ml({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map(W)}return Array.from({length:t},()=>W(e))}async batch(e,t,r){var c;const s=this._getOptionsList(t??{},e.length),i=((c=s[0])==null?void 0:c.maxConcurrency)??(r==null?void 0:r.maxConcurrency),a=new jn({maxConcurrency:i,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>a.call(async()=>{try{return await this.invoke(u,s[l])}catch(h){if(r!=null&&r.returnExceptions)return h;throw h}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=new Bt(this._streamIterator(e,W(t)));return await r.setup,Ne.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e={}){const t=W({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,[t,r]}async _callWithConfig(e,t,r){const s=W(r),i=await ct(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),te(t,"input"),void 0,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));let o;try{o=await e.call(this,t,s,a)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(te(o,"output"))),o}async _batchWithConfig(e,t,r,s){const i=this._getOptionsList(r??{},t.length),a=await Promise.all(i.map(ct)),o=await Promise.all(a.map((u,l)=>u==null?void 0:u.handleChainStart(this.toJSON(),te(t[l],"input"),void 0,i[l].runType,void 0,void 0,i[l].runName??this.getName())));let c;try{c=await e.call(this,t,i,o,s)}catch(u){throw await Promise.all(o.map(l=>l==null?void 0:l.handleChainError(u))),u}return await Promise.all(o.map(u=>u==null?void 0:u.handleChainEnd(te(c,"output")))),c}async*_transformStreamWithConfig(e,t,r){let s,i=!0,a,o=!0;const c=W(r),u=await ct(c);async function*l(){for await(const d of e){if(i)if(s===void 0)s=d;else try{s=ot(s,d)}catch{s=void 0,i=!1}yield d}}let h;try{const d=await Rl(t.bind(this),l(),async()=>u==null?void 0:u.handleChainStart(this.toJSON(),{input:""},void 0,c==null?void 0:c.runType,void 0,void 0,(c==null?void 0:c.runName)??this.getName()),c);h=d.setup;const f=m=>m.name==="log_stream_tracer",p=h==null?void 0:h.handlers.find(f);let g=d.output;p!==void 0&&h!==void 0&&(g=await p.tapOutputIterable(h.runId,d.output));for await(const m of g)if(yield m,o)if(a===void 0)a=m;else try{a=ot(a,m)}catch{a=void 0,o=!1}}catch(d){throw await(h==null?void 0:h.handleChainError(d,void 0,void 0,void 0,{inputs:te(s,"input")})),d}await(h==null?void 0:h.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:te(s,"input")}))}pipe(e){return new Ie({first:this,last:at(e)})}pick(e){return this.pipe(new Bl(e))}assign(e){return this.pipe(new To(new Ft({steps:e})))}async*transform(e,t){let r;for await(const s of e)r===void 0?r=s:r=ot(r,s);yield*this._streamIterator(r,W(t))}async*streamLog(e,t,r){const s=new aa({...r,autoClose:!1,_schemaFormat:"original"}),i=W(t);yield*this._streamLog(e,s,i)}async*_streamLog(e,t,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[t];else if(Array.isArray(s))r.callbacks=s.concat([t]);else{const c=s.copy();c.inheritableHandlers.push(t),r.callbacks=c}const i=this.stream(e,r);async function a(){try{const c=await i;for await(const u of c){const l=new qe({ops:[{op:"add",path:"/streamed_output/-",value:u}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=a();try{for await(const c of t)yield c}finally{await o}}async*streamEvents(e,t,r){if(t.version!=="v1")throw new Error('Only version "v1" of the events schema is currently supported.');let s,i=!1;const a=W(t),o=a.tags??[],c=a.metadata??{},u=a.runName??this.getName(),l=new aa({...r,autoClose:!1,_schemaFormat:"streaming_events"}),h=new Ul({...r}),d=this._streamLog(e,l,a);for await(const p of d){if(s?s=s.concat(p):s=dr.fromRunLogPatch(p),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const A={...s.state},k={run_id:A.id,event:`on_${A.type}_start`,name:u,tags:o,metadata:c,data:{input:e}};h.includeEvent(k,A.type)&&(yield k)}const g=p.ops.filter(A=>A.path.startsWith("/logs/")).map(A=>A.path.split("/")[2]),m=[...new Set(g)];for(const A of m){let k,x={};const O=s.state.logs[A];if(O.end_time===void 0?O.streamed_output.length>0?k="stream":k="start":k="end",k==="start")O.inputs!==void 0&&(x.input=O.inputs);else if(k==="end")O.inputs!==void 0&&(x.input=O.inputs),x.output=O.final_output;else if(k==="stream"){const H=O.streamed_output.length;if(H!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${H} instead. Encountered in: "${O.name}"`);x={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${k}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:x}}const{state:b}=s;if(b.streamed_output.length>0){const A=b.streamed_output.length;if(A!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${A} instead. Encountered in: "${b.name}"`);const k={chunk:b.streamed_output[0]};b.streamed_output=[];const x={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:c,name:u,data:k};h.includeEvent(x,b.type)&&(yield x)}}const f=s==null?void 0:s.state;if(f!==void 0){const p={event:`on_${f.type}_end`,name:u,run_id:f.id,tags:o,metadata:c,data:{output:f.final_output}};h.includeEvent(p,f.type)&&(yield p)}}static isRunnable(e){return e?e.lc_runnable:!1}withListeners({onStart:e,onEnd:t,onError:r}){return new St({bound:this,config:{},configFactories:[s=>({callbacks:[new Po({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class St extends J{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=oa(this.config,...e);return oa(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(t,this.kwargs))}async batch(e,t,r){const s=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig(i,this.kwargs))):await this._mergeConfig(t,this.kwargs);return this.bound.batch(e,s,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(t,this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(t,this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(t,this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig(t,this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&J.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new St({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new Po({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class pn extends J{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new pn({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,ae(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new pn({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Dl extends St{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const s=e>1?`retry:attempt:${e}`:void 0;return ae(t,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,t,r){return ln(s=>super.invoke(e,this._patchConfigForRetry(s,t,r)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,s){const i={};try{await ln(async a=>{const o=e.map((d,f)=>f).filter(d=>i[d.toString()]===void 0||i[d.toString()]instanceof Error),c=o.map(d=>e[d]),u=o.map(d=>this._patchConfigForRetry(a,t==null?void 0:t[d],r==null?void 0:r[d])),l=await super.batch(c,u,{...s,returnExceptions:!0});let h;for(let d=0;d<l.length;d+=1){const f=l[d],p=o[d];f instanceof Error&&h===void 0&&(h=f),i[p.toString()]=f}if(h)throw h;return l},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if((s==null?void 0:s.returnExceptions)!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Ie extends J{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=W(t),s=await ct(r),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),te(e,"input"),void 0,void 0,void 0,void 0,r==null?void 0:r.runName));let a=e,o;try{const c=[this.first,...this.middle];for(let u=0;u<c.length;u+=1)a=await c[u].invoke(a,ae(r,{callbacks:i==null?void 0:i.getChild(`seq:step:${u+1}`)}));o=await this.last.invoke(a,ae(r,{callbacks:i==null?void 0:i.getChild(`seq:step:${this.steps.length}`)}))}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(te(o,"output"))),o}async batch(e,t,r){const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(ct)),a=await Promise.all(i.map((c,u)=>c==null?void 0:c.handleChainStart(this.toJSON(),te(e[u],"input"),void 0,void 0,void 0,void 0,s[u].runName)));let o=e;try{for(let c=0;c<this.steps.length;c+=1)o=await this.steps[c].batch(o,a.map((l,h)=>{const d=l==null?void 0:l.getChild(`seq:step:${c+1}`);return ae(s[h],{callbacks:d})}),r)}catch(c){throw await Promise.all(a.map(u=>u==null?void 0:u.handleChainError(c))),c}return await Promise.all(a.map(c=>c==null?void 0:c.handleChainEnd(te(o,"output")))),o}async*_streamIterator(e,t){const r=await ct(t),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),te(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),i=[this.first,...this.middle,this.last];let a=!0,o;async function*c(){yield e}try{let u=i[0].transform(c(),ae(t,{callbacks:s==null?void 0:s.getChild("seq:step:1")}));for(let l=1;l<i.length;l+=1)u=await i[l].transform(u,ae(t,{callbacks:s==null?void 0:s.getChild(`seq:step:${l+1}`)}));for await(const l of u)if(yield l,a)if(o===void 0)o=l;else try{o=ot(o,l)}catch{o=void 0,a=!1}}catch(u){throw await(s==null?void 0:s.handleChainError(u)),u}await(s==null?void 0:s.handleChainEnd(te(o,"output")))}pipe(e){return Ie.isRunnableSequence(e)?new Ie({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Ie({first:this.first,middle:[...this.middle,this.last],last:at(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&J.isRunnable(e)}static from([e,...t],r){return new Ie({first:at(e),middle:t.slice(0,-1).map(at),last:at(t[t.length-1]),name:r})}}class Ft extends J{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=at(r)}static from(e){return new Ft({steps:e})}async invoke(e,t){const r=W(t),s=await ct(r),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,r==null?void 0:r.runName)),a={};try{await Promise.all(Object.entries(this.steps).map(async([o,c])=>{a[o]=await c.invoke(e,ae(r,{callbacks:i==null?void 0:i.getChild(`map:key:${o}`)}))}))}catch(o){throw await(i==null?void 0:i.handleChainError(o)),o}return await(i==null?void 0:i.handleChainEnd(a)),a}async*_transform(e,t,r){const s={...this.steps},i=xo(e,Object.keys(s).length),a=new Map(Object.entries(s).map(([o,c],u)=>{const l=c.transform(i[u],ae(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(h=>({key:o,gen:l,result:h}))]}));for(;a.size;){const{key:o,result:c,gen:u}=await Promise.race(a.values());a.delete(o),c.done||(yield{[o]:c.value},a.set(o,u.next().then(l=>({key:o,gen:u,result:l}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Bt(this.transform(r(),t));return await s.setup,Ne.fromAsyncGenerator(s)}}class vi extends J{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new vi({func:e})}async _invoke(e,t,r){return new Promise((s,i)=>{const a=ae(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((t==null?void 0:t.recursionLimit)??rs)-1});Ss.getInstance().run(a,async()=>{try{let o=await this.func(e,{...a,config:a});if(o&&J.isRunnable(o)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...a,recursionLimit:(a.recursionLimit??rs)-1})}s(o)}catch(o){i(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let s;for await(const a of e)if(s===void 0)s=a;else try{s=ot(s,a)}catch{s=a}const i=await new Promise((a,o)=>{Ss.getInstance().run(r,async()=>{try{const c=await this.func(s,{...r,config:r});a(c)}catch(c){o(c)}})});if(i&&J.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const a=await i.stream(s,ae(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??rs)-1}));for await(const o of a)yield o}else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Bt(this.transform(r(),t));return await s.setup,Ne.fromAsyncGenerator(s)}}class Ml extends J{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await ne.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),te(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let i;for(const a of this.runnables())try{const o=await a.invoke(e,ae(t,{callbacks:s==null?void 0:s.getChild()}));return await(s==null?void 0:s.handleChainEnd(te(o,"output"))),o}catch(o){i===void 0&&(i=o)}throw i===void 0?new Error("No error stored at end of fallback."):(await(s==null?void 0:s.handleChainError(i)),i)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(c=>ne.configure(c==null?void 0:c.callbacks,void 0,c==null?void 0:c.tags,void 0,c==null?void 0:c.metadata))),a=await Promise.all(i.map((c,u)=>c==null?void 0:c.handleChainStart(this.toJSON(),te(e[u],"input"),void 0,void 0,void 0,void 0,s[u].runName)));let o;for(const c of this.runnables())try{const u=await c.batch(e,a.map((l,h)=>ae(s[h],{callbacks:l==null?void 0:l.getChild()})),r);return await Promise.all(a.map((l,h)=>l==null?void 0:l.handleChainEnd(te(u[h],"output")))),u}catch(u){o===void 0&&(o=u)}throw o?(await Promise.all(a.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function at(n){if(typeof n=="function")return new vi({func:n});if(J.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=at(r);return new Ft({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class To extends J{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Ft&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const s=this.mapper.getStepsKeys(),[i,a]=xo(e),o=this.mapper.transform(a,ae(r,{callbacks:t==null?void 0:t.getChild()})),c=o.next();for await(const u of i){if(typeof u!="object"||Array.isArray(u))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof u}`);const l=Object.fromEntries(Object.entries(u).filter(([h])=>!s.includes(h)));Object.keys(l).length>0&&(yield l)}yield(await c).value;for await(const u of o)yield u}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Bt(this.transform(r(),t));return await s.setup,Ne.fromAsyncGenerator(s)}}class Bl extends J{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Bt(this.transform(r(),t));return await s.setup,Ne.fromAsyncGenerator(s)}}const Fl=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n,zl=()=>!1;class ql extends J{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??zl(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Vl extends ql{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=gi.global():this.cache=void 0,this.caller=new jn(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Vu("modelName"in this?Fl(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new lo(e):Array.isArray(e)?new au(e.map(Gt)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){const t={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()};return Object.entries(t).filter(([i,a])=>a!==void 0).map(([i,a])=>`${i}:${JSON.stringify(a)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class nt extends Vl{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r!=null&&r.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){const r=nt._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===nt.prototype._streamResponseChunks)yield this.invoke(e,t);else{const s=nt._convertInputToPromptValue(e).toChatMessages(),[i,a]=this._separateRunnableConfigFromCallOptions(t),o=await ne.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},u=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),[s],void 0,void 0,c,void 0,void 0,i.runName));let l;try{for await(const h of this._streamResponseChunks(s,a,u==null?void 0:u[0]))yield h.message,l?l=l.concat(h):l=h}catch(h){throw await Promise.all((u??[]).map(d=>d==null?void 0:d.handleLLMError(h))),h}await Promise.all((u??[]).map(h=>h==null?void 0:h.handleLLMEnd({generations:[[l]]})))}}async _generateUncached(e,t,r){var d;const s=e.map(f=>f.map(Gt)),i=await ne.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},o=await(i==null?void 0:i.handleChatModelStart(this.toJSON(),s,void 0,void 0,a,void 0,void 0,r.runName)),c=await Promise.allSettled(s.map((f,p)=>this._generate(f,{...t,promptIndex:p},o==null?void 0:o[p]))),u=[],l=[];await Promise.all(c.map(async(f,p)=>{var g,m;if(f.status==="fulfilled"){const b=f.value;return u[p]=b.generations,l[p]=b.llmOutput,(g=o==null?void 0:o[p])==null?void 0:g.handleLLMEnd({generations:[b.generations],llmOutput:b.llmOutput})}else return await((m=o==null?void 0:o[p])==null?void 0:m.handleLLMError(f.reason)),Promise.reject(f.reason)}));const h={generations:u,llmOutput:l.length?(d=this._combineLLMOutput)==null?void 0:d.call(this,...l):void 0};return Object.defineProperty(h,Ki,{value:o?{runIds:o==null?void 0:o.map(f=>f.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:s,handledOptions:i}){const a=e.map(g=>g.map(Gt)),o=await ne.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1,cached:!0},u=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),a,void 0,void 0,c,void 0,void 0,i.runName)),l=[],d=(await Promise.allSettled(a.map(async(g,m)=>{const b=nt._convertInputToPromptValue(g).toString(),A=await t.lookup(b,r);return A==null&&l.push(m),A}))).map((g,m)=>({result:g,runManager:u==null?void 0:u[m]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),f=[];await Promise.all(d.map(async({result:g,runManager:m},b)=>{if(g.status==="fulfilled"){const A=g.value;return f[b]=A,A.length&&await(m==null?void 0:m.handleLLMNewToken(A[0].text)),m==null?void 0:m.handleLLMEnd({generations:[A]})}else return await(m==null?void 0:m.handleLLMError(g.reason)),Promise.reject(g.reason)}));const p={generations:f,missingPromptIndices:l};return Object.defineProperty(p,Ki,{value:u?{runIds:u==null?void 0:u.map(g=>g.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let s;Array.isArray(t)?s={stop:t}:s=t;const i=e.map(f=>f.map(Gt)),[a,o]=this._separateRunnableConfigFromCallOptions(s);if(a.callbacks=a.callbacks??r,!this.cache)return this._generateUncached(i,o,a);const{cache:c}=this,u=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:h}=await this._generateCached({messages:i,cache:c,llmStringKey:u,parsedOptions:o,handledOptions:a});let d={};if(h.length>0){const f=await this._generateUncached(h.map(p=>i[p]),o,a);await Promise.all(f.generations.map(async(p,g)=>{const m=h[g];l[m]=p;const b=nt._convertInputToPromptValue(i[m]).toString();return c.update(b,u,p)})),d=f.llmOutput??{}}return{generations:l,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const s=e.map(i=>i.toChatMessages());return this.generate(s,t,r)}async call(e,t,r){return(await this.generate([e.map(Gt)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const s=e.toChatMessages();return this.call(s,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const s=new cn(e),i=await this.call([s],t,r);if(typeof i.content!="string")throw new Error("Cannot use predict when output is not a string.");return i.content}}function So(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function U(n,e,t,r,s){n[e]=t,So(n,e,r,s)}const ca={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"string",mapStrategy:"entries",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email"},Hl=n=>typeof n=="string"?{...ca,name:n}:{...ca,...n};var N;(function(n){n.assertEqual=s=>s;function e(s){}n.assertIs=e;function t(s){throw new Error}n.assertNever=t,n.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},n.getValidEnumValues=s=>{const i=n.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return n.objectValues(a)},n.objectValues=s=>n.objectKeys(s).map(function(i){return s[i]}),n.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},n.find=(s,i)=>{for(const a of s)if(i(a))return a},n.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&isFinite(s)&&Math.floor(s)===s;function r(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}n.joinValues=r,n.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(N||(N={}));var ua;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(ua||(ua={}));const w=N.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),st=n=>{switch(typeof n){case"undefined":return w.undefined;case"string":return w.string;case"number":return isNaN(n)?w.nan:w.number;case"boolean":return w.boolean;case"function":return w.function;case"bigint":return w.bigint;case"symbol":return w.symbol;case"object":return Array.isArray(n)?w.array:n===null?w.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?w.promise:typeof Map<"u"&&n instanceof Map?w.map:typeof Set<"u"&&n instanceof Set?w.set:typeof Date<"u"&&n instanceof Date?w.date:w.object;default:return w.unknown}},_=N.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Ee extends Error{constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(i){return i.message},r={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)r._errors.push(t(a));else{let o=r,c=0;for(;c<a.path.length;){const u=a.path[c];c===a.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(t(a))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return s(this),r}toString(){return this.message}get message(){return JSON.stringify(this.issues,N.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}Ee.create=n=>new Ee(n);const mn=(n,e)=>{let t;switch(n.code){case _.invalid_type:n.received===w.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case _.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,N.jsonStringifyReplacer)}`;break;case _.unrecognized_keys:t=`Unrecognized key(s) in object: ${N.joinValues(n.keys,", ")}`;break;case _.invalid_union:t="Invalid input";break;case _.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${N.joinValues(n.options)}`;break;case _.invalid_enum_value:t=`Invalid enum value. Expected ${N.joinValues(n.options)}, received '${n.received}'`;break;case _.invalid_arguments:t="Invalid function arguments";break;case _.invalid_return_type:t="Invalid function return type";break;case _.invalid_date:t="Invalid date";break;case _.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:N.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case _.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case _.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case _.custom:t="Invalid input";break;case _.invalid_intersection_types:t="Intersection results could not be merged";break;case _.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case _.not_finite:t="Number must be finite";break;default:t=e.defaultError,N.assertNever(n)}return{message:t}};let Zl=mn;function Cs(){return Zl}const Is=n=>{const{data:e,path:t,errorMaps:r,issueData:s}=n,i=[...t,...s.path||[]],a={...s,path:i};let o="";const c=r.filter(u=>!!u).slice().reverse();for(const u of c)o=u(a,{data:e,defaultError:o}).message;return{...s,path:i,message:s.message||o}};function v(n,e){const t=Is({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,Cs(),mn].filter(r=>!!r)});n.common.issues.push(t)}class se{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const s of t){if(s.status==="aborted")return T;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const s of t)r.push({key:await s.key,value:await s.value});return se.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const s of t){const{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return T;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(r[i.value]=a.value)}return{status:e.value,value:r}}}const T=Object.freeze({status:"aborted"}),Jl=n=>({status:"dirty",value:n}),oe=n=>({status:"valid",value:n}),la=n=>n.status==="aborted",ha=n=>n.status==="dirty",gn=n=>n.status==="valid",Rs=n=>typeof Promise<"u"&&n instanceof Promise;var E;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(E||(E={}));class Pe{constructor(e,t,r,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=s}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const da=(n,e)=>{if(gn(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Ee(n.common.issues);return this._error=t,this._error}}};function P(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:s}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>a.code!=="invalid_type"?{message:o.defaultError}:typeof o.data>"u"?{message:r??o.defaultError}:{message:t??o.defaultError},description:s}}class I{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return st(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:st(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new se,ctx:{common:e.parent.common,data:e.data,parsedType:st(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Rs(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const s={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:st(e)},i=this._parseSync({data:e,path:s.path,parent:s});return da(s,i)}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:st(e)},s=this._parse({data:e,path:r.path,parent:r}),i=await(Rs(s)?s:Promise.resolve(s));return da(r,i)}refine(e,t){const r=s=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,i)=>{const a=e(s),o=()=>i.addIssue({code:_.custom,...r(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(c=>c?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof t=="function"?t(r,s):t),!1))}_refinement(e){return new Ue({schema:this,typeName:y.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Ke.create(this,this._def)}nullable(){return Lt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Oe.create(this,this._def)}promise(){return pr.create(this,this._def)}or(e){return bn.create([this,e],this._def)}and(e){return wn.create(this,e,this._def)}transform(e){return new Ue({...P(this._def),schema:this,typeName:y.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new On({...P(this._def),innerType:this,defaultValue:t,typeName:y.ZodDefault})}brand(){return new ih({typeName:y.ZodBranded,type:this,...P(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Ms({...P(this._def),innerType:this,catchValue:t,typeName:y.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Un.create(this,e)}readonly(){return Fs.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Kl=/^c[^\s-]{8,}$/i,Gl=/^[a-z][a-z0-9]*$/,Wl=/^[0-9A-HJKMNP-TV-Z]{26}$/,Ql=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Xl=/^(?!\.)(?!.*\.\.)([A-Z0-9_+-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Yl="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let ns;const eh=/^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$/,th=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,rh=n=>n.precision?n.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}(([+-]\\d{2}(:?\\d{2})?)|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}Z$`):n.precision===0?n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");function nh(n,e){return!!((e==="v4"||!e)&&eh.test(n)||(e==="v6"||!e)&&th.test(n))}class Re extends I{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==w.string){const i=this._getOrReturnCtx(e);return v(i,{code:_.invalid_type,expected:w.string,received:i.parsedType}),T}const r=new se;let s;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),v(s,{code:_.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),v(s,{code:_.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?v(s,{code:_.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&v(s,{code:_.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),r.dirty())}else if(i.kind==="email")Xl.test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"email",code:_.invalid_string,message:i.message}),r.dirty());else if(i.kind==="emoji")ns||(ns=new RegExp(Yl,"u")),ns.test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"emoji",code:_.invalid_string,message:i.message}),r.dirty());else if(i.kind==="uuid")Ql.test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"uuid",code:_.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid")Kl.test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"cuid",code:_.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid2")Gl.test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"cuid2",code:_.invalid_string,message:i.message}),r.dirty());else if(i.kind==="ulid")Wl.test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"ulid",code:_.invalid_string,message:i.message}),r.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),v(s,{validation:"url",code:_.invalid_string,message:i.message}),r.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"regex",code:_.invalid_string,message:i.message}),r.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),v(s,{code:_.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),r.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),v(s,{code:_.invalid_string,validation:{startsWith:i.value},message:i.message}),r.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),v(s,{code:_.invalid_string,validation:{endsWith:i.value},message:i.message}),r.dirty()):i.kind==="datetime"?rh(i).test(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{code:_.invalid_string,validation:"datetime",message:i.message}),r.dirty()):i.kind==="ip"?nh(e.data,i.version)||(s=this._getOrReturnCtx(e,s),v(s,{validation:"ip",code:_.invalid_string,message:i.message}),r.dirty()):N.assertNever(i);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(s=>e.test(s),{validation:t,code:_.invalid_string,...E.errToObj(r)})}_addCheck(e){return new Re({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...E.errToObj(e)})}url(e){return this._addCheck({kind:"url",...E.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...E.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...E.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...E.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...E.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...E.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...E.errToObj(e)})}datetime(e){var t;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,...E.errToObj(e==null?void 0:e.message)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...E.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...E.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...E.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...E.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...E.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...E.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...E.errToObj(t)})}nonempty(e){return this.min(1,E.errToObj(e))}trim(){return new Re({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Re({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Re({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Re.create=n=>{var e;return new Re({checks:[],typeName:y.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...P(n)})};function sh(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=t>r?t:r,i=parseInt(n.toFixed(s).replace(".","")),a=parseInt(e.toFixed(s).replace(".",""));return i%a/Math.pow(10,s)}class jt extends I{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==w.number){const i=this._getOrReturnCtx(e);return v(i,{code:_.invalid_type,expected:w.number,received:i.parsedType}),T}let r;const s=new se;for(const i of this._def.checks)i.kind==="int"?N.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{code:_.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),v(r,{code:_.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),v(r,{code:_.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?sh(e.data,i.value)!==0&&(r=this._getOrReturnCtx(e,r),v(r,{code:_.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{code:_.not_finite,message:i.message}),s.dirty()):N.assertNever(i);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,s){return new jt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(s)}]})}_addCheck(e){return new jt({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:E.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:E.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:E.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:E.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&N.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}jt.create=n=>new jt({checks:[],typeName:y.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...P(n)});class $t extends I{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==w.bigint){const i=this._getOrReturnCtx(e);return v(i,{code:_.invalid_type,expected:w.bigint,received:i.parsedType}),T}let r;const s=new se;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),v(r,{code:_.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),v(r,{code:_.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),v(r,{code:_.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):N.assertNever(i);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,s){return new $t({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(s)}]})}_addCheck(e){return new $t({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}$t.create=n=>{var e;return new $t({checks:[],typeName:y.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...P(n)})};class js extends I{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==w.boolean){const r=this._getOrReturnCtx(e);return v(r,{code:_.invalid_type,expected:w.boolean,received:r.parsedType}),T}return oe(e.data)}}js.create=n=>new js({typeName:y.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...P(n)});class fr extends I{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==w.date){const i=this._getOrReturnCtx(e);return v(i,{code:_.invalid_type,expected:w.date,received:i.parsedType}),T}if(isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return v(i,{code:_.invalid_date}),T}const r=new se;let s;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),v(s,{code:_.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),r.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),v(s,{code:_.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),r.dirty()):N.assertNever(i);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new fr({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:E.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:E.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}fr.create=n=>new fr({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:y.ZodDate,...P(n)});class $s extends I{_parse(e){if(this._getType(e)!==w.symbol){const r=this._getOrReturnCtx(e);return v(r,{code:_.invalid_type,expected:w.symbol,received:r.parsedType}),T}return oe(e.data)}}$s.create=n=>new $s({typeName:y.ZodSymbol,...P(n)});class yn extends I{_parse(e){if(this._getType(e)!==w.undefined){const r=this._getOrReturnCtx(e);return v(r,{code:_.invalid_type,expected:w.undefined,received:r.parsedType}),T}return oe(e.data)}}yn.create=n=>new yn({typeName:y.ZodUndefined,...P(n)});class _n extends I{_parse(e){if(this._getType(e)!==w.null){const r=this._getOrReturnCtx(e);return v(r,{code:_.invalid_type,expected:w.null,received:r.parsedType}),T}return oe(e.data)}}_n.create=n=>new _n({typeName:y.ZodNull,...P(n)});class Ns extends I{constructor(){super(...arguments),this._any=!0}_parse(e){return oe(e.data)}}Ns.create=n=>new Ns({typeName:y.ZodAny,...P(n)});class Ct extends I{constructor(){super(...arguments),this._unknown=!0}_parse(e){return oe(e.data)}}Ct.create=n=>new Ct({typeName:y.ZodUnknown,...P(n)});class Qe extends I{_parse(e){const t=this._getOrReturnCtx(e);return v(t,{code:_.invalid_type,expected:w.never,received:t.parsedType}),T}}Qe.create=n=>new Qe({typeName:y.ZodNever,...P(n)});class Ls extends I{_parse(e){if(this._getType(e)!==w.undefined){const r=this._getOrReturnCtx(e);return v(r,{code:_.invalid_type,expected:w.void,received:r.parsedType}),T}return oe(e.data)}}Ls.create=n=>new Ls({typeName:y.ZodVoid,...P(n)});class Oe extends I{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),s=this._def;if(t.parsedType!==w.array)return v(t,{code:_.invalid_type,expected:w.array,received:t.parsedType}),T;if(s.exactLength!==null){const a=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(a||o)&&(v(t,{code:a?_.too_big:_.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(v(t,{code:_.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(v(t,{code:_.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((a,o)=>s.type._parseAsync(new Pe(t,a,t.path,o)))).then(a=>se.mergeArray(r,a));const i=[...t.data].map((a,o)=>s.type._parseSync(new Pe(t,a,t.path,o)));return se.mergeArray(r,i)}get element(){return this._def.type}min(e,t){return new Oe({...this._def,minLength:{value:e,message:E.toString(t)}})}max(e,t){return new Oe({...this._def,maxLength:{value:e,message:E.toString(t)}})}length(e,t){return new Oe({...this._def,exactLength:{value:e,message:E.toString(t)}})}nonempty(e){return this.min(1,e)}}Oe.create=(n,e)=>new Oe({type:n,minLength:null,maxLength:null,exactLength:null,typeName:y.ZodArray,...P(e)});function At(n){if(n instanceof F){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=Ke.create(At(r))}return new F({...n._def,shape:()=>e})}else return n instanceof Oe?new Oe({...n._def,type:At(n.element)}):n instanceof Ke?Ke.create(At(n.unwrap())):n instanceof Lt?Lt.create(At(n.unwrap())):n instanceof Le?Le.create(n.items.map(e=>At(e))):n}class F extends I{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=N.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==w.object){const u=this._getOrReturnCtx(e);return v(u,{code:_.invalid_type,expected:w.object,received:u.parsedType}),T}const{status:r,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof Qe&&this._def.unknownKeys==="strip"))for(const u in s.data)a.includes(u)||o.push(u);const c=[];for(const u of a){const l=i[u],h=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new Pe(s,h,s.path,u)),alwaysSet:u in s.data})}if(this._def.catchall instanceof Qe){const u=this._def.unknownKeys;if(u==="passthrough")for(const l of o)c.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(u==="strict")o.length>0&&(v(s,{code:_.unrecognized_keys,keys:o}),r.dirty());else if(u!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const l of o){const h=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new Pe(s,h,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const u=[];for(const l of c){const h=await l.key;u.push({key:h,value:await l.value,alwaysSet:l.alwaysSet})}return u}).then(u=>se.mergeObjectSync(r,u)):se.mergeObjectSync(r,c)}get shape(){return this._def.shape()}strict(e){return E.errToObj,new F({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var s,i,a,o;const c=(a=(i=(s=this._def).errorMap)===null||i===void 0?void 0:i.call(s,t,r).message)!==null&&a!==void 0?a:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=E.errToObj(e).message)!==null&&o!==void 0?o:c}:{message:c}}}:{}})}strip(){return new F({...this._def,unknownKeys:"strip"})}passthrough(){return new F({...this._def,unknownKeys:"passthrough"})}extend(e){return new F({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new F({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:y.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new F({...this._def,catchall:e})}pick(e){const t={};return N.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new F({...this._def,shape:()=>t})}omit(e){const t={};return N.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new F({...this._def,shape:()=>t})}deepPartial(){return At(this)}partial(e){const t={};return N.objectKeys(this.shape).forEach(r=>{const s=this.shape[r];e&&!e[r]?t[r]=s:t[r]=s.optional()}),new F({...this._def,shape:()=>t})}required(e){const t={};return N.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let i=this.shape[r];for(;i instanceof Ke;)i=i._def.innerType;t[r]=i}}),new F({...this._def,shape:()=>t})}keyof(){return Co(N.objectKeys(this.shape))}}F.create=(n,e)=>new F({shape:()=>n,unknownKeys:"strip",catchall:Qe.create(),typeName:y.ZodObject,...P(e)});F.strictCreate=(n,e)=>new F({shape:()=>n,unknownKeys:"strict",catchall:Qe.create(),typeName:y.ZodObject,...P(e)});F.lazycreate=(n,e)=>new F({shape:n,unknownKeys:"strip",catchall:Qe.create(),typeName:y.ZodObject,...P(e)});class bn extends I{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function s(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const a=i.map(o=>new Ee(o.ctx.common.issues));return v(t,{code:_.invalid_union,unionErrors:a}),T}if(t.common.async)return Promise.all(r.map(async i=>{const a={...t,common:{...t.common,issues:[]},parent:null};return{result:await i._parseAsync({data:t.data,path:t.path,parent:a}),ctx:a}})).then(s);{let i;const a=[];for(const c of r){const u={...t,common:{...t.common,issues:[]},parent:null},l=c._parseSync({data:t.data,path:t.path,parent:u});if(l.status==="valid")return l;l.status==="dirty"&&!i&&(i={result:l,ctx:u}),u.common.issues.length&&a.push(u.common.issues)}if(i)return t.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(c=>new Ee(c));return v(t,{code:_.invalid_union,unionErrors:o}),T}}get options(){return this._def.options}}bn.create=(n,e)=>new bn({options:n,typeName:y.ZodUnion,...P(e)});const Lr=n=>n instanceof An?Lr(n.schema):n instanceof Ue?Lr(n.innerType()):n instanceof kn?[n.value]:n instanceof lt?n.options:n instanceof En?Object.keys(n.enum):n instanceof On?Lr(n._def.innerType):n instanceof yn?[void 0]:n instanceof _n?[null]:null;class Ai extends I{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==w.object)return v(t,{code:_.invalid_type,expected:w.object,received:t.parsedType}),T;const r=this.discriminator,s=t.data[r],i=this.optionsMap.get(s);return i?t.common.async?i._parseAsync({data:t.data,path:t.path,parent:t}):i._parseSync({data:t.data,path:t.path,parent:t}):(v(t,{code:_.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),T)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const s=new Map;for(const i of t){const a=Lr(i.shape[e]);if(!a)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of a){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,i)}}return new Ai({typeName:y.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...P(r)})}}function Us(n,e){const t=st(n),r=st(e);if(n===e)return{valid:!0,data:n};if(t===w.object&&r===w.object){const s=N.objectKeys(e),i=N.objectKeys(n).filter(o=>s.indexOf(o)!==-1),a={...n,...e};for(const o of i){const c=Us(n[o],e[o]);if(!c.valid)return{valid:!1};a[o]=c.data}return{valid:!0,data:a}}else if(t===w.array&&r===w.array){if(n.length!==e.length)return{valid:!1};const s=[];for(let i=0;i<n.length;i++){const a=n[i],o=e[i],c=Us(a,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return t===w.date&&r===w.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class wn extends I{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=(i,a)=>{if(la(i)||la(a))return T;const o=Us(i.value,a.value);return o.valid?((ha(i)||ha(a))&&t.dirty(),{status:t.value,value:o.data}):(v(r,{code:_.invalid_intersection_types}),T)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}wn.create=(n,e,t)=>new wn({left:n,right:e,typeName:y.ZodIntersection,...P(t)});class Le extends I{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==w.array)return v(r,{code:_.invalid_type,expected:w.array,received:r.parsedType}),T;if(r.data.length<this._def.items.length)return v(r,{code:_.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),T;!this._def.rest&&r.data.length>this._def.items.length&&(v(r,{code:_.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const i=[...r.data].map((a,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new Pe(r,a,r.path,o)):null}).filter(a=>!!a);return r.common.async?Promise.all(i).then(a=>se.mergeArray(t,a)):se.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new Le({...this._def,rest:e})}}Le.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Le({items:n,typeName:y.ZodTuple,rest:null,...P(e)})};class vn extends I{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==w.object)return v(r,{code:_.invalid_type,expected:w.object,received:r.parsedType}),T;const s=[],i=this._def.keyType,a=this._def.valueType;for(const o in r.data)s.push({key:i._parse(new Pe(r,o,r.path,o)),value:a._parse(new Pe(r,r.data[o],r.path,o))});return r.common.async?se.mergeObjectAsync(t,s):se.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof I?new vn({keyType:e,valueType:t,typeName:y.ZodRecord,...P(r)}):new vn({keyType:Re.create(),valueType:e,typeName:y.ZodRecord,...P(t)})}}class Ds extends I{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==w.map)return v(r,{code:_.invalid_type,expected:w.map,received:r.parsedType}),T;const s=this._def.keyType,i=this._def.valueType,a=[...r.data.entries()].map(([o,c],u)=>({key:s._parse(new Pe(r,o,r.path,[u,"key"])),value:i._parse(new Pe(r,c,r.path,[u,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of a){const u=await c.key,l=await c.value;if(u.status==="aborted"||l.status==="aborted")return T;(u.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(u.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const c of a){const u=c.key,l=c.value;if(u.status==="aborted"||l.status==="aborted")return T;(u.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(u.value,l.value)}return{status:t.value,value:o}}}}Ds.create=(n,e,t)=>new Ds({valueType:e,keyType:n,typeName:y.ZodMap,...P(t)});class Nt extends I{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==w.set)return v(r,{code:_.invalid_type,expected:w.set,received:r.parsedType}),T;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(v(r,{code:_.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(v(r,{code:_.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const i=this._def.valueType;function a(c){const u=new Set;for(const l of c){if(l.status==="aborted")return T;l.status==="dirty"&&t.dirty(),u.add(l.value)}return{status:t.value,value:u}}const o=[...r.data.values()].map((c,u)=>i._parse(new Pe(r,c,r.path,u)));return r.common.async?Promise.all(o).then(c=>a(c)):a(o)}min(e,t){return new Nt({...this._def,minSize:{value:e,message:E.toString(t)}})}max(e,t){return new Nt({...this._def,maxSize:{value:e,message:E.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Nt.create=(n,e)=>new Nt({valueType:n,minSize:null,maxSize:null,typeName:y.ZodSet,...P(e)});class tr extends I{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==w.function)return v(t,{code:_.invalid_type,expected:w.function,received:t.parsedType}),T;function r(o,c){return Is({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Cs(),mn].filter(u=>!!u),issueData:{code:_.invalid_arguments,argumentsError:c}})}function s(o,c){return Is({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Cs(),mn].filter(u=>!!u),issueData:{code:_.invalid_return_type,returnTypeError:c}})}const i={errorMap:t.common.contextualErrorMap},a=t.data;if(this._def.returns instanceof pr){const o=this;return oe(async function(...c){const u=new Ee([]),l=await o._def.args.parseAsync(c,i).catch(f=>{throw u.addIssue(r(c,f)),u}),h=await Reflect.apply(a,this,l);return await o._def.returns._def.type.parseAsync(h,i).catch(f=>{throw u.addIssue(s(h,f)),u})})}else{const o=this;return oe(function(...c){const u=o._def.args.safeParse(c,i);if(!u.success)throw new Ee([r(c,u.error)]);const l=Reflect.apply(a,this,u.data),h=o._def.returns.safeParse(l,i);if(!h.success)throw new Ee([s(l,h.error)]);return h.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new tr({...this._def,args:Le.create(e).rest(Ct.create())})}returns(e){return new tr({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new tr({args:e||Le.create([]).rest(Ct.create()),returns:t||Ct.create(),typeName:y.ZodFunction,...P(r)})}}class An extends I{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}An.create=(n,e)=>new An({getter:n,typeName:y.ZodLazy,...P(e)});class kn extends I{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return v(t,{received:t.data,code:_.invalid_literal,expected:this._def.value}),T}return{status:"valid",value:e.data}}get value(){return this._def.value}}kn.create=(n,e)=>new kn({value:n,typeName:y.ZodLiteral,...P(e)});function Co(n,e){return new lt({values:n,typeName:y.ZodEnum,...P(e)})}class lt extends I{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return v(t,{expected:N.joinValues(r),received:t.parsedType,code:_.invalid_type}),T}if(this._def.values.indexOf(e.data)===-1){const t=this._getOrReturnCtx(e),r=this._def.values;return v(t,{received:t.data,code:_.invalid_enum_value,options:r}),T}return oe(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e){return lt.create(e)}exclude(e){return lt.create(this.options.filter(t=>!e.includes(t)))}}lt.create=Co;class En extends I{_parse(e){const t=N.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==w.string&&r.parsedType!==w.number){const s=N.objectValues(t);return v(r,{expected:N.joinValues(s),received:r.parsedType,code:_.invalid_type}),T}if(t.indexOf(e.data)===-1){const s=N.objectValues(t);return v(r,{received:r.data,code:_.invalid_enum_value,options:s}),T}return oe(e.data)}get enum(){return this._def.values}}En.create=(n,e)=>new En({values:n,typeName:y.ZodNativeEnum,...P(e)});class pr extends I{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==w.promise&&t.common.async===!1)return v(t,{code:_.invalid_type,expected:w.promise,received:t.parsedType}),T;const r=t.parsedType===w.promise?t.data:Promise.resolve(t.data);return oe(r.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}}pr.create=(n,e)=>new pr({type:n,typeName:y.ZodPromise,...P(e)});class Ue extends I{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===y.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{v(r,a),a.fatal?t.abort():t.dirty()},get path(){return r.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){const a=s.transform(r.data,i);return r.common.issues.length?{status:"dirty",value:r.data}:r.common.async?Promise.resolve(a).then(o=>this._def.schema._parseAsync({data:o,path:r.path,parent:r})):this._def.schema._parseSync({data:a,path:r.path,parent:r})}if(s.type==="refinement"){const a=o=>{const c=s.refinement(o,i);if(r.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?T:(o.status==="dirty"&&t.dirty(),a(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?T:(o.status==="dirty"&&t.dirty(),a(o.value).then(()=>({status:t.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){const a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!gn(a))return a;const o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(a=>gn(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:t.value,value:o})):a);N.assertNever(s)}}Ue.create=(n,e,t)=>new Ue({schema:n,typeName:y.ZodEffects,effect:e,...P(t)});Ue.createWithPreprocess=(n,e,t)=>new Ue({schema:e,effect:{type:"preprocess",transform:n},typeName:y.ZodEffects,...P(t)});class Ke extends I{_parse(e){return this._getType(e)===w.undefined?oe(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ke.create=(n,e)=>new Ke({innerType:n,typeName:y.ZodOptional,...P(e)});class Lt extends I{_parse(e){return this._getType(e)===w.null?oe(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Lt.create=(n,e)=>new Lt({innerType:n,typeName:y.ZodNullable,...P(e)});class On extends I{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===w.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}On.create=(n,e)=>new On({innerType:n,typeName:y.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...P(e)});class Ms extends I{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Rs(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new Ee(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new Ee(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Ms.create=(n,e)=>new Ms({innerType:n,typeName:y.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...P(e)});class Bs extends I{_parse(e){if(this._getType(e)!==w.nan){const r=this._getOrReturnCtx(e);return v(r,{code:_.invalid_type,expected:w.nan,received:r.parsedType}),T}return{status:"valid",value:e.data}}}Bs.create=n=>new Bs({typeName:y.ZodNaN,...P(n)});class ih extends I{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class Un extends I{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return i.status==="aborted"?T:i.status==="dirty"?(t.dirty(),Jl(i.value)):this._def.out._parseAsync({data:i.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?T:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,t){return new Un({in:e,out:t,typeName:y.ZodPipeline})}}class Fs extends I{_parse(e){const t=this._def.innerType._parse(e);return gn(t)&&(t.value=Object.freeze(t.value)),t}}Fs.create=(n,e)=>new Fs({innerType:n,typeName:y.ZodReadonly,...P(e)});F.lazycreate;var y;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(y||(y={}));Re.create;jt.create;Bs.create;$t.create;js.create;fr.create;$s.create;yn.create;_n.create;Ns.create;Ct.create;Qe.create;Ls.create;Oe.create;F.create;F.strictCreate;bn.create;Ai.create;wn.create;Le.create;vn.create;Ds.create;Nt.create;tr.create;An.create;kn.create;lt.create;En.create;pr.create;Ue.create;Ke.create;Lt.create;Ue.createWithPreprocess;Un.create;function ah(){return{}}function oh(n,e){var r,s;const t={type:"array"};return((s=(r=n.type)==null?void 0:r._def)==null?void 0:s.typeName)!==y.ZodAny&&(t.items=L(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&U(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&U(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(U(t,"minItems",n.exactLength.value,n.exactLength.message,e),U(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function ch(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?U(t,"minimum",r.value,r.message,e):U(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),U(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?U(t,"maximum",r.value,r.message,e):U(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),U(t,"maximum",r.value,r.message,e));break;case"multipleOf":U(t,"multipleOf",r.value,r.message,e);break}return t}function uh(){return{type:"boolean"}}function lh(n,e){return L(n.type._def,e)}const hh=(n,e)=>L(n.innerType._def,e);function dh(n,e){return e.dateStrategy=="integer"?fh(n,e):{type:"string",format:"date-time"}}const fh=(n,e)=>{const t={type:"integer",format:"unix-time"};for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"&&U(t,"minimum",r.value,r.message,e);break;case"max":e.target==="jsonSchema7"&&U(t,"maximum",r.value,r.message,e);break}return t};function ph(n,e){return{...L(n.innerType._def,e),default:n.defaultValue()}}function mh(n,e){return e.effectStrategy==="input"?L(n.schema._def,e):{}}function gh(n){return{type:"string",enum:n.values}}const yh=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function _h(n,e){const t=[L(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),L(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return t.forEach(i=>{if(yh(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else r=void 0;s.push(a)}}),s.length?{allOf:s,...r}:void 0}function bh(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}const qt={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$"};function Io(n,e){const t={type:"string"};function r(s){return e.patternStrategy==="escape"?wh(s):s}if(n.checks)for(const s of n.checks)switch(s.kind){case"min":U(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e);break;case"max":U(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Xe(t,"email",s.message,e);break;case"format:idn-email":Xe(t,"idn-email",s.message,e);break;case"pattern:zod":Se(t,qt.email,s.message,e);break}break;case"url":Xe(t,"uri",s.message,e);break;case"uuid":Xe(t,"uuid",s.message,e);break;case"regex":Se(t,s.regex.source,s.message,e);break;case"cuid":Se(t,qt.cuid,s.message,e);break;case"cuid2":Se(t,qt.cuid2,s.message,e);break;case"startsWith":Se(t,"^"+r(s.value),s.message,e);break;case"endsWith":Se(t,r(s.value)+"$",s.message,e);break;case"datetime":Xe(t,"date-time",s.message,e);break;case"length":U(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e),U(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"includes":{Se(t,r(s.value),s.message,e);break}case"ip":{s.version!=="v6"&&Xe(t,"ipv4",s.message,e),s.version!=="v4"&&Xe(t,"ipv6",s.message,e);break}case"emoji":Se(t,qt.emoji,s.message,e);break;case"ulid":{Se(t,qt.ulid,s.message,e);break}}return t}const wh=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Xe=(n,e,t,r)=>{var s;n.format||(s=n.anyOf)!=null&&s.some(i=>i.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):U(n,"format",e,t,r)},Se=(n,e,t,r)=>{var s;n.pattern||(s=n.allOf)!=null&&s.some(i=>i.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:e,...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):U(n,"pattern",e,t,r)};function Ro(n,e){var r,s,i,a;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===y.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,c)=>({...o,[c]:L(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:L(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===y.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){const o=Object.entries(Io(n.keyType._def,e)).reduce((c,[u,l])=>u==="type"?c:{...c,[u]:l},{});return{...t,propertyNames:o}}else if(((a=n.keyType)==null?void 0:a._def.typeName)===y.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function vh(n,e){if(e.mapStrategy==="record")return Ro(n,e);const t=L(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=L(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Ah(n){const e=n.values,r=Object.keys(n.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(r.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function kh(){return{not:{}}}function Eh(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const xn={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Oh(n,e){if(e.target==="openApi3")return fa(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in xn&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((s,i)=>{const a=xn[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===t.length){const s=r.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:t.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,s)=>[...r,...s._def.values.filter(i=>!r.includes(i))],[])};return fa(n,e)}const fa=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,s)=>L(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function xh(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:xn[n.innerType._def.typeName],nullable:!0}:{type:[xn[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=L(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=L(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Ph(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",So(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?U(t,"minimum",r.value,r.message,e):U(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),U(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?U(t,"maximum",r.value,r.message,e):U(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),U(t,"maximum",r.value,r.message,e));break;case"multipleOf":U(t,"multipleOf",r.value,r.message,e);break}return t}function Th(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((r,[s,i])=>{if(i===void 0||i._def===void 0)return r;const a=L(i._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return a===void 0?r:{properties:{...r.properties,[s]:a},required:i.isOptional()?r.required:[...r.required,s]}},{properties:{},required:[]}),additionalProperties:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":L(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0};return t.required.length||delete t.required,t}const Sh=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return L(n.innerType._def,e);const t=L(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Ch=(n,e)=>{if(e.pipeStrategy==="input")return L(n.in._def,e);if(e.pipeStrategy==="output")return L(n.out._def,e);const t=L(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=L(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(s=>s!==void 0)}};function Ih(n,e){return L(n.type._def,e)}function Rh(n,e){const r={type:"array",uniqueItems:!0,items:L(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&U(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&U(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function jh(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>L(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:L(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>L(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function $h(){return{not:{}}}function Nh(){return{}}const Lh=(n,e)=>L(n.innerType._def,e);function L(n,e,t=!1){const r=e.seen.get(n);if(r&&!t){const a=Uh(r,e);if(a!==void 0)return a}const s={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,s);const i=Mh(n,n.typeName,e);return i&&Bh(n,e,i),s.jsonSchema=i,i}const Uh=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Dh(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Dh=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Mh=(n,e,t)=>{switch(e){case y.ZodString:return Io(n,t);case y.ZodNumber:return Ph(n,t);case y.ZodObject:return Th(n,t);case y.ZodBigInt:return ch(n,t);case y.ZodBoolean:return uh();case y.ZodDate:return dh(n,t);case y.ZodUndefined:return $h();case y.ZodNull:return Eh(t);case y.ZodArray:return oh(n,t);case y.ZodUnion:case y.ZodDiscriminatedUnion:return Oh(n,t);case y.ZodIntersection:return _h(n,t);case y.ZodTuple:return jh(n,t);case y.ZodRecord:return Ro(n,t);case y.ZodLiteral:return bh(n,t);case y.ZodEnum:return gh(n);case y.ZodNativeEnum:return Ah(n);case y.ZodNullable:return xh(n,t);case y.ZodOptional:return Sh(n,t);case y.ZodMap:return vh(n,t);case y.ZodSet:return Rh(n,t);case y.ZodLazy:return L(n.getter()._def,t);case y.ZodPromise:return Ih(n,t);case y.ZodNaN:case y.ZodNever:return kh();case y.ZodEffects:return mh(n,t);case y.ZodAny:return ah();case y.ZodUnknown:return Nh();case y.ZodDefault:return ph(n,t);case y.ZodBranded:return lh(n,t);case y.ZodReadonly:return Lh(n,t);case y.ZodCatch:return hh(n,t);case y.ZodPipeline:return Ch(n,t);case y.ZodFunction:case y.ZodVoid:case y.ZodSymbol:return;default:return(r=>{})()}},Bh=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),Fh=n=>{const e=Hl(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}},jo=(n,e)=>{const t=Fh(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((o,[c,u])=>({...o,[c]:L(u._def,{...t,currentPath:[...t.basePath,t.definitionPath,c]},!0)??{}}),{}):void 0,s=typeof e=="string"?e:e==null?void 0:e.name,i=L(n._def,s===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,s]},!1)??{},a=s===void 0?r?{...i,[t.definitionPath]:r}:i:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...r,[s]:i}};return t.target==="jsonSchema7"?a.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(a.$schema="https://json-schema.org/draft/2019-09/schema#"),a};function zh(n){return{name:n.name,description:n.description,parameters:jo(n.schema)}}function qh(n){return{type:"function",function:zh(n)}}class zs extends J{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=W(t);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,t){const r=W(t);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,r))if(yield a,i)if(s===void 0)s=a;else try{s=ot(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new To(new Ft({steps:e}))}}class ki extends J{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async r=>this.parseResult([{text:r}]),e,{...t,runType:"parser"}):this._callWithConfig(async r=>this.parseResult([{message:r,text:typeof r.content=="string"?r.content:JSON.stringify(r.content)}]),e,{...t,runType:"parser"})}}class Vh extends ki{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}function qs(n,e){const t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;const r=n.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!qs(n[s],e[s]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;const r=Object.keys(n),s=Object.keys(e);if(r.length!==s.length)return!1;for(const a of r)if(!qs(n[a],e[a]))return!1;return!0}return n===e}class $o extends Vh{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:typeof t.content=="string"?t.content:JSON.stringify(t.content)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Hh extends $o{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,r;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if(Kc(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new hr({message:s,text:s.content})}else if(mi(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new hr({message:s.toChunk(),text:s.content})}else i=new Cn({text:s});r===void 0?r=i:r=r.concat(i);const a=await this.parsePartialResult([r]);a!=null&&!qs(a,t)&&(this.diff?yield this._diff(t,a):yield a,t=a)}}}class No extends $o{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}}class Zh extends Hh{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Il(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return pa(e[0].text)}async parse(e){return pa(e,JSON.parse)}getFormatInstructions(){return""}}function pa(n,e=Jh){n=n.trim();const t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function Jh(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="";const t=[];let r=!1,s=!1;for(let i of n){if(r)i==='"'&&!s?r=!1:i===`
`&&!s?i="\\n":i==="\\"?s=!s:s=!1;else if(i==='"')r=!0,s=!1;else if(i==="{")t.push("}");else if(i==="[")t.push("]");else if(i==="}"||i==="]")if(t&&t[t.length-1]===i)t.pop();else return null;e+=i}r&&(e+='"');for(let i=t.length-1;i>=0;i-=1)e+=t[i];try{return JSON.parse(e)}catch{return null}}class Kh extends ki{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}async parseResult(e){const t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);const r=JSON.parse(JSON.stringify(t)),s=[];for(const i of r)if(i.function!==void 0){const a={type:i.function.name,args:JSON.parse(i.function.arguments)};this.returnId&&(a.id=i.id),Object.defineProperty(a,"name",{get(){return this.type}}),Object.defineProperty(a,"arguments",{get(){return this.args}}),s.push(a)}return s}}class ma extends ki{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new Kh(e)}async parseResult(e){const r=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName);let s=r;return this.returnId||(s=r.map(i=>i.args)),this.returnSingle?s[0]:s}}function Lo(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:i}=n;if(r&&s&&e)return`${s}/${e}`;if(r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i}function Uo(n){let e;return n.constructor.name===$c.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===Nc.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}function Gh(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function Wh(n){const e=["namespace functions {",""];for(const t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(Do(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Do(n,e){var r;const t=[];for(const[s,i]of Object.entries(n.properties??{}))i.description&&e<2&&t.push(`// ${i.description}`),(r=n.required)!=null&&r.includes(s)?t.push(`${s}: ${Pn(i,e)},`):t.push(`${s}?: ${Pn(i,e)},`);return t.map(s=>" ".repeat(e)+s).join(`
`)}function Pn(n,e){if(Gh(n))return n.anyOf.map(t=>Pn(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Do(n,e+2),"}"].join(`
`);case"array":return n.items?`${Pn(n.items,e)}[]`:"any[]";default:return""}}function Qh(n){return n.role!=="system"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function Mo(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!_r.isInstance(n))throw new Error("Invalid generic chat message");return Qh(n)}default:throw new Error(`Unknown message type: ${e}`)}}function Xh(n){switch(n.role){case"assistant":return new ao(n.content||"",{function_call:n.function_call,tool_calls:n.tool_calls});default:return new _r(n.content||"",n.role??"unknown")}}function Yh(n,e){const t=n.role??e,r=n.content??"";let s;return n.function_call?s={function_call:n.function_call}:n.tool_calls?s={tool_calls:n.tool_calls}:s={},t==="user"?new or({content:r}):t==="assistant"?new Rt({content:r,additional_kwargs:s}):t==="system"?new cr({content:r}):t==="function"?new ur({content:r,additional_kwargs:s,name:n.name}):t==="tool"?new un({content:r,additional_kwargs:s,tool_call_id:n.tool_call_id}):new lr({content:r,role:t})}function ga(n){return n.map(e=>({role:Mo(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id}))}class ed extends nt{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var r,s,i,a,o,c,u,l;if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.openAIApiKey)??q("OPENAI_API_KEY"),this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??q("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??q("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??q("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??q("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??q("AZURE_OPENAI_BASE_PATH"),this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??q("OPENAI_ORGANIZATION"),this.modelName=(e==null?void 0:e.modelName)??this.modelName,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.user=e==null?void 0:e.user,this.streaming=(e==null?void 0:e.streaming)??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:(t==null?void 0:t.basePath)??((s=e==null?void 0:e.configuration)==null?void 0:s.basePath),dangerouslyAllowBrowser:!0,defaultHeaders:((i=t==null?void 0:t.baseOptions)==null?void 0:i.headers)??((o=(a=e==null?void 0:e.configuration)==null?void 0:a.baseOptions)==null?void 0:o.headers),defaultQuery:((c=t==null?void 0:t.baseOptions)==null?void 0:c.params)??((l=(u=e==null?void 0:e.configuration)==null?void 0:u.baseOptions)==null?void 0:l.params),...t,...e==null?void 0:e.configuration}}invocationParams(e){function t(s){return s!==void 0&&s.every(i=>Array.isArray(i.lc_namespace))}return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stop,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:t(e==null?void 0:e.tools)?e==null?void 0:e.tools.map(qh):e==null?void 0:e.tools,tool_choice:e==null?void 0:e.tool_choice,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var c;const s=ga(e),i={...this.invocationParams(t),messages:s,stream:!0};let a;const o=await this.completionWithRetry(i,t);for await(const u of o){const l=u==null?void 0:u.choices[0];if(!l)continue;const{delta:h}=l;if(!h)continue;const d=Yh(h,a);a=h.role??a;const f={prompt:t.promptIndex??0,completion:l.index??0};if(typeof d.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const p=new hr({message:d,text:d.content,generationInfo:f});yield p,r==null||r.handleLLMNewToken(p.text??"",f,void 0,void 0,void 0,{chunk:p})}if((c=t.signal)!=null&&c.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var o,c;const s={},i=this.invocationParams(t),a=ga(e);if(i.stream){const u=this._streamResponseChunks(e,t,r),l={};for await(const m of u){const b=((o=m.generationInfo)==null?void 0:o.completion)??0;l[b]===void 0?l[b]=m:l[b]=l[b].concat(m)}const h=Object.entries(l).sort(([m],[b])=>parseInt(m,10)-parseInt(b,10)).map(([m,b])=>b),{functions:d,function_call:f}=this.invocationParams(t),p=await this.getEstimatedTokenCountFromPrompt(e,d,f),g=await this.getNumTokensFromGenerations(h);return s.promptTokens=p,s.completionTokens=g,s.totalTokens=p+g,{generations:h,llmOutput:{estimatedTokenUsage:s}}}else{const u=await this.completionWithRetry({...i,stream:!1,messages:a},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:l,prompt_tokens:h,total_tokens:d}=(u==null?void 0:u.usage)??{};l&&(s.completionTokens=(s.completionTokens??0)+l),h&&(s.promptTokens=(s.promptTokens??0)+h),d&&(s.totalTokens=(s.totalTokens??0)+d);const f=[];for(const p of(u==null?void 0:u.choices)??[]){const m={text:((c=p.message)==null?void 0:c.content)??"",message:Xh(p.message??{role:"assistant"})};m.generationInfo={...p.finish_reason?{finish_reason:p.finish_reason}:{},...p.logprobs?{logprobs:p.logprobs}:{}},f.push(m)}return{generations:f,llmOutput:{tokenUsage:s}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){const i=Wh(t);s+=await this.getNumTokens(i),s+=9}return t&&e.find(i=>i._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async getNumTokensFromMessages(e){let t=0,r=0,s=0;this.modelName==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const i=await Promise.all(e.map(async a=>{var d,f,p,g,m;const o=await this.getNumTokens(a.content),c=await this.getNumTokens(Mo(a)),u=a.name!==void 0?s+await this.getNumTokens(a.name):0;let l=o+r+c+u;const h=a;return h._getType()==="function"&&(l-=2),(d=h.additional_kwargs)!=null&&d.function_call&&(l+=3),(f=h==null?void 0:h.additional_kwargs.function_call)!=null&&f.name&&(l+=await this.getNumTokens((p=h.additional_kwargs.function_call)==null?void 0:p.name)),(g=h.additional_kwargs.function_call)!=null&&g.arguments&&(l+=await this.getNumTokens(JSON.stringify(JSON.parse((m=h.additional_kwargs.function_call)==null?void 0:m.arguments)))),t+=l,l}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(s){throw Uo(s)}})}_getClientOptions(e){if(!this.client){const r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},s=Lo(r),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new V(i)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput({schema:e,name:t,method:r="functionCalling",includeRaw:s=!1}){let i,a;if(r==="jsonMode")i=this.bind({response_format:{type:"json_object"}}),a=new Zh;else if(td(e)){const l=jo(e);i=this.bind({tools:[{type:"function",function:{name:t,description:l.description,parameters:l}}],tool_choice:"auto"}),a=new ma({returnSingle:!0,keyName:t})}else i=this.bind({tools:[{type:"function",function:{name:t,description:e.description,parameters:e}}],tool_choice:"auto"}),a=new ma({returnSingle:!0,keyName:t});if(!s)return i.pipe(a);const o=zs.assign({parsed:(l,h)=>a.invoke(l.raw,h)}),c=zs.assign({parsed:()=>null}),u=o.withFallbacks({fallbacks:[c]});return Ie.from([{raw:i},u])}}function td(n){return typeof(n==null?void 0:n.parse)=="function"}const rd=(n,e)=>n.reduce((t,r,s)=>{const i=Math.floor(s/e),a=t[i]||[];return t[i]=a.concat([r]),t},[]);class nd{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new jn(e??{})}}class sd extends nd{constructor(e,t){var u,l,h;const r={maxConcurrency:2,...e};super(r),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"dimensions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let s=(r==null?void 0:r.openAIApiKey)??q("OPENAI_API_KEY");const i=(r==null?void 0:r.azureOpenAIApiKey)??q("AZURE_OPENAI_API_KEY");if(!i&&!s)throw new Error("OpenAI or Azure OpenAI API key not found");const a=(r==null?void 0:r.azureOpenAIApiInstanceName)??q("AZURE_OPENAI_API_INSTANCE_NAME"),o=((r==null?void 0:r.azureOpenAIApiEmbeddingsDeploymentName)||(r==null?void 0:r.azureOpenAIApiDeploymentName))??(q("AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME")||q("AZURE_OPENAI_API_DEPLOYMENT_NAME")),c=(r==null?void 0:r.azureOpenAIApiVersion)??q("AZURE_OPENAI_API_VERSION");if(this.azureOpenAIBasePath=(r==null?void 0:r.azureOpenAIBasePath)??q("AZURE_OPENAI_BASE_PATH"),this.organization=((u=r==null?void 0:r.configuration)==null?void 0:u.organization)??q("OPENAI_ORGANIZATION"),this.modelName=(r==null?void 0:r.modelName)??this.modelName,this.batchSize=(r==null?void 0:r.batchSize)??(i?1:this.batchSize),this.stripNewLines=(r==null?void 0:r.stripNewLines)??this.stripNewLines,this.timeout=r==null?void 0:r.timeout,this.dimensions=r==null?void 0:r.dimensions,this.azureOpenAIApiVersion=c,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=o,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");s=s??""}this.clientConfig={apiKey:s,organization:this.organization,baseURL:t==null?void 0:t.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:(l=t==null?void 0:t.baseOptions)==null?void 0:l.headers,defaultQuery:(h=t==null?void 0:t.baseOptions)==null?void 0:h.params,...t,...e==null?void 0:e.configuration}}async embedDocuments(e){const t=rd(this.stripNewLines?e.map(a=>a.replace(/\n/g," ")):e,this.batchSize),r=t.map(a=>{const o={model:this.modelName,input:a};return this.dimensions&&(o.dimensions=this.dimensions),this.embeddingWithRetry(o)}),s=await Promise.all(r),i=[];for(let a=0;a<s.length;a+=1){const o=t[a],{data:c}=s[a];for(let u=0;u<o.length;u+=1)i.push(c[u].embedding)}return i}async embedQuery(e){const t={model:this.modelName,input:this.stripNewLines?e.replace(/\n/g," "):e};this.dimensions&&(t.dimensions=this.dimensions);const{data:r}=await this.embeddingWithRetry(t);return r[0].embedding}async embeddingWithRetry(e){if(!this.client){const r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},s=Lo(r),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new V(i)}const t={};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(r){throw Uo(r)}})}}const id="modulepreload",ad=function(n){return"/"+n},ya={},$e=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){const i=document.getElementsByTagName("link");s=Promise.all(t.map(a=>{if(a=ad(a),a in ya)return;ya[a]=!0;const o=a.endsWith(".css"),c=o?'[rel="stylesheet"]':"";if(!!r)for(let h=i.length-1;h>=0;h--){const d=i[h];if(d.href===a&&(!o||d.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${c}`))return;const l=document.createElement("link");if(l.rel=o?"stylesheet":id,o||(l.as="script",l.crossOrigin=""),l.href=a,document.head.appendChild(l),o)return new Promise((h,d)=>{l.addEventListener("load",h),l.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${a}`)))})}))}return s.then(()=>e()).catch(i=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i})};class od extends J{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[i,a]of Object.entries(t))typeof a=="string"?r[i]=a:r[i]=await a();return{...r,...e}}async invoke(e,t){return this._callWithConfig(r=>this.formatPromptValue(r),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await $e(()=>Promise.resolve().then(()=>_a),void 0);return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await $e(()=>Promise.resolve().then(()=>_a),void 0);return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await $e(()=>import("./few_shot-EBvdxw15.js"),__vite__mapDeps([]));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}class cd extends od{async formatPromptValue(e){const t=await this.format(e);return new lo(t)}}const Bo=n=>{const e=n.split(""),t=[],r=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")t.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")t.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const i=r("}",s);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const i=r("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");t.push({type:"literal",text:a}),s=i<0?e.length:i}}return t},ud=(n,e)=>Bo(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`Missing value for input ${r.name}`)}return t+r.text},""),Vs={"f-string":ud},ld={"f-string":Bo},Wt=(n,e,t)=>Vs[e](n,t),hd=(n,e)=>ld[e](n),dd=(n,e,t)=>{if(!(e in Vs)){const r=Object.keys(Vs);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=t.reduce((s,i)=>(s[i]="foo",s),{});Array.isArray(n)?n.forEach(s=>{if(s.type==="text")Wt(s.text,e,r);else if(s.type==="image_url")if(typeof s.image_url=="string")Wt(s.image_url,e,r);else{const i=s.image_url.url;Wt(i,e,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):Wt(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};class Je extends cd{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),dd(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return Wt(this.template,this.templateFormat,t)}static fromExamples(e,t,r,s=`

`,i=""){const a=[i,...e,t].join(s);return new Je({inputVariables:r,template:a})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){const s=new Set;return hd(e,t).forEach(i=>{i.type==="variable"&&s.add(i.name)}),new Je({inputVariables:[...s],templateFormat:t,template:e,...r})}async partial(e){const t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:r};return new Je(s)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new Je({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}const _a=Object.freeze(Object.defineProperty({__proto__:null,PromptTemplate:Je},Symbol.toStringTag,{value:"Module"}));function fd(n,e){let t=0,r=0,s=0;for(let i=0;i<n.length;i++)t+=n[i]*e[i],r+=n[i]*n[i],s+=e[i]*e[i];return t/(Math.sqrt(r)*Math.sqrt(s))}class pd extends J{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,t){throw new Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,W(t))}async getRelevantDocuments(e,t){const r=W(vl(t)),s=await ne.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,void 0,void 0,void 0,void 0,r.runName));try{const a=await this._getRelevantDocuments(e,i);return await(i==null?void 0:i.handleRetrieverEnd(a)),a}catch(a){throw await(i==null?void 0:i.handleRetrieverError(a)),a}}}class ss extends pd{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t==null?void 0:t.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t==null?void 0:t.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class md extends We{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,t=4,r=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map(a=>a[0])}async similaritySearchWithScore(e,t=4,r=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,s,i,a){if(typeof e=="number")return new ss({vectorStore:this,k:e,filter:t,tags:[...s??[],this._vectorstoreType()],metadata:i,verbose:a,callbacks:r});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new ss({...o,searchKwargs:e.searchKwargs}):new ss({...o})}}}class is{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent?e.pageContent.toString():this.pageContent,this.metadata=e.metadata??{}}}class Ei extends md{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??fd}async addDocuments(e){const t=e.map(({pageContent:r})=>r);return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){const r=e.map((s,i)=>({content:t[i].pageContent,embedding:s,metadata:t[i].metadata}));this.memoryVectors=this.memoryVectors.concat(r)}async similaritySearchVectorWithScore(e,t,r){const s=c=>{if(!r)return!0;const u=new is({metadata:c.metadata,pageContent:c.content});return r(u)},i=this.memoryVectors.filter(s);return i.map((c,u)=>({similarity:this.similarity(e,c.embedding),index:u})).sort((c,u)=>c.similarity>u.similarity?-1:0).slice(0,t).map(c=>[new is({metadata:i[c.index].metadata,pageContent:i[c.index].content}),c.similarity])}static async fromTexts(e,t,r,s){const i=[];for(let a=0;a<e.length;a+=1){const o=Array.isArray(t)?t[a]:t,c=new is({pageContent:e[a],metadata:o});i.push(c)}return Ei.fromDocuments(i,r,s)}static async fromDocuments(e,t,r){const s=new this(t,r);return await s.addDocuments(e),s}static async fromExistingIndex(e,t){return new this(e,t)}}const gd=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>$e(()=>Promise.resolve().then(()=>wr),void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)};class Oi extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class yd extends Oi{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class _d extends Oi{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class bd extends Oi{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var wd=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(h){a(h)}}function c(l){try{u(r.throw(l))}catch(h){a(h)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(n,e||[])).next())})};class vd{constructor(e,{headers:t={},customFetch:r}={}){this.url=e,this.headers=t,this.fetch=gd(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var r;return wd(this,void 0,void 0,function*(){try{const{headers:s,method:i,body:a}=t;let o={},c;a&&(s&&!Object.prototype.hasOwnProperty.call(s,"Content-Type")||!s)&&(typeof Blob<"u"&&a instanceof Blob||a instanceof ArrayBuffer?(o["Content-Type"]="application/octet-stream",c=a):typeof a=="string"?(o["Content-Type"]="text/plain",c=a):typeof FormData<"u"&&a instanceof FormData?c=a:(o["Content-Type"]="application/json",c=JSON.stringify(a)));const u=yield this.fetch(`${this.url}/${e}`,{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},o),this.headers),s),body:c}).catch(f=>{throw new yd(f)}),l=u.headers.get("x-relay-error");if(l&&l==="true")throw new _d(u);if(!u.ok)throw new bd(u);let h=((r=u.headers.get("Content-Type"))!==null&&r!==void 0?r:"text/plain").split(";")[0].trim(),d;return h==="application/json"?d=yield u.json():h==="application/octet-stream"?d=yield u.blob():h==="multipart/form-data"?d=yield u.formData():d=yield u.text(),{data:d,error:null}}catch(s){return{data:null,error:s}}})}}var Ad=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Ut=Ad();const kd=Ut.fetch,xi=Ut.fetch.bind(Ut),Fo=Ut.Headers,Ed=Ut.Request,Od=Ut.Response,wr=Object.freeze(Object.defineProperty({__proto__:null,Headers:Fo,Request:Ed,Response:Od,default:xi,fetch:kd},Symbol.toStringTag,{value:"Module"}));class xd extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}}class Pd{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=xi:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const r=this.fetch;let s=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{var a,o,c;let u=null,l=null,h=null,d=i.status,f=i.statusText;if(i.ok){if(this.method!=="HEAD"){const b=await i.text();b===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?l=b:l=JSON.parse(b))}const g=(a=this.headers.Prefer)===null||a===void 0?void 0:a.match(/count=(exact|planned|estimated)/),m=(o=i.headers.get("content-range"))===null||o===void 0?void 0:o.split("/");g&&m&&m.length>1&&(h=parseInt(m[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(l)&&(l.length>1?(u={code:"PGRST116",details:`Results contain ${l.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},l=null,h=null,d=406,f="Not Acceptable"):l.length===1?l=l[0]:l=null)}else{const g=await i.text();try{u=JSON.parse(g),Array.isArray(u)&&i.status===404&&(l=[],u=null,d=200,f="OK")}catch{i.status===404&&g===""?(d=204,f="No Content"):u={message:g}}if(u&&this.isMaybeSingle&&(!((c=u==null?void 0:u.details)===null||c===void 0)&&c.includes("0 rows"))&&(u=null,d=200,f="OK"),u&&this.shouldThrowOnError)throw new xd(u)}return{error:u,data:l,count:h,status:d,statusText:f}});return this.shouldThrowOnError||(s=s.catch(i=>{var a,o,c;return{error:{message:`${(a=i==null?void 0:i.name)!==null&&a!==void 0?a:"FetchError"}: ${i==null?void 0:i.message}`,details:`${(o=i==null?void 0:i.stack)!==null&&o!==void 0?o:""}`,hint:"",code:`${(c=i==null?void 0:i.code)!==null&&c!==void 0?c:""}`},data:null,count:null,status:0,statusText:""}})),s.then(e,t)}}class Td extends Pd{select(e){let t=!1;const r=(e??"*").split("").map(s=>/\s/.test(s)&&!t?"":(s==='"'&&(t=!t),s)).join("");return this.url.searchParams.set("select",r),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:r,foreignTable:s,referencedTable:i=s}={}){const a=i?`${i}.order`:"order",o=this.url.searchParams.get(a);return this.url.searchParams.set(a,`${o?`${o},`:""}${e}.${t?"asc":"desc"}${r===void 0?"":r?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:r=t}={}){const s=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(s,`${e}`),this}range(e,t,{foreignTable:r,referencedTable:s=r}={}){const i=typeof s>"u"?"offset":`${s}.offset`,a=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(i,`${e}`),this.url.searchParams.set(a,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:r=!1,buffers:s=!1,wal:i=!1,format:a="text"}={}){var o;const c=[e?"analyze":null,t?"verbose":null,r?"settings":null,s?"buffers":null,i?"wal":null].filter(Boolean).join("|"),u=(o=this.headers.Accept)!==null&&o!==void 0?o:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${a}; for="${u}"; options=${c};`,a==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}class kt extends Td{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const r=t.map(s=>typeof s=="string"&&new RegExp("[,()]").test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`in.(${r})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:r,type:s}={}){let i="";s==="plain"?i="pl":s==="phrase"?i="ph":s==="websearch"&&(i="w");const a=r===void 0?"":`(${r})`;return this.url.searchParams.append(e,`${i}fts${a}.${t}`),this}match(e){return Object.entries(e).forEach(([t,r])=>{this.url.searchParams.append(t,`eq.${r}`)}),this}not(e,t,r){return this.url.searchParams.append(e,`not.${t}.${r}`),this}or(e,{foreignTable:t,referencedTable:r=t}={}){const s=r?`${r}.or`:"or";return this.url.searchParams.append(s,`(${e})`),this}filter(e,t,r){return this.url.searchParams.append(e,`${t}.${r}`),this}}class Sd{constructor(e,{headers:t={},schema:r,fetch:s}){this.url=e,this.headers=t,this.schema=r,this.fetch=s}select(e,{head:t=!1,count:r}={}){const s=t?"HEAD":"GET";let i=!1;const a=(e??"*").split("").map(o=>/\s/.test(o)&&!i?"":(o==='"'&&(i=!i),o)).join("");return this.url.searchParams.set("select",a),r&&(this.headers.Prefer=`count=${r}`),new kt({method:s,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:r=!0}={}){const s="POST",i=[];if(this.headers.Prefer&&i.push(this.headers.Prefer),t&&i.push(`count=${t}`),r||i.push("missing=default"),this.headers.Prefer=i.join(","),Array.isArray(e)){const a=e.reduce((o,c)=>o.concat(Object.keys(c)),[]);if(a.length>0){const o=[...new Set(a)].map(c=>`"${c}"`);this.url.searchParams.set("columns",o.join(","))}}return new kt({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:r=!1,count:s,defaultToNull:i=!0}={}){const a="POST",o=[`resolution=${r?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&o.push(this.headers.Prefer),s&&o.push(`count=${s}`),i||o.push("missing=default"),this.headers.Prefer=o.join(","),Array.isArray(e)){const c=e.reduce((u,l)=>u.concat(Object.keys(l)),[]);if(c.length>0){const u=[...new Set(c)].map(l=>`"${l}"`);this.url.searchParams.set("columns",u.join(","))}}return new kt({method:a,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const r="PATCH",s=[];return this.headers.Prefer&&s.push(this.headers.Prefer),t&&s.push(`count=${t}`),this.headers.Prefer=s.join(","),new kt({method:r,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",r=[];return e&&r.push(`count=${e}`),this.headers.Prefer&&r.unshift(this.headers.Prefer),this.headers.Prefer=r.join(","),new kt({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}}const Cd="1.9.2",Id={"X-Client-Info":`postgrest-js/${Cd}`};class Pi{constructor(e,{headers:t={},schema:r,fetch:s}={}){this.url=e,this.headers=Object.assign(Object.assign({},Id),t),this.schemaName=r,this.fetch=s}from(e){const t=new URL(`${this.url}/${e}`);return new Sd(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new Pi(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,count:s}={}){let i;const a=new URL(`${this.url}/rpc/${e}`);let o;r?(i="HEAD",Object.entries(t).forEach(([u,l])=>{a.searchParams.append(u,`${l}`)})):(i="POST",o=t);const c=Object.assign({},this.headers);return s&&(c.Prefer=`count=${s}`),new kt({method:i,url:a,headers:c,schema:this.schemaName,body:o,fetch:this.fetch,allowEmpty:!1})}}const Rd="2.9.3",jd={"X-Client-Info":`realtime-js/${Rd}`},$d="1.0.0",zo=1e4,Nd=1e3;var It;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(It||(It={}));var ue;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(ue||(ue={}));var _e;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(_e||(_e={}));var Hs;(function(n){n.websocket="websocket"})(Hs||(Hs={}));var it;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(it||(it={}));class qo{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}class Ld{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),r=new TextDecoder;return this._decodeBroadcast(e,t,r)}_decodeBroadcast(e,t,r){const s=t.getUint8(1),i=t.getUint8(2);let a=this.HEADER_LENGTH+2;const o=r.decode(e.slice(a,a+s));a=a+s;const c=r.decode(e.slice(a,a+i));a=a+i;const u=JSON.parse(r.decode(e.slice(a,e.byteLength)));return{ref:null,topic:o,event:c,payload:u}}}class as{constructor(e,t,r={},s=zo){this.channel=e,this.event=t,this.payload=r,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var ba;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(ba||(ba={}));class rr{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},s=>{const{onJoin:i,onLeave:a,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=rr.syncState(this.state,s,i,a),this.pendingDiffs.forEach(c=>{this.state=rr.syncDiff(this.state,c,i,a)}),this.pendingDiffs=[],o()}),this.channel._on(r.diff,{},s=>{const{onJoin:i,onLeave:a,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=rr.syncDiff(this.state,s,i,a),o())}),this.onJoin((s,i,a)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:i,newPresences:a})}),this.onLeave((s,i,a)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:i,leftPresences:a})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,s){const i=this.cloneDeep(e),a=this.transformState(t),o={},c={};return this.map(i,(u,l)=>{a[u]||(c[u]=l)}),this.map(a,(u,l)=>{const h=i[u];if(h){const d=l.map(m=>m.presence_ref),f=h.map(m=>m.presence_ref),p=l.filter(m=>f.indexOf(m.presence_ref)<0),g=h.filter(m=>d.indexOf(m.presence_ref)<0);p.length>0&&(o[u]=p),g.length>0&&(c[u]=g)}else o[u]=l}),this.syncDiff(i,{joins:o,leaves:c},r,s)}static syncDiff(e,t,r,s){const{joins:i,leaves:a}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),s||(s=()=>{}),this.map(i,(o,c)=>{var u;const l=(u=e[o])!==null&&u!==void 0?u:[];if(e[o]=this.cloneDeep(c),l.length>0){const h=e[o].map(f=>f.presence_ref),d=l.filter(f=>h.indexOf(f.presence_ref)<0);e[o].unshift(...d)}r(o,l,c)}),this.map(a,(o,c)=>{let u=e[o];if(!u)return;const l=c.map(h=>h.presence_ref);u=u.filter(h=>l.indexOf(h.presence_ref)<0),e[o]=u,s(o,u,c),u.length===0&&delete e[o]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const s=e[r];return"metas"in s?t[r]=s.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[r]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var D;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(D||(D={}));const wa=(n,e,t={})=>{var r;const s=(r=t.skipTypes)!==null&&r!==void 0?r:[];return Object.keys(e).reduce((i,a)=>(i[a]=Ud(a,n,e,s),i),{})},Ud=(n,e,t,r)=>{const s=e.find(o=>o.name===n),i=s==null?void 0:s.type,a=t[n];return i&&!r.includes(i)?Vo(i,a):Zs(a)},Vo=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return Fd(e,t)}switch(n){case D.bool:return Dd(e);case D.float4:case D.float8:case D.int2:case D.int4:case D.int8:case D.numeric:case D.oid:return Md(e);case D.json:case D.jsonb:return Bd(e);case D.timestamp:return zd(e);case D.abstime:case D.date:case D.daterange:case D.int4range:case D.int8range:case D.money:case D.reltime:case D.text:case D.time:case D.timestamptz:case D.timetz:case D.tsrange:case D.tstzrange:return Zs(e);default:return Zs(e)}},Zs=n=>n,Dd=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},Md=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},Bd=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch(e){return console.log(`JSON parse error: ${e}`),n}return n},Fd=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,r=n[t];if(n[0]==="{"&&r==="}"){let i;const a=n.slice(1,t);try{i=JSON.parse("["+a+"]")}catch{i=a?a.split(","):[]}return i.map(o=>Vo(e,o))}return n},zd=n=>typeof n=="string"?n.replace(" ","T"):n;var va;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(va||(va={}));var Aa;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes"})(Aa||(Aa={}));var ka;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(ka||(ka={}));class Ti{constructor(e,t={config:{}},r){this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=ue.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""}},t.config),this.timeout=this.socket.timeout,this.joinPush=new as(this,_e.join,this.params,this.timeout),this.rejoinTimer=new qo(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=ue.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(s=>s.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=ue.closed,this.socket._remove(this)}),this._onError(s=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,s),this.state=ue.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=ue.errored,this.rejoinTimer.scheduleTimeout())}),this._on(_e.reply,{},(s,i)=>{this._trigger(this._replyEventName(i),s)}),this.presence=new rr(this),this.broadcastEndpointURL=this._broadcastEndpointURL()}subscribe(e,t=this.timeout){var r,s;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:i,presence:a}}=this.params;this._onError(u=>e&&e("CHANNEL_ERROR",u)),this._onClose(()=>e&&e("CLOSED"));const o={},c={broadcast:i,presence:a,postgres_changes:(s=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(u=>u.filter))!==null&&s!==void 0?s:[]};this.socket.accessToken&&(o.access_token=this.socket.accessToken),this.updateJoinPayload(Object.assign({config:c},o)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",({postgres_changes:u})=>{var l;if(this.socket.accessToken&&this.socket.setAuth(this.socket.accessToken),u===void 0){e&&e("SUBSCRIBED");return}else{const h=this.bindings.postgres_changes,d=(l=h==null?void 0:h.length)!==null&&l!==void 0?l:0,f=[];for(let p=0;p<d;p++){const g=h[p],{filter:{event:m,schema:b,table:A,filter:k}}=g,x=u&&u[p];if(x&&x.event===m&&x.schema===b&&x.table===A&&x.filter===k)f.push(Object.assign(Object.assign({},g),{id:x.id}));else{this.unsubscribe(),e&&e("CHANNEL_ERROR",new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=f,e&&e("SUBSCRIBED");return}}).receive("error",u=>{e&&e("CHANNEL_ERROR",new Error(JSON.stringify(Object.values(u).join(", ")||"error")))}).receive("timeout",()=>{e&&e("TIMED_OUT")})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this._on(e,t,r)}async send(e,t={}){var r,s;if(!this._canPush()&&e.type==="broadcast"){const{event:i,payload:a}=e,o={method:"POST",headers:{apikey:(r=this.socket.apiKey)!==null&&r!==void 0?r:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:a}]})};try{return(await this._fetchWithTimeout(this.broadcastEndpointURL,o,(s=t.timeout)!==null&&s!==void 0?s:this.timeout)).ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var a,o,c;const u=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((c=(o=(a=this.params)===null||a===void 0?void 0:a.config)===null||o===void 0?void 0:o.broadcast)===null||c===void 0)&&c.ack)&&i("ok"),u.receive("ok",()=>i("ok")),u.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=ue.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(_e.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(r=>{const s=new as(this,_e.leave,{},e);s.receive("ok",()=>{t(),r("ok")}).receive("timeout",()=>{t(),r("timed out")}).receive("error",()=>{r("error")}),s.send(),this._canPush()||s.trigger("ok",{})})}_broadcastEndpointURL(){let e=this.socket.endPoint;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")+"/api/broadcast"}async _fetchWithTimeout(e,t,r){const s=new AbortController,i=setTimeout(()=>s.abort(),r),a=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(i),a}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new as(this,e,t,r);return this._canPush()?s.send():(s.startTimeout(),this.pushBuffer.push(s)),s}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var s,i;const a=e.toLocaleLowerCase(),{close:o,error:c,leave:u,join:l}=_e;if(r&&[o,c,u,l].indexOf(a)>=0&&r!==this._joinRef())return;let d=this._onMessage(a,t,r);if(t&&!d)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(a)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(f=>{var p,g,m;return((p=f.filter)===null||p===void 0?void 0:p.event)==="*"||((m=(g=f.filter)===null||g===void 0?void 0:g.event)===null||m===void 0?void 0:m.toLocaleLowerCase())===a}).map(f=>f.callback(d,r)):(i=this.bindings[a])===null||i===void 0||i.filter(f=>{var p,g,m,b,A,k;if(["broadcast","presence","postgres_changes"].includes(a))if("id"in f){const x=f.id,O=(p=f.filter)===null||p===void 0?void 0:p.event;return x&&((g=t.ids)===null||g===void 0?void 0:g.includes(x))&&(O==="*"||(O==null?void 0:O.toLocaleLowerCase())===((m=t.data)===null||m===void 0?void 0:m.type.toLocaleLowerCase()))}else{const x=(A=(b=f==null?void 0:f.filter)===null||b===void 0?void 0:b.event)===null||A===void 0?void 0:A.toLocaleLowerCase();return x==="*"||x===((k=t==null?void 0:t.event)===null||k===void 0?void 0:k.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===a}).map(f=>{if(typeof d=="object"&&"ids"in d){const p=d.data,{schema:g,table:m,commit_timestamp:b,type:A,errors:k}=p;d=Object.assign(Object.assign({},{schema:g,table:m,commit_timestamp:b,eventType:A,new:{},old:{},errors:k}),this._getPayloadRecords(p))}f.callback(d,r)})}_isClosed(){return this.state===ue.closed}_isJoined(){return this.state===ue.joined}_isJoining(){return this.state===ue.joining}_isLeaving(){return this.state===ue.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const s=e.toLocaleLowerCase(),i={type:s,filter:t,callback:r};return this.bindings[s]?this.bindings[s].push(i):this.bindings[s]=[i],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]=this.bindings[r].filter(s=>{var i;return!(((i=s.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===r&&Ti.isEqual(s.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(_e.close,{},e)}_onError(e){this._on(_e.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=ue.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=wa(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=wa(e.columns,e.old_record)),t}}const qd=()=>{},Vd=typeof WebSocket<"u";class Hd{constructor(e,t){var r;this.accessToken=null,this.apiKey=null,this.channels=[],this.endPoint="",this.headers=jd,this.params={},this.timeout=zo,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=qd,this.conn=null,this.sendBuffer=[],this.serializer=new Ld,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this._resolveFetch=i=>{let a;return i?a=i:typeof fetch>"u"?a=(...o)=>$e(()=>Promise.resolve().then(()=>wr),void 0).then(({default:c})=>c(...o)):a=fetch,(...o)=>a(...o)},this.endPoint=`${e}/${Hs.websocket}`,t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const s=(r=t==null?void 0:t.params)===null||r===void 0?void 0:r.apikey;s&&(this.accessToken=s,this.apiKey=s),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:i=>[1e3,2e3,5e3,1e4][i-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(i,a)=>a(JSON.stringify(i)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new qo(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch)}connect(){if(!this.conn){if(this.transport){this.conn=new this.transport(this._endPointURL(),void 0,{headers:this.headers});return}if(Vd){this.conn=new WebSocket(this._endPointURL()),this.setupConnection();return}this.conn=new Zd(this._endPointURL(),void 0,{close:()=>{this.conn=null}}),$e(()=>import("./browser-Ces0JSXJ.js").then(e=>e.b),__vite__mapDeps([])).then(({default:e})=>{this.conn=new e(this._endPointURL(),void 0,{headers:this.headers}),this.setupConnection()})}}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case It.connecting:return it.Connecting;case It.open:return it.Open;case It.closing:return it.Closing;default:return it.Closed}}isConnected(){return this.connectionState()===it.Open}channel(e,t={config:{}}){const r=new Ti(`realtime:${e}`,t,this);return this.channels.push(r),r}push(e){const{topic:t,event:r,payload:s,ref:i}=e,a=()=>{this.encode(e,o=>{var c;(c=this.conn)===null||c===void 0||c.send(o)})};this.log("push",`${t} ${r} (${i})`,s),this.isConnected()?a():this.sendBuffer.push(a)}setAuth(e){this.accessToken=e,this.channels.forEach(t=>{e&&t.updateJoinPayload({access_token:e}),t.joinedOnce&&t._isJoined()&&t._push(_e.access_token,{access_token:e})})}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t._joinRef()!==e._joinRef())}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_endPointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:$d}))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:r,event:s,payload:i,ref:a}=t;(a&&a===this.pendingHeartbeatRef||s===(i==null?void 0:i.type))&&(this.pendingHeartbeatRef=null),this.log("receive",`${i.status||""} ${r} ${s} ${a&&"("+a+")"||""}`,i),this.channels.filter(o=>o._isMember(r)).forEach(o=>o._trigger(s,i,a)),this.stateChangeCallbacks.message.forEach(o=>o(t))})}_onConnOpen(){this.log("transport",`connected to ${this._endPointURL()}`),this._flushSendBuffer(),this.reconnectTimer.reset(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this._sendHeartbeat(),this.heartbeatIntervalMs),this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(_e.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${r}${s}`}_flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(Nd,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth(this.accessToken)}}}class Zd{constructor(e,t,r){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=It.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=r.close}}class Si extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function ee(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}class Jd extends Si{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Ea extends Si{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var Kd=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(h){a(h)}}function c(l){try{u(r.throw(l))}catch(h){a(h)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(n,e||[])).next())})};const Ho=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>$e(()=>Promise.resolve().then(()=>wr),void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},Gd=()=>Kd(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield $e(()=>Promise.resolve().then(()=>wr),void 0)).Response:Response});var zt=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(h){a(h)}}function c(l){try{u(r.throw(l))}catch(h){a(h)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(n,e||[])).next())})};const os=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),Wd=(n,e)=>zt(void 0,void 0,void 0,function*(){const t=yield Gd();n instanceof t?n.json().then(r=>{e(new Jd(os(r),n.status||500))}).catch(r=>{e(new Ea(os(r),r))}):e(new Ea(os(n),n))}),Qd=(n,e,t,r)=>{const s={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};function Dn(n,e,t,r,s,i){return zt(this,void 0,void 0,function*(){return new Promise((a,o)=>{n(t,Qd(e,r,s,i)).then(c=>{if(!c.ok)throw c;return r!=null&&r.noResolveJson?c:c.json()}).then(c=>a(c)).catch(c=>Wd(c,o))})})}function Js(n,e,t,r){return zt(this,void 0,void 0,function*(){return Dn(n,"GET",e,t,r)})}function Ve(n,e,t,r,s){return zt(this,void 0,void 0,function*(){return Dn(n,"POST",e,r,s,t)})}function Xd(n,e,t,r,s){return zt(this,void 0,void 0,function*(){return Dn(n,"PUT",e,r,s,t)})}function Zo(n,e,t,r,s){return zt(this,void 0,void 0,function*(){return Dn(n,"DELETE",e,r,s,t)})}var le=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(h){a(h)}}function c(l){try{u(r.throw(l))}catch(h){a(h)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(n,e||[])).next())})};const Yd={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Oa={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class ef{constructor(e,t={},r,s){this.url=e,this.headers=t,this.bucketId=r,this.fetch=Ho(s)}uploadOrUpdate(e,t,r,s){return le(this,void 0,void 0,function*(){try{let i;const a=Object.assign(Object.assign({},Oa),s),o=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(a.upsert)});typeof Blob<"u"&&r instanceof Blob?(i=new FormData,i.append("cacheControl",a.cacheControl),i.append("",r)):typeof FormData<"u"&&r instanceof FormData?(i=r,i.append("cacheControl",a.cacheControl)):(i=r,o["cache-control"]=`max-age=${a.cacheControl}`,o["content-type"]=a.contentType);const c=this._removeEmptyFolders(t),u=this._getFinalPath(c),l=yield this.fetch(`${this.url}/object/${u}`,Object.assign({method:e,body:i,headers:o},a!=null&&a.duplex?{duplex:a.duplex}:{})),h=yield l.json();return l.ok?{data:{path:c,id:h.Id,fullPath:h.Key},error:null}:{data:null,error:h}}catch(i){if(ee(i))return{data:null,error:i};throw i}})}upload(e,t,r){return le(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,r)})}uploadToSignedUrl(e,t,r,s){return le(this,void 0,void 0,function*(){const i=this._removeEmptyFolders(e),a=this._getFinalPath(i),o=new URL(this.url+`/object/upload/sign/${a}`);o.searchParams.set("token",t);try{let c;const u=Object.assign({upsert:Oa.upsert},s),l=Object.assign(Object.assign({},this.headers),{"x-upsert":String(u.upsert)});typeof Blob<"u"&&r instanceof Blob?(c=new FormData,c.append("cacheControl",u.cacheControl),c.append("",r)):typeof FormData<"u"&&r instanceof FormData?(c=r,c.append("cacheControl",u.cacheControl)):(c=r,l["cache-control"]=`max-age=${u.cacheControl}`,l["content-type"]=u.contentType);const h=yield this.fetch(o.toString(),{method:"PUT",body:c,headers:l}),d=yield h.json();return h.ok?{data:{path:i,fullPath:d.Key},error:null}:{data:null,error:d}}catch(c){if(ee(c))return{data:null,error:c};throw c}})}createSignedUploadUrl(e){return le(this,void 0,void 0,function*(){try{let t=this._getFinalPath(e);const r=yield Ve(this.fetch,`${this.url}/object/upload/sign/${t}`,{},{headers:this.headers}),s=new URL(this.url+r.url),i=s.searchParams.get("token");if(!i)throw new Si("No token returned by API");return{data:{signedUrl:s.toString(),path:e,token:i},error:null}}catch(t){if(ee(t))return{data:null,error:t};throw t}})}update(e,t,r){return le(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,r)})}move(e,t){return le(this,void 0,void 0,function*(){try{return{data:yield Ve(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers}),error:null}}catch(r){if(ee(r))return{data:null,error:r};throw r}})}copy(e,t){return le(this,void 0,void 0,function*(){try{return{data:{path:(yield Ve(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers})).Key},error:null}}catch(r){if(ee(r))return{data:null,error:r};throw r}})}createSignedUrl(e,t,r){return le(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e),i=yield Ve(this.fetch,`${this.url}/object/sign/${s}`,Object.assign({expiresIn:t},r!=null&&r.transform?{transform:r.transform}:{}),{headers:this.headers});const a=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${a}`)},{data:i,error:null}}catch(s){if(ee(s))return{data:null,error:s};throw s}})}createSignedUrls(e,t,r){return le(this,void 0,void 0,function*(){try{const s=yield Ve(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return{data:s.map(a=>Object.assign(Object.assign({},a),{signedUrl:a.signedURL?encodeURI(`${this.url}${a.signedURL}${i}`):null})),error:null}}catch(s){if(ee(s))return{data:null,error:s};throw s}})}download(e,t){return le(this,void 0,void 0,function*(){const s=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),a=i?`?${i}`:"";try{const o=this._getFinalPath(e);return{data:yield(yield Js(this.fetch,`${this.url}/${s}/${o}${a}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(o){if(ee(o))return{data:null,error:o};throw o}})}getPublicUrl(e,t){const r=this._getFinalPath(e),s=[],i=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";i!==""&&s.push(i);const o=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",c=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});c!==""&&s.push(c);let u=s.join("&");return u!==""&&(u=`?${u}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${r}${u}`)}}}remove(e){return le(this,void 0,void 0,function*(){try{return{data:yield Zo(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(ee(t))return{data:null,error:t};throw t}})}list(e,t,r){return le(this,void 0,void 0,function*(){try{const s=Object.assign(Object.assign(Object.assign({},Yd),t),{prefix:e||""});return{data:yield Ve(this.fetch,`${this.url}/object/list/${this.bucketId}`,s,{headers:this.headers},r),error:null}}catch(s){if(ee(s))return{data:null,error:s};throw s}})}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const tf="2.5.5",rf={"X-Client-Info":`storage-js/${tf}`};var mt=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(h){a(h)}}function c(l){try{u(r.throw(l))}catch(h){a(h)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(n,e||[])).next())})};class nf{constructor(e,t={},r){this.url=e,this.headers=Object.assign(Object.assign({},rf),t),this.fetch=Ho(r)}listBuckets(){return mt(this,void 0,void 0,function*(){try{return{data:yield Js(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(ee(e))return{data:null,error:e};throw e}})}getBucket(e){return mt(this,void 0,void 0,function*(){try{return{data:yield Js(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(ee(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return mt(this,void 0,void 0,function*(){try{return{data:yield Ve(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(ee(r))return{data:null,error:r};throw r}})}updateBucket(e,t){return mt(this,void 0,void 0,function*(){try{return{data:yield Xd(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(ee(r))return{data:null,error:r};throw r}})}emptyBucket(e){return mt(this,void 0,void 0,function*(){try{return{data:yield Ve(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(ee(t))return{data:null,error:t};throw t}})}deleteBucket(e){return mt(this,void 0,void 0,function*(){try{return{data:yield Zo(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(ee(t))return{data:null,error:t};throw t}})}}class sf extends nf{constructor(e,t={},r){super(e,t,r)}from(e){return new ef(this.url,this.headers,e,this.fetch)}}const af="2.39.7";let Qt="";typeof Deno<"u"?Qt="deno":typeof document<"u"?Qt="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Qt="react-native":Qt="node";const of={"X-Client-Info":`supabase-js-${Qt}/${af}`},cf={headers:of},uf={schema:"public"},lf={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},hf={};var df=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(h){a(h)}}function c(l){try{u(r.throw(l))}catch(h){a(h)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(n,e||[])).next())})};const ff=n=>{let e;return n?e=n:typeof fetch>"u"?e=xi:e=fetch,(...t)=>e(...t)},pf=()=>typeof Headers>"u"?Fo:Headers,mf=(n,e,t)=>{const r=ff(t),s=pf();return(i,a)=>df(void 0,void 0,void 0,function*(){var o;const c=(o=yield e())!==null&&o!==void 0?o:n;let u=new s(a==null?void 0:a.headers);return u.has("apikey")||u.set("apikey",n),u.has("Authorization")||u.set("Authorization",`Bearer ${c}`),r(i,Object.assign(Object.assign({},a),{headers:u}))})};function gf(n){return n.replace(/\/$/,"")}function yf(n,e){const{db:t,auth:r,realtime:s,global:i}=n,{db:a,auth:o,realtime:c,global:u}=e;return{db:Object.assign(Object.assign({},a),t),auth:Object.assign(Object.assign({},o),r),realtime:Object.assign(Object.assign({},c),s),global:Object.assign(Object.assign({},u),i)}}function _f(n){return Math.round(Date.now()/1e3)+n}function bf(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})}const ye=()=>typeof document<"u",Ye={tested:!1,writable:!1},nr=()=>{if(!ye())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Ye.tested)return Ye.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),Ye.tested=!0,Ye.writable=!0}catch{Ye.tested=!0,Ye.writable=!1}return Ye.writable};function cs(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,i)=>{e[i]=s})}catch{}return t.searchParams.forEach((r,s)=>{e[s]=r}),e}const Jo=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>$e(()=>Promise.resolve().then(()=>wr),void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},wf=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",et=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},Pr=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},us=async(n,e)=>{await n.removeItem(e)};function vf(n){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",r,s,i,a,o,c,u,l=0;for(n=n.replace("-","+").replace("_","/");l<n.length;)a=e.indexOf(n.charAt(l++)),o=e.indexOf(n.charAt(l++)),c=e.indexOf(n.charAt(l++)),u=e.indexOf(n.charAt(l++)),r=a<<2|o>>4,s=(o&15)<<4|c>>2,i=(c&3)<<6|u,t=t+String.fromCharCode(r),c!=64&&s!=0&&(t=t+String.fromCharCode(s)),u!=64&&i!=0&&(t=t+String.fromCharCode(i));return t}class Mn{constructor(){this.promise=new Mn.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Mn.promiseConstructor=Promise;function xa(n){const e=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}=?$|[a-z0-9_-]{2}(==)?$)$/i,t=n.split(".");if(t.length!==3)throw new Error("JWT is not valid: not a JWT structure");if(!e.test(t[1]))throw new Error("JWT is not valid: payload is not in base64url format");const r=t[1];return JSON.parse(vf(r))}async function Af(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function kf(n,e){return new Promise((r,s)=>{(async()=>{for(let i=0;i<1/0;i++)try{const a=await n(i);if(!e(i,null,a)){r(a);return}}catch(a){if(!e(i,a)){s(a);return}}})()})}function Ef(n){return("0"+n.toString(16)).substr(-2)}function gt(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let s="";for(let i=0;i<56;i++)s+=t.charAt(Math.floor(Math.random()*r));return s}return crypto.getRandomValues(e),Array.from(e,Ef).join("")}async function Of(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(r);return Array.from(s).map(i=>String.fromCharCode(i)).join("")}function xf(n){return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function yt(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await Of(n);return xf(t)}class Ci extends Error{constructor(e,t){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t}}function R(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class Pf extends Ci{constructor(e,t){super(e,t),this.name="AuthApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}function Tf(n){return R(n)&&n.name==="AuthApiError"}class Ko extends Ci{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class ht extends Ci{constructor(e,t,r){super(e),this.name=t,this.status=r}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class _t extends ht{constructor(){super("Auth session missing!","AuthSessionMissingError",400)}}class ls extends ht{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500)}}class Tr extends ht{constructor(e){super(e,"AuthInvalidCredentialsError",400)}}class Sr extends ht{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Pa extends ht{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Ks extends ht{constructor(e,t){super(e,"AuthRetryableFetchError",t)}}function hs(n){return R(n)&&n.name==="AuthRetryableFetchError"}class Sf extends ht{constructor(e,t,r){super(e,"AuthWeakPasswordError",t),this.reasons=r}}var Cf=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t};const Et=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),If=[502,503,504];async function Ta(n){if(!wf(n))throw new Ks(Et(n),0);if(If.includes(n.status))throw new Ks(Et(n),n.status);let e;try{e=await n.json()}catch(t){throw new Ko(Et(t),t)}throw typeof e=="object"&&e&&typeof e.weak_password=="object"&&e.weak_password&&Array.isArray(e.weak_password.reasons)&&e.weak_password.reasons.length&&e.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)?new Sf(Et(e),n.status,e.weak_password.reasons):new Pf(Et(e),n.status||500)}const Rf=(n,e,t,r)=>{const s={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};async function j(n,e,t,r){var s;const i=Object.assign({},r==null?void 0:r.headers);r!=null&&r.jwt&&(i.Authorization=`Bearer ${r.jwt}`);const a=(s=r==null?void 0:r.query)!==null&&s!==void 0?s:{};r!=null&&r.redirectTo&&(a.redirect_to=r.redirectTo);const o=Object.keys(a).length?"?"+new URLSearchParams(a).toString():"",c=await jf(n,e,t+o,{headers:i,noResolveJson:r==null?void 0:r.noResolveJson},{},r==null?void 0:r.body);return r!=null&&r.xform?r==null?void 0:r.xform(c):{data:Object.assign({},c),error:null}}async function jf(n,e,t,r,s,i){const a=Rf(e,r,s,i);let o;try{o=await n(t,a)}catch(c){throw console.error(c),new Ks(Et(c),0)}if(o.ok||await Ta(o),r!=null&&r.noResolveJson)return o;try{return await o.json()}catch(c){await Ta(c)}}function tt(n){var e;let t=null;Uf(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=_f(n.expires_in)));const r=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:r},error:null}}function Sa(n){const e=tt(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=n.weak_password),e}function He(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function $f(n){return{data:n,error:null}}function Nf(n){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i}=n,a=Cf(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i},c=Object.assign({},a);return{data:{properties:o,user:c},error:null}}function Lf(n){return n}function Uf(n){return n.access_token&&n.refresh_token&&n.expires_in}var Df=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t};class Mf{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=Jo(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t="global"){try{return await j(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(R(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await j(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:He})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=Df(e,["options"]),s=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(s.new_email=r==null?void 0:r.newEmail,delete s.newEmail),await j(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:Nf,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(R(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await j(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:He})}catch(t){if(R(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,s,i,a,o,c;try{const u={nextPage:null,lastPage:0,total:0},l=await j(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(s=e==null?void 0:e.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:Lf});if(l.error)throw l.error;const h=await l.json(),d=(a=l.headers.get("x-total-count"))!==null&&a!==void 0?a:0,f=(c=(o=l.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&c!==void 0?c:[];return f.length>0&&(f.forEach(p=>{const g=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),m=JSON.parse(p.split(";")[1].split("=")[1]);u[`${m}Page`]=g}),u.total=parseInt(d)),{data:Object.assign(Object.assign({},h),u),error:null}}catch(u){if(R(u))return{data:{users:[]},error:u};throw u}}async getUserById(e){try{return await j(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:He})}catch(t){if(R(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){try{return await j(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:He})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){try{return await j(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:He})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){try{const{data:t,error:r}=await j(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:r}}catch(t){if(R(t))return{data:null,error:t};throw t}}async _deleteFactor(e){try{return{data:await j(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}}}const Go="0.0.0",Bf="http://localhost:9999",Ff="supabase.auth.token",zf={"X-Client-Info":`gotrue-js/${Go}`},Ca=10,qf={getItem:n=>nr()?globalThis.localStorage.getItem(n):null,setItem:(n,e)=>{nr()&&globalThis.localStorage.setItem(n,e)},removeItem:n=>{nr()&&globalThis.localStorage.removeItem(n)}};function Ia(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}function Vf(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const bt={debug:!!(globalThis&&nr()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class Wo extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Hf extends Wo{}async function Zf(n,e,t){bt.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),bt.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async s=>{if(s){bt.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,s.name);try{return await t()}finally{bt.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,s.name)}}else{if(e===0)throw bt.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new Hf(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(bt.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}})}Vf();const Jf={url:Bf,storageKey:Ff,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:zf,flowType:"implicit",debug:!1},Vt=30*1e3,Ra=3;async function ja(n,e,t){return await t()}class mr{constructor(e){var t,r;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=mr.nextInstanceID,mr.nextInstanceID+=1,this.instanceID>0&&ye()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const s=Object.assign(Object.assign({},Jf),e);if(this.logDebugMessages=!!s.debug,typeof s.debug=="function"&&(this.logger=s.debug),this.persistSession=s.persistSession,this.storageKey=s.storageKey,this.autoRefreshToken=s.autoRefreshToken,this.admin=new Mf({url:s.url,headers:s.headers,fetch:s.fetch}),this.url=s.url,this.headers=s.headers,this.fetch=Jo(s.fetch),this.lock=s.lock||ja,this.detectSessionInUrl=s.detectSessionInUrl,this.flowType=s.flowType,s.lock?this.lock=s.lock:ye()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=Zf:this.lock=ja,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?s.storage?this.storage=s.storage:nr()?this.storage=qf:(this.memoryStorage={},this.storage=Ia(this.memoryStorage)):(this.memoryStorage={},this.storage=Ia(this.memoryStorage)),ye()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(r=this.broadcastChannel)===null||r===void 0||r.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i),await this._notifyAllSubscribers(i.data.event,i.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${Go}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){try{const e=ye()?await this._isPKCEFlow():!1;if(this._debug("#_initialize()","begin","is PKCE flow",e),e||this.detectSessionInUrl&&this._isImplicitGrantFlow()){const{data:t,error:r}=await this._getSessionFromURL(e);if(r)return this._debug("#_initialize()","error detecting session from URL",r),(r==null?void 0:r.message)==="Identity is already linked"||(r==null?void 0:r.message)==="Identity is already linked to another user"?{error:r}:(await this._removeSession(),{error:r});const{session:s,redirectType:i}=t;return this._debug("#_initialize()","detected session in URL",s,"redirect type",i),await this._saveSession(s),setTimeout(async()=>{i==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",s):await this._notifyAllSubscribers("SIGNED_IN",s)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(e){return R(e)?{error:e}:{error:new Ko("Unexpected error during initialization",e)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signUp(e){var t,r,s;try{await this._removeSession();let i;if("email"in e){const{email:l,password:h,options:d}=e;let f=null,p=null;if(this.flowType==="pkce"){const g=gt();await et(this.storage,`${this.storageKey}-code-verifier`,g),f=await yt(g),p=g===f?"plain":"s256"}i=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:d==null?void 0:d.emailRedirectTo,body:{email:l,password:h,data:(t=d==null?void 0:d.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:d==null?void 0:d.captchaToken},code_challenge:f,code_challenge_method:p},xform:tt})}else if("phone"in e){const{phone:l,password:h,options:d}=e;i=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:l,password:h,data:(r=d==null?void 0:d.data)!==null&&r!==void 0?r:{},channel:(s=d==null?void 0:d.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:d==null?void 0:d.captchaToken}},xform:tt})}else throw new Tr("You must provide either an email or phone number and a password");const{data:a,error:o}=i;if(o||!a)return{data:{user:null,session:null},error:o};const c=a.session,u=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",c)),{data:{user:u,session:c},error:null}}catch(i){if(R(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithPassword(e){try{await this._removeSession();let t;if("email"in e){const{email:i,password:a,options:o}=e;t=await j(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:Sa})}else if("phone"in e){const{phone:i,password:a,options:o}=e;t=await j(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:Sa})}else throw new Tr("You must provide either an email or phone number and a password");const{data:r,error:s}=t;return s?{data:{user:null,session:null},error:s}:!r||!r.session||!r.user?{data:{user:null,session:null},error:new ls}:(r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),{data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:s})}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,r,s,i;return await this._removeSession(),await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async _exchangeCodeForSession(e){const t=await Pr(this.storage,`${this.storageKey}-code-verifier`),[r,s]=(t??"").split("/"),{data:i,error:a}=await j(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:tt});return await us(this.storage,`${this.storageKey}-code-verifier`),a?{data:{user:null,session:null,redirectType:null},error:a}:!i||!i.session||!i.user?{data:{user:null,session:null,redirectType:null},error:new ls}:(i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),{data:Object.assign(Object.assign({},i),{redirectType:s??null}),error:a})}async signInWithIdToken(e){await this._removeSession();try{const{options:t,provider:r,token:s,access_token:i,nonce:a}=e,o=await j(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:s,access_token:i,nonce:a,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:tt}),{data:c,error:u}=o;return u?{data:{user:null,session:null},error:u}:!c||!c.session||!c.user?{data:{user:null,session:null},error:new ls}:(c.session&&(await this._saveSession(c.session),await this._notifyAllSubscribers("SIGNED_IN",c.session)),{data:c,error:u})}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,r,s,i,a;try{if(await this._removeSession(),"email"in e){const{email:o,options:c}=e;let u=null,l=null;if(this.flowType==="pkce"){const d=gt();await et(this.storage,`${this.storageKey}-code-verifier`,d),u=await yt(d),l=d===u?"plain":"s256"}const{error:h}=await j(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(t=c==null?void 0:c.data)!==null&&t!==void 0?t:{},create_user:(r=c==null?void 0:c.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},code_challenge:u,code_challenge_method:l},redirectTo:c==null?void 0:c.emailRedirectTo});return{data:{user:null,session:null},error:h}}if("phone"in e){const{phone:o,options:c}=e,{data:u,error:l}=await j(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(s=c==null?void 0:c.data)!==null&&s!==void 0?s:{},create_user:(i=c==null?void 0:c.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},channel:(a=c==null?void 0:c.channel)!==null&&a!==void 0?a:"sms"}});return{data:{user:null,session:null,messageId:u==null?void 0:u.message_id},error:l}}throw new Tr("You must provide either an email or phone number.")}catch(o){if(R(o))return{data:{user:null,session:null},error:o};throw o}}async verifyOtp(e){var t,r;try{e.type!=="email_change"&&e.type!=="phone_change"&&await this._removeSession();let s,i;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:a,error:o}=await j(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:s,xform:tt});if(o)throw o;if(!a)throw new Error("An error occurred on token verification.");const c=a.session,u=a.user;return c!=null&&c.access_token&&(await this._saveSession(c),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",c)),{data:{user:u,session:c},error:null}}catch(s){if(R(s))return{data:{user:null,session:null},error:s};throw s}}async signInWithSSO(e){var t,r,s;try{await this._removeSession();let i=null,a=null;if(this.flowType==="pkce"){const o=gt();await et(this.storage,`${this.storageKey}-code-verifier`,o),i=await yt(o),a=o===i?"plain":"s256"}return await j(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((s=e==null?void 0:e.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:a}),headers:this.headers,xform:$f})}catch(i){if(R(i))return{data:null,error:i};throw i}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new _t;const{error:s}=await j(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:s}})}catch(e){if(R(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{e.type!="email_change"&&e.type!="phone_change"&&await this._removeSession();const t=`${this.url}/resend`;if("email"in e){const{email:r,type:s,options:i}=e,{error:a}=await j(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},redirectTo:i==null?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:a}}else if("phone"in e){const{phone:r,type:s,options:i}=e,{data:a,error:o}=await j(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return{data:{user:null,session:null,messageId:a==null?void 0:a.message_id},error:o}}throw new Tr("You must provide either an email or phone number and a type")}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,this._acquireLock(-1,async()=>this._useSession(async e=>e))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await Pr(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at<=Date.now()/1e3:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r)return{data:{session:e},error:null};const{session:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:s},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await j(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:He}):await this._useSession(async t=>{var r,s;const{data:i,error:a}=t;if(a)throw a;return await j(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0,xform:He})})}catch(t){if(R(t))return{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:s,error:i}=r;if(i)throw i;if(!s.session)throw new _t;const a=s.session;let o=null,c=null;if(this.flowType==="pkce"&&e.email!=null){const h=gt();await et(this.storage,`${this.storageKey}-code-verifier`,h),o=await yt(h),c=h===o?"plain":"s256"}const{data:u,error:l}=await j(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:c}),jwt:a.access_token,xform:He});if(l)throw l;return a.user=u.user,await this._saveSession(a),await this._notifyAllSubscribers("USER_UPDATED",a),{data:{user:a.user},error:null}})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}_decodeJWT(e){return xa(e)}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new _t;const t=Date.now()/1e3;let r=t,s=!0,i=null;const a=xa(e.access_token);if(a.exp&&(r=a.exp,s=r<=t),s){const{session:o,error:c}=await this._callRefreshToken(e.refresh_token);if(c)return{data:{user:null,session:null},error:c};if(!o)return{data:{user:null,session:null},error:null};i=o}else{const{data:o,error:c}=await this._getUser(e.access_token);if(c)throw c;i={access_token:e.access_token,refresh_token:e.refresh_token,user:o.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(t){if(R(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:a,error:o}=t;if(o)throw o;e=(r=a.session)!==null&&r!==void 0?r:void 0}if(!(e!=null&&e.refresh_token))throw new _t;const{session:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{user:null,session:null},error:i}:s?{data:{user:s.user,session:s},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e){try{if(!ye())throw new Sr("No browser detected.");if(this.flowType==="implicit"&&!this._isImplicitGrantFlow())throw new Sr("Not a valid implicit grant flow url.");if(this.flowType=="pkce"&&!e)throw new Pa("Not a valid PKCE flow url.");const t=cs(window.location.href);if(e){if(!t.code)throw new Pa("No code detected.");const{data:A,error:k}=await this._exchangeCodeForSession(t.code);if(k)throw k;const x=new URL(window.location.href);return x.searchParams.delete("code"),window.history.replaceState(window.history.state,"",x.toString()),{data:{session:A.session,redirectType:null},error:null}}if(t.error||t.error_description||t.error_code)throw new Sr(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});const{provider_token:r,provider_refresh_token:s,access_token:i,refresh_token:a,expires_in:o,expires_at:c,token_type:u}=t;if(!i||!o||!a||!u)throw new Sr("No session defined in URL");const l=Math.round(Date.now()/1e3),h=parseInt(o);let d=l+h;c&&(d=parseInt(c));const f=d-l;f*1e3<=Vt&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${h}s`);const p=d-h;l-p>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",p,d,l):l-p<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clok for skew",p,d,l);const{data:g,error:m}=await this._getUser(i);if(m)throw m;const b={provider_token:r,provider_refresh_token:s,access_token:i,expires_in:h,expires_at:d,refresh_token:a,token_type:u,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:b,redirectType:t.type},error:null}}catch(t){if(R(t))return{data:{session:null,redirectType:null},error:t};throw t}}_isImplicitGrantFlow(){const e=cs(window.location.href);return!!(ye()&&(e.access_token||e.error_description))}async _isPKCEFlow(){const e=cs(window.location.href),t=await Pr(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return{error:i};const a=(r=s.session)===null||r===void 0?void 0:r.access_token;if(a){const{error:o}=await this.admin.signOut(a,e);if(o&&!(Tf(o)&&(o.status===404||o.status===401)))return{error:o}}return e!=="others"&&(await this._removeSession(),await us(this.storage,`${this.storageKey}-code-verifier`),await this._notifyAllSubscribers("SIGNED_OUT",null)),{error:null}})}onAuthStateChange(e){const t=bf(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,s;try{const{data:{session:i},error:a}=t;if(a)throw a;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let r=null,s=null;if(this.flowType==="pkce"){const i=gt();await et(this.storage,`${this.storageKey}-code-verifier`,`${i}/PASSWORD_RECOVERY`),r=await yt(i),s=i===r?"plain":"s256"}try{return await j(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(R(i))return{data:null,error:i};throw i}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:r,error:s}=await this._useSession(async i=>{var a,o,c,u,l;const{data:h,error:d}=i;if(d)throw d;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(a=e.options)===null||a===void 0?void 0:a.redirectTo,scopes:(o=e.options)===null||o===void 0?void 0:o.scopes,queryParams:(c=e.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:!0});return await j(this.fetch,"GET",f,{headers:this.headers,jwt:(l=(u=h.session)===null||u===void 0?void 0:u.access_token)!==null&&l!==void 0?l:void 0})});if(s)throw s;return ye()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r==null?void 0:r.url),{data:{provider:e.provider,url:r==null?void 0:r.url},error:null}}catch(r){if(R(r))return{data:{provider:e.provider,url:null},error:r};throw r}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:a}=t;if(a)throw a;return await j(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if(R(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await kf(async s=>(await Af(s*200),this._debug(t,"refreshing attempt",s),await j(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:tt})),(s,i,a)=>a&&a.error&&hs(a.error)&&Date.now()+(s+1)*200-r<Vt)}catch(r){if(this._debug(t,"error",r),R(r))return{data:{session:null,user:null},error:r};throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),ye()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const r=await Pr(this.storage,this.storageKey);if(this._debug(t,"session from storage",r),!this._isValidSession(r)){this._debug(t,"session is not valid"),r!==null&&await this._removeSession();return}const s=Math.round(Date.now()/1e3),i=((e=r.expires_at)!==null&&e!==void 0?e:1/0)<s+Ca;if(this._debug(t,`session has${i?"":" not"} expired with margin of ${Ca}s`),i){if(this.autoRefreshToken&&r.refresh_token){const{error:a}=await this._callRefreshToken(r.refresh_token);a&&(console.error(a),hs(a)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",a),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",r)}catch(r){this._debug(t,"error",r),console.error(r);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new _t;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new Mn;const{data:i,error:a}=await this._refreshAccessToken(e);if(a)throw a;if(!i.session)throw new _t;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const o={session:i.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(i){if(this._debug(s,"error",i),R(i)){const a={session:null,error:i};return hs(i)||(await this._removeSession(),await this._notifyAllSubscribers("SIGNED_OUT",null)),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(a),a}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(i),i}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,r=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],a=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(e,t)}catch(c){i.push(c)}});if(await Promise.all(a),i.length>0){for(let o=0;o<i.length;o+=1)console.error(i[o]);throw i[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),await et(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await us(this.storage,this.storageKey)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&ye()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Vt);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((r.expires_at*1e3-e)/Vt);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${Vt}ms, refresh threshold is ${Ra} ticks`),s<=Ra&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof Wo)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ye()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const s=[`provider=${encodeURIComponent(t)}`];if(r!=null&&r.redirectTo&&s.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r!=null&&r.scopes&&s.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const i=gt();await et(this.storage,`${this.storageKey}-code-verifier`,i);const a=await yt(i),o=i===a?"plain":"s256";this._debug("PKCE","code verifier",`${i.substring(0,5)}...`,"code challenge",a,"method",o);const c=new URLSearchParams({code_challenge:`${encodeURIComponent(a)}`,code_challenge_method:`${encodeURIComponent(o)}`});s.push(c.toString())}if(r!=null&&r.queryParams){const i=new URLSearchParams(r.queryParams);s.push(i.toString())}return r!=null&&r.skipBrowserRedirect&&s.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?{data:null,error:i}:await j(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(R(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:a}=t;if(a)return{data:null,error:a};const{data:o,error:c}=await j(this.fetch,"POST",`${this.url}/factors`,{body:{friendly_name:e.friendlyName,factor_type:e.factorType,issuer:e.issuer},headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});return c?{data:null,error:c}:(!((s=o==null?void 0:o.totp)===null||s===void 0)&&s.qr_code&&(o.totp.qr_code=`data:image/svg+xml;utf-8,${o.totp.qr_code}`),{data:o,error:null})})}catch(t){if(R(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return{data:null,error:i};const{data:a,error:o}=await j(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token});return o?{data:null,error:o}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),{data:a,error:o})})}catch(t){if(R(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?{data:null,error:i}:await j(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(R(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?{data:null,error:r}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const r=(e==null?void 0:e.factors)||[],s=r.filter(i=>i.factor_type==="totp"&&i.status==="verified");return{data:{all:r,totp:s},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,r;const{data:{session:s},error:i}=e;if(i)return{data:null,error:i};if(!s)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const a=this._decodeJWT(s.access_token);let o=null;a.aal&&(o=a.aal);let c=o;((r=(t=s.user.factors)===null||t===void 0?void 0:t.filter(h=>h.status==="verified"))!==null&&r!==void 0?r:[]).length>0&&(c="aal2");const l=a.amr||[];return{data:{currentLevel:o,nextLevel:c,currentAuthenticationMethods:l},error:null}}))}}mr.nextInstanceID=0;class Kf extends mr{constructor(e){super(e)}}var Gf=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(l){try{u(r.next(l))}catch(h){a(h)}}function c(l){try{u(r.throw(l))}catch(h){a(h)}}function u(l){l.done?i(l.value):s(l.value).then(o,c)}u((r=r.apply(n,e||[])).next())})};class Wf{constructor(e,t,r){var s,i,a,o,c,u,l,h;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const d=gf(e);this.realtimeUrl=`${d}/realtime/v1`.replace(/^http/i,"ws"),this.authUrl=`${d}/auth/v1`,this.storageUrl=`${d}/storage/v1`,this.functionsUrl=`${d}/functions/v1`;const f=`sb-${new URL(this.authUrl).hostname.split(".")[0]}-auth-token`,p={db:uf,realtime:hf,auth:Object.assign(Object.assign({},lf),{storageKey:f}),global:cf},g=yf(r??{},p);this.storageKey=(i=(s=g.auth)===null||s===void 0?void 0:s.storageKey)!==null&&i!==void 0?i:"",this.headers=(o=(a=g.global)===null||a===void 0?void 0:a.headers)!==null&&o!==void 0?o:{},this.auth=this._initSupabaseAuthClient((c=g.auth)!==null&&c!==void 0?c:{},this.headers,(u=g.global)===null||u===void 0?void 0:u.fetch),this.fetch=mf(t,this._getAccessToken.bind(this),(l=g.global)===null||l===void 0?void 0:l.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers},g.realtime)),this.rest=new Pi(`${d}/rest/v1`,{headers:this.headers,schema:(h=g.db)===null||h===void 0?void 0:h.schema,fetch:this.fetch}),this._listenForAuthEvents()}get functions(){return new vd(this.functionsUrl,{headers:this.headers,customFetch:this.fetch})}get storage(){return new sf(this.storageUrl,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},r={}){return this.rest.rpc(e,t,r)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return Gf(this,void 0,void 0,function*(){const{data:r}=yield this.auth.getSession();return(t=(e=r.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,storageKey:i,flowType:a,debug:o},c,u){const l={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Kf({url:this.authUrl,headers:Object.assign(Object.assign({},l),c),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,flowType:a,debug:o,fetch:u})}_initRealtimeClient(e){return new Hd(this.realtimeUrl,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,r)=>{this._handleTokenChanged(t,"CLIENT",r==null?void 0:r.access_token)})}_handleTokenChanged(e,t,r){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==r?(this.realtime.setAuth(r??null),this.changedAccessToken=r):e==="SIGNED_OUT"&&(this.realtime.setAuth(this.supabaseKey),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const Qf=(n,e,t)=>new Wf(n,e,t);var Ii={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};document.addEventListener("DOMContentLoaded",()=>{const n=localStorage.getItem("conversation"),e=document.getElementById("chatbot-conversation-container");let t=parseInt(rc("interactionCount"))||0;function r(){return"user-"+ve()}n&&(e.innerHTML=n,ec(e)),document.addEventListener("submit",async s=>{if(s.preventDefault(),t<3){await ap(),t++,nc("interactionCount",t,1);const i=r();await Xf(i)}else tc()})});async function Xf(n){try{if(!(await fetch("/interactions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n})})).ok)throw new Error("Failed to update interaction count")}catch(e){console.error("Error updating interaction count:",e)}}const Qo=Ii.VITE_SUPAB_API_KEY,Xo=Ii.VITE_SUPA_URL,Ri=Ii.VITE_OPEN_AI_API_KEY;console.log("keys: ",Qo,Xo,Ri);const Yf=Qf(Xo,Qo),Yo=new ed({openAIApiKey:Ri}),ep="Given a question, convert it in a standalonequestion. question: {question} standalone question:",tp=Je.fromTemplate(ep),rp=`You are Elder Bot, a helpful and enthusiastic missionary bot dedicated to answering questions about the Book of Mormon. Your responses are based solely on the provided context of the Book of Mormon. If you're unable to find a direct answer, kindly direct the questioner to further explore the teachings of the Book of Mormon at https://www.churchofjesuschrist.org/comeuntochrist/ps/book-of-mormon-lesson. Always cite appropriate verses and chapters when providing answers.

Please note that your responses are limited to questions related to the Book of Mormon. If the question is outside of this context, kindly inform the user that it is beyond your scope of knowledge.

Context: {context}
Question: {question}
Answer:
`,np=Je.fromTemplate(rp),sp=tp.pipe(Yo).pipe(new No),ip=np.pipe(Yo).pipe(new No);function ec(n){n.scrollTop=n.scrollHeight}async function ap(){const n=document.getElementById("user-input"),e=document.getElementById("chatbot-conversation-container");document.getElementById("typing-indicator-container");const t=n.value;n.value="";const r=document.createElement("div");r.classList.add("speech","speech-human"),e.appendChild(r),r.textContent=t,e.scrollTop=e.scrollHeight;let s=parseInt(rc("interactionCount"))||0;if(s>=3){tc();return}s++,nc("interactionCount",s,1);const i=await dp.invoke({question:t}),a=document.createElement("div");a.classList.add("speech","speech-ai"),e.appendChild(a),a.textContent=i,e.scrollTop=e.scrollHeight,ec(e),localStorage.setItem("conversation",e.innerHTML)}function tc(){const n=document.getElementById("chatbot-conversation-container"),e=document.createElement("div");e.textContent="You have reached the maximum number of interactions for today. Please contact thechurchofjesuschrist.org for a better conversion",e.classList.add("speech","speech-ai"),n.appendChild(e),n.scrollTop=n.scrollHeight}function rc(n){const t=`; ${document.cookie}`.split(`; ${n}=`);if(t.length===2)return t.pop().split(";").shift()}function nc(n,e,t){const r=new Date;r.setTime(r.getTime()+t*24*60*60*1e3);const s="expires="+r.toUTCString();document.cookie=n+"="+e+";"+s+";path=/"}const op=new sd({openAIApiKey:Ri}),cp=new Ei(op,{client:Yf,tableName:"documents",queryName:"match_documents"}),up=cp.asRetriever();function lp(n){return n.map(e=>e.pageContent).join(`

`)}const hp=Ie.from([n=>n.standalone_question,up,lp]),dp=Ie.from([{standalone_question:sp,original_input:new zs},{context:hp,question:({original_input:n})=>n.question},ip]);export{od as B,au as C,Je as P,cd as a,dd as c,pi as g,Wt as r};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
