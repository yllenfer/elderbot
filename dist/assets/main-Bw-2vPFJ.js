var Fs=Object.defineProperty;var Hs=(n,e,t)=>e in n?Fs(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var se=(n,e,t)=>(Hs(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const Ee="4.28.4";let hn=!1,De,Fn,Hn,mr,Vn,zn,qn,Gn,Kn;function Vs(n,e={auto:!1}){if(hn)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(De)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${De}'\``);hn=e.auto,De=n.kind,Fn=n.fetch,n.Request,n.Response,n.Headers,Hn=n.FormData,n.Blob,mr=n.File,Vn=n.ReadableStream,zn=n.getMultipartRequestOptions,qn=n.getDefaultAgent,Gn=n.fileFromPath,Kn=n.isFsReadStream}class zs{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function qs({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,r,s,i;try{t=fetch,r=Request,s=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:s,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new zs(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}De||Vs(qs(),{auto:!0});let E=class extends Error{},F=class gr extends E{constructor(e,t,r,s){super(`${gr.makeMessage(e,t,r)}`),this.status=e,this.headers=s;const i=t;this.error=i,this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,t,r){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e)return new Ge({cause:br(t)});const i=t==null?void 0:t.error;return e===400?new Nr(e,i,r,s):e===401?new jr(e,i,r,s):e===403?new kr(e,i,r,s):e===404?new Lr(e,i,r,s):e===409?new Dr(e,i,r,s):e===422?new Br(e,i,r,s):e===429?new Ur(e,i,r,s):e>=500?new Mr(e,i,r,s):new gr(e,i,r,s)}},de=class extends F{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},Ge=class extends F{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},Ft=class extends Ge{constructor({message:e}={}){super({message:e??"Request timed out."})}},Nr=class extends F{constructor(){super(...arguments),this.status=400}},jr=class extends F{constructor(){super(...arguments),this.status=401}},kr=class extends F{constructor(){super(...arguments),this.status=403}},Lr=class extends F{constructor(){super(...arguments),this.status=404}},Dr=class extends F{constructor(){super(...arguments),this.status=409}},Br=class extends F{constructor(){super(...arguments),this.status=422}},Ur=class extends F{constructor(){super(...arguments),this.status=429}},Mr=class extends F{};const Gs=Object.freeze(Object.defineProperty({__proto__:null,APIConnectionError:Ge,APIConnectionTimeoutError:Ft,APIError:F,APIUserAbortError:de,AuthenticationError:jr,BadRequestError:Nr,ConflictError:Dr,InternalServerError:Mr,NotFoundError:Lr,OpenAIError:E,PermissionDeniedError:kr,RateLimitError:Ur,UnprocessableEntityError:Br},Symbol.toStringTag,{value:"Module"}));class ce{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;const s=new Ks;async function*i(){if(!e.body)throw t.abort(),new E("Attempted to iterate over a response with no body");const o=new we,u=dn(e.body);for await(const c of u)for(const l of o.decode(c)){const h=s.decode(l);h&&(yield h)}for(const c of o.flush()){const l=s.decode(c);l&&(yield l)}}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const u of i())if(!o){if(u.data.startsWith("[DONE]")){o=!0;continue}if(u.event===null){let c;try{c=JSON.parse(u.data)}catch(l){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),l}if(c&&c.error)throw new F(void 0,c.error,void 0,void 0);yield c}}o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||t.abort()}}return new ce(a,t)}static fromReadableStream(e,t){let r=!1;async function*s(){const a=new we,o=dn(e);for await(const u of o)for(const c of a.decode(u))yield c;for(const u of a.flush())yield u}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new ce(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new ce(()=>s(e),this.controller),new ce(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new Vn({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:i,done:a}=await t.next();if(a)return s.close();const o=r.encode(JSON.stringify(i)+`
`);s.enqueue(o)}catch(i){s.error(i)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}}class Ks{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=Js(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}class we{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const r=we.NEWLINE_CHARS.has(t[t.length-1]||"");let s=t.split(we.NEWLINE_REGEXP);return s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new E(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new E(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new E("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}we.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","","\u2028","\u2029"]);we.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function Js(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function dn(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const Jn=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",Ws=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Wn(n),Wn=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Qs=n=>Ws(n)||Jn(n)||Kn(n);async function Qn(n,e,t={}){var s;if(n=await n,Jn(n)){const i=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new mr([i],e,t)}const r=await Ys(n);if(e||(e=Zs(n)??"unknown_file"),!t.type){const i=(s=r[0])==null?void 0:s.type;typeof i=="string"&&(t={...t,type:i})}return new mr(r,e,t)}async function Ys(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Wn(n))e.push(await n.arrayBuffer());else if(ei(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${Xs(n)}`);return e}function Xs(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function Zs(n){var e;return Qt(n.name)||Qt(n.filename)||((e=Qt(n.path))==null?void 0:e.split(/[\\/]/).pop())}const Qt=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},ei=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",fn=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",Fe=async n=>{const e=await ti(n.body);return zn(e,n)},ti=async n=>{const e=new Hn;return await Promise.all(Object.entries(n||{}).map(([t,r])=>yr(e,t,r))),e},yr=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(Qs(t)){const r=await Qn(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>yr(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>yr(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var tt={},ri=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},ni=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Qe;async function Yn(n){const{response:e}=n;if(n.options.stream)return Ce("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):ce.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){const i=await e.json();return Ce("response",e.status,e.url,e.headers,i),i}const s=await e.text();return Ce("response",e.status,e.url,e.headers,s),s}class Ht extends Promise{constructor(e,t=Yn){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Ht(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class si{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:s,fetch:i}){this.baseURL=e,this.maxRetries=Yt("maxRetries",t),this.timeout=Yt("timeout",r),this.httpAgent=s,this.fetch=i??Fn}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...li(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${pi()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:t,...s})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){var f;const{method:t,path:r,query:s,headers:i={}}=e,a=fn(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(a),u=this.buildURL(r,s);"timeout"in e&&Yt("timeout",e.timeout);const c=e.timeout??this.timeout,l=e.httpAgent??this.httpAgent??qn(u),h=c+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&h>(l.options.timeout??0)&&(l.options.timeout=h),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const d=this.buildHeaders({options:e,headers:i,contentLength:o});return{req:{method:t,...a&&{body:a},headers:d,...l&&{agent:l},signal:e.signal??null},url:u,timeout:c}}buildHeaders({options:e,headers:t,contentLength:r}){const s={};r&&(s["content-length"]=r);const i=this.defaultHeaders(e);return yn(s,i),yn(s,t),fn(e.body)&&De!=="node"&&delete s["content-type"],this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,s){return F.generate(e,t,r,s)}request(e,t=null){return new Ht(this.makeRequest(e,t))}async makeRequest(e,t){var l,h;const r=await e;t==null&&(t=r.maxRetries??this.maxRetries),await this.prepareOptions(r);const{req:s,url:i,timeout:a}=this.buildRequest(r);if(await this.prepareRequest(s,{url:i,options:r}),Ce("request",i,r,s.headers),(l=r.signal)!=null&&l.aborted)throw new de;const o=new AbortController,u=await this.fetchWithTimeout(i,s,a,o).catch(br);if(u instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new de;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new Ft:new Ge({cause:u})}const c=ai(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){const w=`retrying, ${t} attempts remaining`;return Ce(`response (error; ${w})`,u.status,i,c),this.retryRequest(r,t,c)}const d=await u.text().catch(w=>br(w).message),p=hi(d),f=p?void 0:d;throw Ce(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,i,c,f),this.makeStatusError(u.status,p,f,c)}return{response:u,options:r,controller:o}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new ii(this,r,e)}buildURL(e,t){const r=fi(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return es(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new E(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,s){const{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...a}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let s;const i=r==null?void 0:r["retry-after-ms"];if(i){const o=parseFloat(i);Number.isNaN(o)||(s=o)}const a=r==null?void 0:r["retry-after"];if(a&&!s){const o=parseFloat(a);Number.isNaN(o)?s=Date.parse(a)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Zn(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ee}`}}class Xn{constructor(e,t,r,s){Qe.set(this,void 0),ri(this,Qe,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new E("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[s,i]of r)e.url.searchParams.set(s,i);t.query=void 0,t.path=e.url.toString()}return await ni(this,Qe,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Qe=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class ii extends Ht{constructor(e,t,r){super(t,async s=>new r(e,s.response,await Yn(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const ai=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),oi={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},X=n=>typeof n=="object"&&n!==null&&!es(n)&&Object.keys(n).every(e=>ts(oi,e)),ui=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ee,"X-Stainless-OS":mn(Deno.build.os),"X-Stainless-Arch":pn(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ee,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ee,"X-Stainless-OS":mn(process.platform),"X-Stainless-Arch":pn(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=ci();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ee,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ee,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function ci(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const pn=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",mn=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let gn;const li=()=>gn??(gn=ui()),hi=n=>{try{return JSON.parse(n)}catch{return}},di=new RegExp("^(?:[a-z]+:)?//","i"),fi=n=>di.test(n),Zn=n=>new Promise(e=>setTimeout(e,n)),Yt=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new E(`${n} must be an integer`);if(e<0)throw new E(`${n} must be a positive integer`);return e},br=n=>n instanceof Error?n:new Error(n),Xt=n=>{var e,t,r,s;if(typeof process<"u")return((e=tt==null?void 0:tt[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(s=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:s.trim()};function es(n){if(!n)return!0;for(const e in n)return!1;return!0}function ts(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function yn(n,e){for(const t in e){if(!ts(e,t))continue;const r=t.toLowerCase();if(!r)continue;const s=e[t];s===null?delete n[r]:s!==void 0&&(n[r]=s)}}function Ce(n,...e){typeof process<"u"&&tt.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}const pi=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),mi=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";class Fr extends Xn{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class ne extends Xn{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}}class P{constructor(e){this._client=e}}let ot=class extends P{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}};ot||(ot={});let ut=class extends P{constructor(){super(...arguments),this.completions=new ot(this._client)}};(function(n){n.Completions=ot})(ut||(ut={}));class ct extends P{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}ct||(ct={});class lt extends P{create(e,t){return this._client.post("/audio/transcriptions",Fe({body:e,...t}))}}lt||(lt={});class ht extends P{create(e,t){return this._client.post("/audio/translations",Fe({body:e,...t}))}}ht||(ht={});class dt extends P{constructor(){super(...arguments),this.transcriptions=new lt(this._client),this.translations=new ht(this._client),this.speech=new ct(this._client)}}(function(n){n.Transcriptions=lt,n.Translations=ht,n.Speech=ct})(dt||(dt={}));let ft=class extends P{create(e,t,r){return this._client.post(`/assistants/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e,t={},r){return X(t)?this.list(e,{},t):this._client.getAPIList(`/assistants/${e}/files`,Hr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}};class Hr extends ne{}(function(n){n.AssistantFilesPage=Hr})(ft||(ft={}));class pt extends P{constructor(){super(...arguments),this.files=new ft(this._client)}create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e={},t){return X(e)?this.list({},e):this._client.getAPIList("/assistants",Vr,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}class Vr extends ne{}(function(n){n.AssistantsPage=Vr,n.Files=ft,n.AssistantFilesPage=Hr})(pt||(pt={}));function bn(n){return typeof n.parse=="function"}const Oe=n=>(n==null?void 0:n.role)==="assistant",rs=n=>(n==null?void 0:n.role)==="function",ns=n=>(n==null?void 0:n.role)==="tool";var G=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},_=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},L,rt,nt,$e,Ne,st,je,ee,ke,it,at,Ae,wr,mt,_r,vr,Er,Ar,ss,Pr;const wn=10;class is{constructor(){L.add(this),this.controller=new AbortController,rt.set(this,void 0),nt.set(this,()=>{}),$e.set(this,()=>{}),Ne.set(this,void 0),st.set(this,()=>{}),je.set(this,()=>{}),ee.set(this,{}),this._chatCompletions=[],this.messages=[],ke.set(this,!1),it.set(this,!1),at.set(this,!1),Ae.set(this,!1),Ar.set(this,e=>{if(G(this,it,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new de),e instanceof de)return G(this,at,!0,"f"),this._emit("abort",e);if(e instanceof E)return this._emit("error",e);if(e instanceof Error){const t=new E(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new E(String(e)))}),G(this,rt,new Promise((e,t)=>{G(this,nt,e,"f"),G(this,$e,t,"f")}),"f"),G(this,Ne,new Promise((e,t)=>{G(this,st,e,"f"),G(this,je,t,"f")}),"f"),_(this,rt,"f").catch(()=>{}),_(this,Ne,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},_(this,Ar,"f"))},0)}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(rs(e)||ns(e))&&e.content)this._emit("functionCallResult",e.content);else if(Oe(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Oe(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}_connected(){this.ended||(_(this,nt,"f").call(this),this._emit("connect"))}get ended(){return _(this,ke,"f")}get errored(){return _(this,it,"f")}get aborted(){return _(this,at,"f")}abort(){this.controller.abort()}on(e,t){return(_(this,ee,"f")[e]||(_(this,ee,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=_(this,ee,"f")[e];if(!r)return this;const s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(_(this,ee,"f")[e]||(_(this,ee,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{G(this,Ae,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){G(this,Ae,!0,"f"),await _(this,Ne,"f")}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new E("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),_(this,L,"m",wr).call(this)}async finalMessage(){return await this.done(),_(this,L,"m",mt).call(this)}async finalFunctionCall(){return await this.done(),_(this,L,"m",_r).call(this)}async finalFunctionCallResult(){return await this.done(),_(this,L,"m",vr).call(this)}async totalUsage(){return await this.done(),_(this,L,"m",Er).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(_(this,ke,"f"))return;e==="end"&&(G(this,ke,!0,"f"),_(this,st,"f").call(this));const r=_(this,ee,"f")[e];if(r&&(_(this,ee,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){const s=t[0];!_(this,Ae,"f")&&!(r!=null&&r.length)&&Promise.reject(s),_(this,$e,"f").call(this,s),_(this,je,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=t[0];!_(this,Ae,"f")&&!(r!=null&&r.length)&&Promise.reject(s),_(this,$e,"f").call(this,s),_(this,je,"f").call(this,s),this._emit("end")}}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=_(this,L,"m",mt).call(this);t&&this._emit("finalMessage",t);const r=_(this,L,"m",wr).call(this);r&&this._emit("finalContent",r);const s=_(this,L,"m",_r).call(this);s&&this._emit("finalFunctionCall",s);const i=_(this,L,"m",vr).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",_(this,L,"m",Er).call(this))}async _createChatCompletion(e,t,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),_(this,L,"m",ss).call(this,t);const i=await e.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(i)}async _runChatCompletion(e,t,r){for(const s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var d;const s="function",{function_call:i="auto",stream:a,...o}=t,u=typeof i!="string"&&(i==null?void 0:i.name),{maxChatCompletions:c=wn}=r||{},l={};for(const p of t.functions)l[p.name||p.function.name]=p;const h=t.functions.map(p=>({name:p.name||p.function.name,parameters:p.parameters,description:p.description}));for(const p of t.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){const v=(d=(await this._createChatCompletion(e,{...o,function_call:i,functions:h,messages:[...this.messages]},r)).choices[0])==null?void 0:d.message;if(!v)throw new E("missing message in ChatCompletion response");if(!v.function_call)return;const{name:m,arguments:w}=v.function_call,y=l[m];if(y){if(u&&u!==m){const S=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,name:m,content:S});continue}}else{const S=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${h.map(k=>JSON.stringify(k.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:m,content:S});continue}let g;try{g=bn(y)?await y.parse(w):w}catch(S){this._addMessage({role:s,name:m,content:S instanceof Error?S.message:String(S)});continue}const A=await y.function(g,this),b=_(this,L,"m",Pr).call(this,A);if(this._addMessage({role:s,name:m,content:b}),u)return}}async _runTools(e,t,r){var d,p;const s="tool",{tool_choice:i="auto",stream:a,...o}=t,u=typeof i!="string"&&((d=i==null?void 0:i.function)==null?void 0:d.name),{maxChatCompletions:c=wn}=r||{},l={};for(const f of t.tools)f.type==="function"&&(l[f.function.name||f.function.function.name]=f.function);const h="tools"in t?t.tools.map(f=>f.type==="function"?{type:"function",function:{name:f.function.name||f.function.function.name,parameters:f.function.parameters,description:f.function.description}}:f):void 0;for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){const m=(p=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:p.message;if(!m)throw new E("missing message in ChatCompletion response");if(!m.tool_calls)return;for(const w of m.tool_calls){if(w.type!=="function")continue;const y=w.id,{name:g,arguments:A}=w.function,b=l[g];if(b){if(u&&u!==g){const R=`Invalid tool_call: ${JSON.stringify(g)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,tool_call_id:y,content:R});continue}}else{const R=`Invalid tool_call: ${JSON.stringify(g)}. Available options are: ${h.map(Wt=>JSON.stringify(Wt.function.name)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:y,content:R});continue}let S;try{S=bn(b)?await b.parse(A):A}catch(R){const Wt=R instanceof Error?R.message:String(R);this._addMessage({role:s,tool_call_id:y,content:Wt});continue}const k=await b.function(S,this),_e=_(this,L,"m",Pr).call(this,k);if(this._addMessage({role:s,tool_call_id:y,content:_e}),u)return}}}}rt=new WeakMap,nt=new WeakMap,$e=new WeakMap,Ne=new WeakMap,st=new WeakMap,je=new WeakMap,ee=new WeakMap,ke=new WeakMap,it=new WeakMap,at=new WeakMap,Ae=new WeakMap,Ar=new WeakMap,L=new WeakSet,wr=function(){return _(this,L,"m",mt).call(this).content??null},mt=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Oe(t))return{...t,content:t.content??null}}throw new E("stream ended without producing a ChatCompletionMessage with role=assistant")},_r=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(Oe(s)&&(s!=null&&s.function_call))return s.function_call;if(Oe(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(t=s.tool_calls.at(-1))==null?void 0:t.function}},vr=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(rs(t)&&t.content!=null||ns(t)&&t.content!=null&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(i=>i.type==="function"&&i.id===t.tool_call_id))}))return t.content}},Er=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},ss=function(e){if(e.n!=null&&e.n>1)throw new E("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Pr=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class He extends is{static runFunctions(e,t,r){const s=new He,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,r){const s=new He,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}_addMessage(e){super._addMessage(e),Oe(e)&&e.content&&this._emit("content",e.content)}}var K=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Zt=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},W,ie,er,tr,Ye,_n;class Ve extends is{constructor(){super(...arguments),W.add(this),ie.set(this,void 0)}get currentChatCompletionSnapshot(){return K(this,ie,"f")}static fromReadableStream(e){const t=new Ve;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const s=new Ve;return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,r){var a;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),K(this,W,"m",er).call(this);const i=await e.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of i)K(this,W,"m",tr).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new de;return this._addChatCompletion(K(this,W,"m",Ye).call(this))}async _fromReadableStream(e,t){var a;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),K(this,W,"m",er).call(this),this._connected();const s=ce.fromReadableStream(e,this.controller);let i;for await(const o of s)i&&i!==o.id&&this._addChatCompletion(K(this,W,"m",Ye).call(this)),K(this,W,"m",tr).call(this,o),i=o.id;if((a=s.controller.signal)!=null&&a.aborted)throw new de;return this._addChatCompletion(K(this,W,"m",Ye).call(this))}[(ie=new WeakMap,W=new WeakSet,er=function(){this.ended||Zt(this,ie,void 0,"f")},tr=function(t){var a,o,u;if(this.ended)return;const r=K(this,W,"m",_n).call(this,t);this._emit("chunk",t,r);const s=(o=(a=t.choices[0])==null?void 0:a.delta)==null?void 0:o.content,i=(u=r.choices[0])==null?void 0:u.message;s!=null&&(i==null?void 0:i.role)==="assistant"&&(i!=null&&i.content)&&this._emit("content",s,i.content)},Ye=function(){if(this.ended)throw new E("stream has ended, this shouldn't happen");const t=K(this,ie,"f");if(!t)throw new E("request ended without sending any chunks");return Zt(this,ie,void 0,"f"),gi(t)},_n=function(t){var r,s,i;let a=K(this,ie,"f");const{choices:o,...u}=t;a?Object.assign(a,u):a=Zt(this,ie,{...u,choices:[]},"f");for(const{delta:c,finish_reason:l,index:h,logprobs:d=null,...p}of t.choices){let f=a.choices[h];if(f||(f=a.choices[h]={finish_reason:l,index:h,message:{},logprobs:d,...p}),d)if(!f.logprobs)f.logprobs=Object.assign({},d);else{const{content:A,...b}=d;Object.assign(f.logprobs,b),A&&((r=f.logprobs).content??(r.content=[]),f.logprobs.content.push(...A))}if(l&&(f.finish_reason=l),Object.assign(f,p),!c)continue;const{content:v,function_call:m,role:w,tool_calls:y,...g}=c;if(Object.assign(f.message,g),v&&(f.message.content=(f.message.content||"")+v),w&&(f.message.role=w),m&&(f.message.function_call?(m.name&&(f.message.function_call.name=m.name),m.arguments&&((s=f.message.function_call).arguments??(s.arguments=""),f.message.function_call.arguments+=m.arguments)):f.message.function_call=m),y){f.message.tool_calls||(f.message.tool_calls=[]);for(const{index:A,id:b,type:S,function:k,..._e}of y){const R=(i=f.message.tool_calls)[A]??(i[A]={});Object.assign(R,_e),b&&(R.id=b),S&&(R.type=S),k&&(R.function??(R.function={arguments:""})),k!=null&&k.name&&(R.function.name=k.name),k!=null&&k.arguments&&(R.function.arguments+=k.arguments)}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",s=>{const i=t.shift();i?i(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s(void 0);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise(i=>t.push(i)).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0})}}toReadableStream(){return new ce(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function gi(n){const{id:e,choices:t,created:r,model:s,system_fingerprint:i,...a}=n;return{...a,id:e,choices:t.map(({message:o,finish_reason:u,index:c,logprobs:l,...h})=>{if(!u)throw new E(`missing finish_reason for choice ${c}`);const{content:d=null,function_call:p,tool_calls:f,...v}=o,m=o.role;if(!m)throw new E(`missing role for choice ${c}`);if(p){const{arguments:w,name:y}=p;if(w==null)throw new E(`missing function_call.arguments for choice ${c}`);if(!y)throw new E(`missing function_call.name for choice ${c}`);return{...h,message:{content:d,function_call:{arguments:w,name:y},role:m},finish_reason:u,index:c,logprobs:l}}return f?{...h,index:c,finish_reason:u,logprobs:l,message:{...v,role:m,content:d,tool_calls:f.map((w,y)=>{const{function:g,type:A,id:b,...S}=w,{arguments:k,name:_e,...R}=g||{};if(b==null)throw new E(`missing choices[${c}].tool_calls[${y}].id
${Xe(n)}`);if(A==null)throw new E(`missing choices[${c}].tool_calls[${y}].type
${Xe(n)}`);if(_e==null)throw new E(`missing choices[${c}].tool_calls[${y}].function.name
${Xe(n)}`);if(k==null)throw new E(`missing choices[${c}].tool_calls[${y}].function.arguments
${Xe(n)}`);return{...S,id:b,type:A,function:{...R,name:_e,arguments:k}}})}}:{...h,message:{...v,content:d,role:m},finish_reason:u,index:c,logprobs:l}}),created:r,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}}}function Xe(n){return JSON.stringify(n)}class Ie extends Ve{static fromReadableStream(e){const t=new Ie;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const s=new Ie,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,r){const s=new Ie,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}}let as=class extends P{runFunctions(e,t){return e.stream?Ie.runFunctions(this._client.chat.completions,e,t):He.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?Ie.runTools(this._client.chat.completions,e,t):He.runTools(this._client.chat.completions,e,t)}stream(e,t){return Ve.createChatCompletion(this._client.chat.completions,e,t)}};class gt extends P{constructor(){super(...arguments),this.completions=new as(this._client)}}(function(n){n.Completions=as})(gt||(gt={}));let yt=class extends P{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/messages/${t}/files/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return X(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/messages/${t}/files`,zr,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}};class zr extends ne{}(function(n){n.MessageFilesPage=zr})(yt||(yt={}));class bt extends P{constructor(){super(...arguments),this.files=new yt(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return X(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,qr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}}class qr extends ne{}(function(n){n.ThreadMessagesPage=qr,n.Files=yt,n.MessageFilesPage=zr})(bt||(bt={}));class wt extends P{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return X(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Gr,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}}class Gr extends ne{}(function(n){n.RunStepsPage=Gr})(wt||(wt={}));class _t extends P{constructor(){super(...arguments),this.steps=new wt(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/runs`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return X(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Kr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}submitToolOutputs(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}}class Kr extends ne{}(function(n){n.RunsPage=Kr,n.Steps=wt,n.RunStepsPage=Gr})(_t||(_t={}));class vt extends P{constructor(){super(...arguments),this.runs=new _t(this._client),this.messages=new bt(this._client)}create(e={},t){return X(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}(function(n){n.Runs=_t,n.RunsPage=Kr,n.Messages=bt,n.ThreadMessagesPage=qr})(vt||(vt={}));class Et extends P{constructor(){super(...arguments),this.chat=new gt(this._client),this.assistants=new pt(this._client),this.threads=new vt(this._client)}}(function(n){n.Chat=gt,n.Assistants=pt,n.AssistantsPage=Vr,n.Threads=vt})(Et||(Et={}));class At extends P{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}At||(At={});let Pt=class extends P{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};Pt||(Pt={});class Ct extends P{create(e,t){return this._client.post("/files",Fe({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return X(e)?this.list({},e):this._client.getAPIList("/files",Jr,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Zn(t),a=await this.retrieve(e),Date.now()-i>r)throw new Ft({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return a}}class Jr extends Fr{}(function(n){n.FileObjectsPage=Jr})(Ct||(Ct={}));class Ot extends P{create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return X(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Wr,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return X(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Qr,{query:t,...r})}}class Wr extends ne{}class Qr extends ne{}(function(n){n.FineTuningJobsPage=Wr,n.FineTuningJobEventsPage=Qr})(Ot||(Ot={}));class It extends P{constructor(){super(...arguments),this.jobs=new Ot(this._client)}}(function(n){n.Jobs=Ot,n.FineTuningJobsPage=Wr,n.FineTuningJobEventsPage=Qr})(It||(It={}));class St extends P{createVariation(e,t){return this._client.post("/images/variations",Fe({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Fe({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}St||(St={});class Tt extends P{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Yr,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Yr extends Fr{}(function(n){n.ModelsPage=Yr})(Tt||(Tt={}));class Rt extends P{create(e,t){return this._client.post("/moderations",{body:e,...t})}}Rt||(Rt={});var os;let T=class extends si{constructor({baseURL:e=Xt("OPENAI_BASE_URL"),apiKey:t=Xt("OPENAI_API_KEY"),organization:r=Xt("OPENAI_ORG_ID")??null,...s}={}){if(t===void 0)throw new E("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&mi())throw new E(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new At(this),this.chat=new ut(this),this.embeddings=new Pt(this),this.files=new Ct(this),this.images=new St(this),this.audio=new dt(this),this.moderations=new Rt(this),this.models=new Tt(this),this.fineTuning=new It(this),this.beta=new Et(this),this._options=i,this.apiKey=t,this.organization=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};os=T;T.OpenAI=os;T.OpenAIError=E;T.APIError=F;T.APIConnectionError=Ge;T.APIConnectionTimeoutError=Ft;T.APIUserAbortError=de;T.NotFoundError=Lr;T.ConflictError=Dr;T.RateLimitError=Ur;T.BadRequestError=Nr;T.AuthenticationError=jr;T.InternalServerError=Mr;T.PermissionDeniedError=kr;T.UnprocessableEntityError=Br;const{OpenAIError:tc,APIError:rc,APIConnectionError:nc,APIConnectionTimeoutError:yi,APIUserAbortError:bi,NotFoundError:sc,ConflictError:ic,RateLimitError:ac,BadRequestError:oc,AuthenticationError:uc,InternalServerError:cc,PermissionDeniedError:lc,UnprocessableEntityError:hc}=Gs;(function(n){n.toFile=Qn,n.fileFromPath=Gn,n.Page=Fr,n.CursorPage=ne,n.Completions=At,n.Chat=ut,n.Embeddings=Pt,n.Files=Ct,n.FileObjectsPage=Jr,n.Images=St,n.Audio=dt,n.Moderations=Rt,n.Models=Tt,n.ModelsPage=Yr,n.FineTuning=It,n.Beta=Et})(T||(T={}));function Xr(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function wi(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function r(){return this instanceof r?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(r){var s=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return n[r]}})}),t}var _i=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const vi=Xr(_i);var us={exports:{}};const Ei=/[\p{Lu}]/u,Ai=/[\p{Ll}]/u,vn=/^[\p{Lu}](?![\p{Lu}])/gu,cs=/([\p{Alpha}\p{N}_]|$)/u,ls=/[_.\- ]+/,Pi=new RegExp("^"+ls.source),En=new RegExp(ls.source+cs.source,"gu"),An=new RegExp("\\d+"+cs.source,"gu"),Ci=(n,e,t)=>{let r=!1,s=!1,i=!1;for(let a=0;a<n.length;a++){const o=n[a];r&&Ei.test(o)?(n=n.slice(0,a)+"-"+n.slice(a),r=!1,i=s,s=!0,a++):s&&i&&Ai.test(o)?(n=n.slice(0,a-1)+"-"+n.slice(a-1),i=s,s=!1,r=!0):(r=e(o)===o&&t(o)!==o,i=s,s=t(o)===o&&e(o)!==o)}return n},Oi=(n,e)=>(vn.lastIndex=0,n.replace(vn,t=>e(t))),Ii=(n,e)=>(En.lastIndex=0,An.lastIndex=0,n.replace(En,(t,r)=>e(r)).replace(An,t=>e(t))),hs=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(i=>i.trim()).filter(i=>i.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?i=>i.toLowerCase():i=>i.toLocaleLowerCase(e.locale),r=e.locale===!1?i=>i.toUpperCase():i=>i.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Ci(n,t,r)),n=n.replace(Pi,""),e.preserveConsecutiveUppercase?n=Oi(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),Ii(n,r))};us.exports=hs;us.exports.default=hs;function Si(n,e){return(e==null?void 0:e[n])||vi(n)}function Ti(n,e,t){const r={};for(const s in n)Object.hasOwn(n,s)&&(r[e(s,t)]=n[s]);return r}function Pn(n){return Array.isArray(n)?[...n]:{...n}}function Ri(n,e){const t=Pn(n);for(const[r,s]of Object.entries(e)){const[i,...a]=r.split(".").reverse();let o=t;for(const u of a.reverse()){if(o[u]===void 0)break;o[u]=Pn(o[u]),o=o[u]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return t}function ds(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class fe{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ds(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof fe||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let i=this,a=r;const[o,...u]=s.split(".").reverse();for(const c of u.reverse()){if(!(c in i)||i[c]===void 0)return;(!(c in a)||a[c]===void 0)&&(typeof i[c]=="object"&&i[c]!=null?a[c]={}:Array.isArray(i[c])&&(a[c]=[])),i=i[c],a=a[c]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Ti(Object.keys(t).length?Ri(r,t):r,Si,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function Ke(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}class Zr extends fe{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if(e==="human")return new xt({...this});if(e==="ai")return new ze({...this});if(e==="system")return new $t({...this});if(e==="function")return new Nt({...this});if(en.isInstance(this))return new jt({...this});throw new Error("Unknown message type.")}}function Cn(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}class Je extends Zr{static _mergeAdditionalKwargs(e,t){var s,i;const r={...e};for(const[a,o]of Object.entries(t))if(r[a]===void 0)r[a]=o;else{if(typeof r[a]!=typeof o)throw new Error(`additional_kwargs[${a}] already exists in the message chunk, but with a different type.`);if(typeof r[a]=="string")r[a]=r[a]+o;else if(!Array.isArray(r[a])&&typeof r[a]=="object")r[a]=this._mergeAdditionalKwargs(r[a],o);else if(a==="tool_calls"&&Cn(r[a])&&Cn(o))for(const u of o)((s=r[a])==null?void 0:s[u.index])!==void 0?r[a]=(i=r[a])==null?void 0:i.map((c,l)=>l!==u.index?c:{...c,...u,function:{name:u.function.name??c.function.name,arguments:(c.function.arguments??"")+(u.function.arguments??"")}}):r[a][u.index]=u;else throw new Error(`additional_kwargs[${a}] already exists in this message chunk.`)}return r}}class xi extends Zr{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class xt extends Je{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new xt({content:Ke(this.content,e.content),additional_kwargs:xt._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class ze extends Je{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new ze({content:Ke(this.content,e.content),additional_kwargs:ze._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class $t extends Je{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new $t({content:Ke(this.content,e.content),additional_kwargs:$t._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class Nt extends Je{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new Nt({content:Ke(this.content,e.content),additional_kwargs:Nt._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:this.name??""})}}class en extends Zr{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return en}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}class jt extends Je{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new jt({content:Ke(this.content,e.content),additional_kwargs:jt._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function fs(n,e="Human",t="AI"){const r=[];for(const s of n){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=t;else if(s._getType()==="system")i="System";else if(s._getType()==="function")i="Function";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"";r.push(`${i}: ${a}${s.content}`)}return r.join(`
`)}var rr={};const $i=()=>typeof window<"u"&&typeof window.document<"u",Ni=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",ji=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),ps=()=>typeof Deno<"u",ki=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!ps(),Li=()=>{let n;return $i()?n="browser":ki()?n="node":Ni()?n="webworker":ji()?n="jsdom":ps()?n="deno":n="other",n};let nr;async function Di(){return nr===void 0&&(nr={library:"langchain-js",runtime:Li()}),nr}function H(n){try{return typeof process<"u"?rr==null?void 0:rr[n]:void 0}catch{return}}class ms extends fe{}class Bi extends ms{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new xi(this.value)]}}class dc extends ms{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return fs(this.messages)}toChatMessages(){return this.messages}}var Vt={exports:{}},gs={};function q(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Ui=q;q.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};q.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};q.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};q.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};q.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};q.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};q.prototype.start=q.prototype.try;q.prototype.errors=function(){return this._errors};q.prototype.attempts=function(){return this._attempts};q.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var s=this._errors[r],i=s.message,a=(n[i]||0)+1;n[i]=a,a>=t&&(e=s,t=a)}return e};(function(n){var e=Ui;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)r[s]=t[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<r.retries;a++)i.push(this.createTimeout(a,r));return t&&t.forever&&!i.length&&i.push(this.createTimeout(a,r)),i.sort(function(o,u){return o-u}),i},n.createTimeout=function(t,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(t,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var o=s[a],u=t[o];t[o]=(function(l){var h=n.operation(r),d=Array.prototype.slice.call(arguments,1),p=d.pop();d.push(function(f){h.retry(f)||(f&&(arguments[0]=h.mainError()),p.apply(this,arguments))}),h.attempt(function(){l.apply(t,d)})}).bind(t,u),t[o].options=r}}})(gs);var Mi=gs;const Fi=Mi,Hi=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class ys extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Vi=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},zi=n=>Hi.includes(n),bs=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const s=Fi.operation(e);s.attempt(async i=>{try{t(await n(i))}catch(a){if(!(a instanceof Error)){r(new TypeError(`Non-error was thrown: "${a}". You should only throw errors.`));return}if(a instanceof ys)s.stop(),r(a.originalError);else if(a instanceof TypeError&&!zi(a.message))s.stop(),r(a);else{Vi(a,i,e);try{await e.onFailedAttempt(a)}catch(o){r(o);return}s.retry(a)||r(s.mainError())}}})});Vt.exports=bs;Vt.exports.default=bs;Vt.exports.AbortError=ys;var qi=Vt.exports;const kt=Xr(qi);var ws={},_s={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function s(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function i(u,c,l,h,d){if(typeof l!="function")throw new TypeError("The listener must be a function");var p=new s(l,h||u,d),f=t?t+c:c;return u._events[f]?u._events[f].fn?u._events[f]=[u._events[f],p]:u._events[f].push(p):(u._events[f]=p,u._eventsCount++),u}function a(u,c){--u._eventsCount===0?u._events=new r:delete u._events[c]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,h;if(this._eventsCount===0)return c;for(h in l=this._events)e.call(l,h)&&c.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=t?t+c:c,h=this._events[l];if(!h)return[];if(h.fn)return[h.fn];for(var d=0,p=h.length,f=new Array(p);d<p;d++)f[d]=h[d].fn;return f},o.prototype.listenerCount=function(c){var l=t?t+c:c,h=this._events[l];return h?h.fn?1:h.length:0},o.prototype.emit=function(c,l,h,d,p,f){var v=t?t+c:c;if(!this._events[v])return!1;var m=this._events[v],w=arguments.length,y,g;if(m.fn){switch(m.once&&this.removeListener(c,m.fn,void 0,!0),w){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,l),!0;case 3:return m.fn.call(m.context,l,h),!0;case 4:return m.fn.call(m.context,l,h,d),!0;case 5:return m.fn.call(m.context,l,h,d,p),!0;case 6:return m.fn.call(m.context,l,h,d,p,f),!0}for(g=1,y=new Array(w-1);g<w;g++)y[g-1]=arguments[g];m.fn.apply(m.context,y)}else{var A=m.length,b;for(g=0;g<A;g++)switch(m[g].once&&this.removeListener(c,m[g].fn,void 0,!0),w){case 1:m[g].fn.call(m[g].context);break;case 2:m[g].fn.call(m[g].context,l);break;case 3:m[g].fn.call(m[g].context,l,h);break;case 4:m[g].fn.call(m[g].context,l,h,d);break;default:if(!y)for(b=1,y=new Array(w-1);b<w;b++)y[b-1]=arguments[b];m[g].fn.apply(m[g].context,y)}}return!0},o.prototype.on=function(c,l,h){return i(this,c,l,h,!1)},o.prototype.once=function(c,l,h){return i(this,c,l,h,!0)},o.prototype.removeListener=function(c,l,h,d){var p=t?t+c:c;if(!this._events[p])return this;if(!l)return a(this,p),this;var f=this._events[p];if(f.fn)f.fn===l&&(!d||f.once)&&(!h||f.context===h)&&a(this,p);else{for(var v=0,m=[],w=f.length;v<w;v++)(f[v].fn!==l||d&&!f[v].once||h&&f[v].context!==h)&&m.push(f[v]);m.length?this._events[p]=m.length===1?m[0]:m:a(this,p)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=t?t+c:c,this._events[l]&&a(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(_s);var Gi=_s.exports,zt={exports:{}},Ki=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const Ji=Ki;class vs extends Error{constructor(e){super(e),this.name="TimeoutError"}}const Es=(n,e,t)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const i=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){s(u)}return}const a=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new vs(a);typeof n.cancel=="function"&&n.cancel(),s(o)},e);Ji(n.then(r,s),()=>{clearTimeout(i)})});zt.exports=Es;zt.exports.default=Es;zt.exports.TimeoutError=vs;var Wi=zt.exports,tn={},rn={};Object.defineProperty(rn,"__esModule",{value:!0});function Qi(n,e,t){let r=0,s=n.length;for(;s>0;){const i=s/2|0;let a=r+i;t(n[a],e)<=0?(r=++a,s-=i+1):s=i}return r}rn.default=Qi;Object.defineProperty(tn,"__esModule",{value:!0});const Yi=rn;class Xi{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const s=Yi.default(this._queue,r,(i,a)=>a.priority-i.priority);this._queue.splice(s,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}tn.default=Xi;Object.defineProperty(ws,"__esModule",{value:!0});const Zi=Gi,As=Wi,ea=tn,Ze=()=>{},ta=new As.TimeoutError;class ra extends Zi{constructor(e){var t,r,s,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Ze,this._resolveIdle=Ze,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:ea.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(i=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Ze,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Ze,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,s)=>{const i=async()=>{this._pendingCount++,this._intervalCount++;try{const a=this._timeout===void 0&&t.timeout===void 0?e():As.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&s(ta)});r(await a)}catch(a){s(a)}this._next()};this._queue.enqueue(i,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var te=ws.default=ra;const na=[400,401,402,403,404,405,406,407,408,409],sa=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("TimeoutError")||n.name==="TimeoutError"||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&na.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}};let Ps=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??sa;const t="default"in te?te.default:te;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>kt(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var qt={};qt.byteLength=oa;qt.toByteArray=ca;qt.fromByteArray=da;var Y=[],V=[],ia=typeof Uint8Array<"u"?Uint8Array:Array,sr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var ve=0,aa=sr.length;ve<aa;++ve)Y[ve]=sr[ve],V[sr.charCodeAt(ve)]=ve;V[45]=62;V[95]=63;function Cs(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function oa(n){var e=Cs(n),t=e[0],r=e[1];return(t+r)*3/4-r}function ua(n,e,t){return(e+t)*3/4-t}function ca(n){var e,t=Cs(n),r=t[0],s=t[1],i=new ia(ua(n,r,s)),a=0,o=s>0?r-4:r,u;for(u=0;u<o;u+=4)e=V[n.charCodeAt(u)]<<18|V[n.charCodeAt(u+1)]<<12|V[n.charCodeAt(u+2)]<<6|V[n.charCodeAt(u+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=V[n.charCodeAt(u)]<<2|V[n.charCodeAt(u+1)]>>4,i[a++]=e&255),s===1&&(e=V[n.charCodeAt(u)]<<10|V[n.charCodeAt(u+1)]<<4|V[n.charCodeAt(u+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function la(n){return Y[n>>18&63]+Y[n>>12&63]+Y[n>>6&63]+Y[n&63]}function ha(n,e,t){for(var r,s=[],i=e;i<t;i+=3)r=(n[i]<<16&16711680)+(n[i+1]<<8&65280)+(n[i+2]&255),s.push(la(r));return s.join("")}function da(n){for(var e,t=n.length,r=t%3,s=[],i=16383,a=0,o=t-r;a<o;a+=i)s.push(ha(n,a,a+i>o?o:a+i));return r===1?(e=n[t-1],s.push(Y[e>>2]+Y[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],s.push(Y[e>>10]+Y[e>>4&63]+Y[e<<2&63]+"=")),s.join("")}var fa=Object.defineProperty,pa=(n,e,t)=>e in n?fa(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ma=(n,e,t)=>(pa(n,typeof e!="symbol"?e+"":e,t),t);function ga(n,e){let t=Array.from({length:n.length},(r,s)=>({start:s,end:s+1}));for(;t.length>1;){let r=null;for(let s=0;s<t.length-1;s++){const i=n.slice(t[s].start,t[s+1].end),a=e.get(i.join(","));a!=null&&(r==null||a<r[0])&&(r=[a,s])}if(r!=null){const s=r[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function ya(n,e){return n.length===1?[e.get(n.join(","))]:ga(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function ba(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Cr=class{constructor(n,e){se(this,"specialTokens");se(this,"inverseSpecialTokens");se(this,"patStr");se(this,"textEncoder",new TextEncoder);se(this,"textDecoder",new TextDecoder("utf-8"));se(this,"rankMap",new Map);se(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[i,a,...o]=s.split(" "),u=Number.parseInt(a,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(const[r,s]of Object.entries(t)){const i=qt.toByteArray(r);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,i])=>(r[i]=this.textEncoder.encode(s),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),s=Cr.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(c=>!a.has(c)):t);if(o.size>0){const c=Cr.specialTokenRegex([...o]),l=n.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;s.lastIndex=l,c=s.exec(n),!(c==null||a.has(c[0]));)l=c.index+1;const h=(c==null?void 0:c.index)??n.length;for(const p of n.substring(u,h).matchAll(r)){const f=this.textEncoder.encode(p[0]),v=this.rankMap.get(f.join(","));if(v!=null){i.push(v);continue}i.push(...ya(f,this.rankMap))}if(c==null)break;let d=this.specialTokens[c[0]];i.push(d),u=c.index+c[0].length}return i}decode(n){const e=[];let t=0;for(let i=0;i<n.length;++i){const a=n[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let s=0;for(const i of e)r.set(i,s),s+=i.length;return this.textDecoder.decode(r)}},wa=Cr;ma(wa,"specialTokenRegex",n=>new RegExp(n.map(e=>ba(e)).join("|"),"g"));let et;const _a=new Uint8Array(16);function va(){if(!et&&(et=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!et))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return et(_a)}const Ea=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Aa(n){return typeof n=="string"&&Ea.test(n)}const x=[];for(let n=0;n<256;++n)x.push((n+256).toString(16).slice(1));function Pa(n,e=0){return x[n[e+0]]+x[n[e+1]]+x[n[e+2]]+x[n[e+3]]+"-"+x[n[e+4]]+x[n[e+5]]+"-"+x[n[e+6]]+x[n[e+7]]+"-"+x[n[e+8]]+x[n[e+9]]+"-"+x[n[e+10]]+x[n[e+11]]+x[n[e+12]]+x[n[e+13]]+x[n[e+14]]+x[n[e+15]]}const Ca=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),On={randomUUID:Ca};function Q(n,e,t){if(On.randomUUID&&!e&&!n)return On.randomUUID();n=n||{};const r=n.random||(n.rng||va)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=r[s];return e}return Pa(r)}var ir={};class Oa{}class We extends Oa{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ds(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:typeof process<"u"?(ir==null?void 0:ir.LANGCHAIN_CALLBACKS_BACKGROUND)!=="true":!0}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever)}copy(){return new this.constructor(this)}toJSON(){return fe.prototype.toJSON.call(this)}toJSONNotImplemented(){return fe.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends We{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Q()}),Object.assign(this,e)}}return new t}}var nn={exports:{}};nn.exports;(function(n){const t=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,r=(i=0)=>(a,o,u)=>`\x1B[${38+i};2;${a};${o};${u}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,u]of Object.entries(a)){for(const[c,l]of Object.entries(u))a[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=a[c],i.set(l[0],l[1]);Object.defineProperty(a,o,{value:u,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=t(),a.color.ansi16m=r(),a.bgColor.ansi256=t(10),a.bgColor.ansi16m=r(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(h=>h+h).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(n,"exports",{enumerable:!0,get:s})})(nn);var Ia=nn.exports;const Os=Xr(Ia);function ar(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function Sa(n){return n.replace(/[-:.]/g,"")}function Ta(n,e){return Sa(`${new Date(n).toISOString().slice(0,-1)}000Z`)+e}class Gt extends We{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var s;const t=Ta(e.start_time,e.id),r={...e};if(r.parent_run_id!==void 0){const i=this.runMap.get(r.parent_run_id);i&&(this._addChildRun(i,r),i.child_execution_order=Math.max(i.child_execution_order,r.child_execution_order),r.trace_id=i.trace_id,i.dotted_order!==void 0&&(r.dotted_order=[i.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((s=this.onRunCreate)==null?void 0:s.call(this,r))}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,s,i,a,o,u){var p;const c=this._getExecutionOrder(s),l=Date.now(),h=o?{...i,metadata:o}:i,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:h??{},tags:a||[]};return await this._startTrace(d),await((p=this.onLLMStart)==null?void 0:p.call(this,d)),d}async handleChatModelStart(e,t,r,s,i,a,o,u){var p;const c=this._getExecutionOrder(s),l=Date.now(),h=o?{...i,metadata:o}:i,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:h??{},tags:a||[]};return await this._startTrace(d),await((p=this.onLLMStart)==null?void 0:p.call(this,d)),d}async handleLLMEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,s,i,a,o,u){var d;const c=this._getExecutionOrder(s),l=Date.now(),h={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(h),await((d=this.onChainStart)==null?void 0:d.call(this,h)),h}async handleChainEnd(e,t,r,s,i){var o;const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=ar(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=ar(i.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleChainError(e,t,r,s,i){var o;const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=ar(i.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleToolStart(e,t,r,s,i,a,o){var h;const u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(l),await((h=this.onToolStart)==null?void 0:h.call(this,l)),l}async handleToolEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentAction)==null?void 0:i.call(this,r))}async handleAgentEnd(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}async handleRetrieverStart(e,t,r,s,i,a,o){var h;const u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(l),await((h=this.onRetrieverStart)==null?void 0:h.call(this,l)),l}async handleRetrieverEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,t,r,s,i,a){var u;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:a==null?void 0:a.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:a==null?void 0:a.chunk})),o}}function B(n,e){return`${n.open}${e}${n.close}`}function J(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function ae(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:U}=Os;class In extends Gt{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)t.push(s),r=s;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?B(Os.bold,o):o}).join(" > ");return B(U.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.green,"[chain/start]")} [${t}] Entering Chain run with input: ${J(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.cyan,"[chain/end]")} [${t}] [${ae(e)}] Exiting Chain run with output: ${J(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.red,"[chain/error]")} [${t}] [${ae(e)}] Chain run errored with error: ${J(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${B(U.green,"[llm/start]")} [${t}] Entering LLM run with input: ${J(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.cyan,"[llm/end]")} [${t}] [${ae(e)}] Exiting LLM run with output: ${J(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.red,"[llm/error]")} [${t}] [${ae(e)}] LLM run errored with error: ${J(e.error,"[error]")}`)}onToolStart(e){var r;const t=this.getBreadcrumbs(e);console.log(`${B(U.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,s;const t=this.getBreadcrumbs(e);console.log(`${B(U.cyan,"[tool/end]")} [${t}] [${ae(e)}] Exiting Tool run with output: "${(s=(r=e.outputs)==null?void 0:r.output)==null?void 0:s.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.red,"[tool/error]")} [${t}] [${ae(e)}] Tool run errored with error: ${J(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${J(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.cyan,"[retriever/end]")} [${t}] [${ae(e)}] Exiting Retriever run with output: ${J(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${B(U.red,"[retriever/error]")} [${t}] [${ae(e)}] Retriever run errored with error: ${J(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${B(U.blue,"[agent/action]")} [${r}] Agent selected action: ${J(t.actions[t.actions.length-1],"[action]")}`)}}const Ra=[400,401,403,404,405,406,407,408],xa=[409];class Sn{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const t="default"in te?te.default:te;this.queue=new t({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>kt(()=>e(...t).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const i=s==null?void 0:s.response,a=i==null?void 0:i.status;if(a){if(Ra.includes(+a))throw s;if(xa.includes(+a))return;r&&await r(i)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}function Tn(n){return typeof(n==null?void 0:n._getType)=="function"}function Rn(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var Be={};let Z;const $a=()=>typeof window<"u"&&typeof window.document<"u",Na=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",ja=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Is=()=>typeof Deno<"u",ka=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Is(),La=()=>Z||($a()?Z="browser":ka()?Z="node":Na()?Z="webworker":ja()?Z="jsdom":Is()?Z="deno":Z="other",Z);let or;async function Da(){if(or===void 0){const n=La(),e=Ma();or={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Ss,...e}}return or}function Ba(){const n=Ua()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,s]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof s=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function Ua(){try{return typeof process<"u"&&Be?Object.entries(Be).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function me(n){try{return typeof process<"u"?Be==null?void 0:Be[n]:void 0}catch{return}}let ur;function Ma(){if(ur!==void 0)return ur;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=me(t);r!==void 0&&(e[t]=r)}return ur=e,e}async function xn(n){const e=await Da(),t=Ba();return n.map(r=>{const s=r.extra??{},i=s.metadata;return r.extra={...s,runtime:{...e,...s==null?void 0:s.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...i}},r})}const Fa=()=>{const n=me("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;const e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},Ha=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},oe=async(n,e)=>{const t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function Va(n){const e=[];for await(const t of n)e.push(t);return e}function cr(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function C(n){if(!Aa(n))throw new Error(`Invalid UUID: ${n}`)}const za=async n=>{if((n==null?void 0:n.status)===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};class qa{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}}const Ga=20971520;class sn{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new qa}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=sn.getDefaultClientConfig();this.tracingSampleRate=Fa(),this.apiUrl=cr(e.apiUrl??t.apiUrl)??"",this.apiKey=cr(e.apiKey??t.apiKey),this.webUrl=cr(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Sn(e.callerOptions??{}),this.batchIngestCaller=new Sn({...e.callerOptions??{},onFailedResponseHook:za}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit}static getDefaultClientConfig(){const e=me("LANGCHAIN_API_KEY"),t=me("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=me("LANGCHAIN_HIDE_INPUTS")==="true",s=me("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:Ha(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={"User-Agent":`langsmith-js/${Ss}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs?{}:e}processOutputs(e){return this.hideOutputs?{}:e}prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",s=`${this.apiUrl}${e}?${r}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);return i}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));const i=`${this.apiUrl}${e}?${t}`,a=await this.caller.call(fetch,i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!a.ok)throw new Error(`Failed to fetch ${e}: ${a.status} ${a.statusText}`);const o=await a.json();if(o.length===0||(yield o,o.length<s))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",s="runs"){const i=t?{...t}:{};for(;;){const o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(i)})).json();if(!o||!o[s])break;yield o[s];const u=o.cursors;if(!u||!u.next)break;i.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const s of e)this.sampledPostUuids.has(s.id)&&(r.push(s),this.sampledPostUuids.delete(s.id));return r}else{const r=[];for(const s of e)Math.random()<this.tracingSampleRate&&(r.push(s),this.sampledPostUuids.add(s.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){const r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const s=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),s}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms)});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const s=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){this.processRunOperation({action:"create",item:s}).catch(console.error);return}const i=await xn([s]),a=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(i[0]),signal:AbortSignal.timeout(this.timeout_ms)});await oe(a,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){var c,l;if(e===void 0&&t===void 0)return;let r=(e==null?void 0:e.map(h=>this.prepareRunCreateOrUpdateInputs(h)))??[],s=(t==null?void 0:t.map(h=>this.prepareRunCreateOrUpdateInputs(h)))??[];if(r.length>0&&s.length>0){const h=r.reduce((p,f)=>(f.id&&(p[f.id]=f),p),{}),d=[];for(const p of s)p.id!==void 0&&h[p.id]?h[p.id]={...h[p.id],...p}:d.push(p);r=Object.values(h),s=d}const i={post:this._filterForSampling(r),patch:this._filterForSampling(s,!0)};if(!i.post.length&&!i.patch.length)return;if(r=await xn(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const h of i.post)await this.createRun(h);for(const h of i.patch)h.id!==void 0&&await this.updateRun(h.id,h);return}const a=((l=(c=this.serverInfo)==null?void 0:c.batch_ingest_config)==null?void 0:l.size_limit_bytes)??Ga,o={post:[],patch:[]};let u=0;for(const h of["post","patch"]){const d=h,p=i[d].reverse();let f=p.pop();for(;f!==void 0;){const v=JSON.stringify(f);u>0&&u+v.length>a&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=v.length,o[d].push(f),f=p.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms)});await oe(r,"batch create run")}async updateRun(e,t){C(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const s={...this.headers,"Content-Type":"application/json"},i=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await oe(i,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){C(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let s;t.session_id?s=t.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:me("LANGCHAIN_PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await Va(this.listRuns({id:e.child_run_ids})),r={},s={};t.sort((i,a)=>((i==null?void 0:i.dotted_order)??"").localeCompare((a==null?void 0:a.dotted_order)??""));for(const i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),s[i.id]=i}e.child_runs=r[e.id]||[];for(const i in r)i!==e.id&&(s[i].child_runs=r[i]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:u,runType:c,error:l,id:h,query:d,filter:p,traceFilter:f,limit:v}=e;let m=[];if(t&&(m=Array.isArray(t)?t:[t]),r){const y=Array.isArray(r)?r:[r],g=await Promise.all(y.map(A=>this.readProject({projectName:A}).then(b=>b.id)));m.push(...g)}const w={session:m.length?m:null,run_type:c,reference_example:a,query:d,filter:p,trace_filter:f,execution_order:u,parent_run:s?[s]:null,start_time:o?o.toISOString():null,error:l,id:h,limit:v,trace:i};for await(const y of this._getCursorPaginatedList("/runs/query",w))yield*y}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||Q()};C(e);const i=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();if(i===null||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){C(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await oe(t,"unshare run")}async readRunSharedLink(e){C(e);const r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const a of t)r.append("id",a);return C(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),C(e);const s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};C(e);const i=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){C(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await oe(t,"unshare dataset")}async readSharedDataset(e){return C(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=i||{};r&&(c.metadata=r);const l={name:e,extra:c,description:t};a!==null&&(l.reference_dataset_id=a);const h=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),d=await h.json();if(!h.ok)throw new Error(`Failed to create session ${e}: ${h.status} ${h.statusText}`);return d}async updateProject(e,{name:t=null,description:r=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=i;s&&(u={...u||{},metadata:s});const c={name:t,extra:u,description:r,end_time:a?new Date(a).toISOString():null},l=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)}),h=await l.json();if(!l.ok)throw new Error(`Failed to update project ${e}: ${l.status} ${l.statusText}`);return h}async hasProject({projectId:e,projectName:t}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)C(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(fetch,`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});try{const a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let s="/sessions";const i=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)C(e),s+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&i.append("include_stats",r.toString());const a=await this._get(s,i);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=a[0]}else o=a;return o}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:s,referenceDatasetName:i,referenceFree:a}={}){const o=new URLSearchParams;if(e!==void 0)for(const u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),s!==void 0)o.append("reference_dataset",s);else if(i!==void 0){const u=await this.readDataset({datasetName:i});o.append("reference_dataset",u.id)}a!==void 0&&o.append("reference_free",a.toString());for await(const u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,C(r);const s=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await oe(s,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:s,description:i,dataType:a,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(d=>{c.append("input_keys",d)}),s.forEach(d=>{c.append("output_keys",d)}),i&&c.append("description",i),a&&c.append("data_type",a),o&&c.append("name",o);const l=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok){const d=await l.json();throw d.detail&&d.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${l.status} ${l.statusText}`)}return await l.json()}async createDataset(e,{description:t,dataType:r}={}){const s={name:e,description:t};r&&(s.data_type=r);const i=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok){const o=await i.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${i.status} ${i.statusText}`)}return await i.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)C(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(r,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=i[0]}else a=i;return a}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:s,datasetNameContains:i}={}){const a="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const u of r)o.append("id",u);s!==void 0&&o.append("name",s),i!==void 0&&o.append("name_contains",i);for await(const u of this._getPaginated(a,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)C(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");const i=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to delete ${r}: ${i.status} ${i.statusText}`);await i.json()}async createExample(e,t,{datasetId:r,datasetName:s,createdAt:i,exampleId:a}){let o=r;if(o===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:s})).id);const u=i||new Date,c={dataset_id:o,inputs:e,outputs:t,created_at:u==null?void 0:u.toISOString(),id:a},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createExamples(e){const{inputs:t,outputs:r,sourceRunIds:s,exampleIds:i,datasetId:a,datasetName:o}=e;let u=a;if(u===void 0&&o===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&o!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:o})).id);const c=t.map((d,p)=>({dataset_id:u,inputs:d,outputs:r?r[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const s=e.map(a=>Tn(a)?Rn(a):a),i=Tn(t)?Rn(t):t;return this.createExample({input:s},{output:i},r)}async readExample(e){C(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r}={}){let s;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)s=e;else if(t!==void 0)s=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const i=new URLSearchParams({dataset:s});if(r!==void 0)for(const a of r)i.append("id",a);for await(const a of this._getPaginated("/examples",i))yield*a}async deleteExample(e){C(e);const t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){C(e);const r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:s,referenceExample:i}={loadChildRuns:!1}){let a;if(typeof e=="string")a=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)a=e;else throw new Error(`Invalid run type: ${typeof e}`);a.reference_example_id!==null&&a.reference_example_id!==void 0&&(i=await this.readExample(a.reference_example_id));const o=await t.evaluateRun(a,i);let u=r??{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});const c=o.targetRunId??a.id;return await this.createFeedback(c,o.key,{score:o==null?void 0:o.score,value:o==null?void 0:o.value,comment:o==null?void 0:o.comment,correction:o==null?void 0:o.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o==null?void 0:o.sourceRunId})}async createFeedback(e,t,{score:r,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,eager:h=!1}){var m;const d={type:u??"api",metadata:o??{}};c!==void 0&&(d==null?void 0:d.metadata)!==void 0&&!d.metadata.__run&&(d.metadata.__run={run_id:c}),(d==null?void 0:d.metadata)!==void 0&&((m=d.metadata.__run)==null?void 0:m.run_id)!==void 0&&C(d.metadata.__run.run_id);const p={id:l??Q(),run_id:e,key:t,score:r,value:s,correction:i,comment:a,feedback_source:d},f=`${this.apiUrl}/feedback`+(h?"/eager":""),v=await this.caller.call(fetch,f,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms)});return await oe(v,"create feedback"),p}async updateFeedback(e,{score:t,value:r,correction:s,comment:i}){const a={};t!=null&&(a.score=t),r!=null&&(a.value=r),s!=null&&(a.correction=s),i!=null&&(a.comment=i),C(e);const o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});await oe(o,"update feedback")}async readFeedback(e){C(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){C(e);const t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e&&s.append("run",e.join(",")),t)for(const i of t)s.append("key",i);if(r)for(const i of r)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}}const Ss="0.1.8";class Ka extends Gt{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:s}=e;this.projectName=r??H("LANGCHAIN_PROJECT")??H("LANGCHAIN_SESSION"),this.exampleId=t,this.client=s??new sn({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Di()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}async function Ja(){return new Ka}let lr;function Wa(){const n="default"in te?te.default:te;return new n({autoStart:!0,concurrency:1})}async function N(n,e){e===!0?await n():(typeof lr>"u"&&(lr=Wa()),lr.add(n))}function Qa(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}class Ya{setHandler(e){return this.setHandlers([e])}}class Kt{constructor(e,t,r,s,i,a,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleText: ${s}`)}},t.awaitHandlers)))}}class Xa extends Kt{getChild(e){const t=new z(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch{console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${s}`)}},t.awaitHandlers)))}}class $n extends Kt{async handleLLMNewToken(e,t,r,s,i,a){await Promise.all(this.handlers.map(o=>N(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(c){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${s}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${s}`)}},t.awaitHandlers)))}}class Za extends Kt{getChild(e){const t=new z(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,s,i){await Promise.all(this.handlers.map(a=>N(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainError)==null?void 0:o.call(a,e,this.runId,this._parentRunId,this.tags,i))}catch(u){console.error(`Error in handler ${a.constructor.name}, handleChainError: ${u}`)}},a.awaitHandlers)))}async handleChainEnd(e,t,r,s,i){await Promise.all(this.handlers.map(a=>N(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainEnd)==null?void 0:o.call(a,e,this.runId,this._parentRunId,this.tags,i))}catch(u){console.error(`Error in handler ${a.constructor.name}, handleChainEnd: ${u}`)}},a.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${s}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${s}`)}},t.awaitHandlers)))}}class eo extends Kt{getChild(e){const t=new z(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${s}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>N(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${s}`)}},t.awaitHandlers)))}}class z extends Ya{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,s=void 0,i=void 0,a=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{const l=Q();return await Promise.all(this.handlers.map(h=>N(async()=>{var d;if(!h.ignoreLLM)try{await((d=h.handleLLMStart)==null?void 0:d.call(h,e,[c],l,this._parentRunId,i,this.tags,this.metadata,u))}catch(p){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`)}},h.awaitHandlers))),new $n(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,s=void 0,i=void 0,a=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{const l=Q();return await Promise.all(this.handlers.map(h=>N(async()=>{var d,p;if(!h.ignoreLLM)try{if(h.handleChatModelStart)await((d=h.handleChatModelStart)==null?void 0:d.call(h,e,[c],l,this._parentRunId,i,this.tags,this.metadata,u));else if(h.handleLLMStart){const f=fs(c);await((p=h.handleLLMStart)==null?void 0:p.call(h,e,[f],l,this._parentRunId,i,this.tags,this.metadata,u))}}catch(f){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`)}},h.awaitHandlers))),new $n(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=Q(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>N(async()=>{var c;if(!u.ignoreChain)try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`)}},u.awaitHandlers))),new Za(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=Q(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>N(async()=>{var c;if(!u.ignoreAgent)try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`)}},u.awaitHandlers))),new eo(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=Q(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>N(async()=>{var c;if(!u.ignoreRetriever)try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`)}},u.awaitHandlers))),new Xa(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new z(this._parentRunId);for(const s of this.handlers){const i=this.inheritableHandlers.includes(s);r.addHandler(s,i)}for(const s of this.tags){const i=this.inheritableTags.includes(s);r.addTags([s],i)}for(const s of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(s);r.addMetadata({[s]:this.metadata[s]},i)}for(const s of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===s.name)||r.addHandler(s,t);return r}static fromHandlers(e){class t extends We{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Q()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,s,i,a,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new z,u.setHandlers((e==null?void 0:e.map(Lt))??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(Lt):t==null?void 0:t.handlers,!1));const c=H("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=H("LANGCHAIN_TRACING_V2")==="true",h=l||(H("LANGCHAIN_TRACING")??!1);if(c||h){if(u||(u=new z),c&&!u.handlers.some(d=>d.name===In.prototype.name)){const d=new In;u.addHandler(d,!0)}h&&!u.handlers.some(d=>d.name==="langchain_tracer")&&l&&u.addHandler(await Ja(),!0)}return(r||s)&&u&&(u.addTags(r??[]),u.addTags(s??[],!1)),(i||a)&&u&&(u.addMetadata(i??{}),u.addMetadata(a??{},!1)),u}}function Lt(n){return"name"in n?n:We.fromMethods(n)}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const to=Object.prototype.hasOwnProperty;function ro(n,e){return to.call(n,e)}function no(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)ro(n,t)&&e.push(t);return e}function Te(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Or(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function so(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function Ir(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(Ir(n[t]))return!0}else if(typeof n=="object"){const t=no(n),r=t.length;for(var e=0;e<r;e++)if(Ir(n[t[e]]))return!0}}return!1}function Nn(n,e){const t=[n];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&t.push(`${r}: ${s}`)}return t.join(`
`)}class io extends Error{constructor(e,t,r,s,i){super(Nn(e,{name:t,index:r,operation:s,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=Nn(e,{name:t,index:r,operation:s,tree:i})}}const O=io,Pe={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Sr(t,this.path);r&&(r=Te(r));const s=Ue(t,{op:"remove",path:this.from}).removed;return Ue(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=Sr(t,this.from);return Ue(t,{op:"add",path:this.path,value:Te(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Bt(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var ao={add:function(n,e,t){return Or(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Pe.move,copy:Pe.copy,test:Pe.test,_get:Pe._get};function Sr(n,e){if(e=="")return n;var t={op:"_get",path:e};return Ue(n,t),t.value}function Ue(n,e,t=!1,r=!0,s=!0,i=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):Tr(e,0)),e.path===""){let a={newDocument:n};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=n,a;if(e.op==="move"||e.op==="copy")return a.newDocument=Sr(n,e.from),e.op==="move"&&(a.removed=n),a;if(e.op==="test"){if(a.test=Bt(n,e.value),a.test===!1)throw new O("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return a.newDocument=n,a}else{if(e.op==="remove")return a.removed=n,a.newDocument=null,a;if(e.op==="_get")return e.value=n,a;if(t)throw new O("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,n);return a}}else{r||(n=Te(n));const o=(e.path||"").split("/");let u=n,c=1,l=o.length,h,d,p;for(typeof t=="function"?p=t:p=Tr;;){if(d=o[c],d&&d.indexOf("~")!=-1&&(d=so(d)),s&&(d=="__proto__"||d=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&h===void 0&&(u[d]===void 0?h=o.slice(0,c).join("/"):c==l-1&&(h=e.path),h!==void 0&&p(e,0,n,h)),c++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!Or(d))throw new O("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,n);Or(d)&&(d=~~d)}if(c>=l){if(t&&e.op==="add"&&d>u.length)throw new O("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,n);const f=ao[e.op].call(e,u,d,n);if(f.test===!1)throw new O("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return f}}else if(c>=l){const f=Pe[e.op].call(e,u,d,n);if(f.test===!1)throw new O("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return f}if(u=u[d],t&&c<l&&(!u||typeof u!="object"))throw new O("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,n)}}}function Dt(n,e,t,r=!0,s=!0){if(t&&!Array.isArray(e))throw new O("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Te(n));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=Ue(n,e[a],t,!0,s,a),n=i[a].newDocument;return i.newDocument=n,i}function Tr(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new O("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Pe[n.op]){if(typeof n.path!="string")throw new O("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new O('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new O("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new O("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&Ir(n.value))throw new O("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var s=n.path.split("/").length,i=r.split("/").length;if(s!==i+1&&s!==i)throw new O("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new O("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var a={op:"_get",path:n.from,value:void 0},o=oo([a],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new O("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new O("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function oo(n,e,t){try{if(!Array.isArray(n))throw new O("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Dt(Te(e),Te(n),t||!0);else{t=t||Tr;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(s){if(s instanceof O)return s;throw s}}function Bt(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),s,i,a;if(t&&r){if(i=n.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!Bt(n[s],e[s]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!Bt(n[a],e[a]))return!1;return!0}return n!==n&&e!==e}class re extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new re({start(r){return s();function s(){return t.read().then(({done:i,value:a})=>{if(i){r.close();return}return r.enqueue(a),s()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new re({async pull(t){const{value:r,done:s}=await e.next();s&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function Ts(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){const i=await n.next();for(const a of t)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function ye(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,s]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=ye(t[r],s):t[r]=s;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class Re{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,s)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,s):this.firstResult.then(i=>r(void 0),s)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function uo(n,e,t,...r){const s=new Re(e,t),i=await s.setup;return{output:n(s,i,...r),setup:i}}class ue{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=Dt({},t);return new qe({ops:t,state:r[r.length-1].newDocument})}}class qe extends ue{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Dt(this.state,e.ops);return new qe({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=Dt({},e.ops);return new qe({ops:e.ops,state:t[t.length-1].newDocument})}}async function jn(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function kn(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function co(n){return n!==void 0&&n.message!==void 0}class Ln extends Gt{constructor(e){super(e),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=re.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new ue({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new ue({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await jn(e,this._schemaFormat)),await this.writer.write(new ue({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await jn(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await kn(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const s=new ue({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const t=new ue({ops:[{op:"replace",path:"/final_output",value:await kn(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const i=e.inputs.messages!==void 0;let a;i?co(r==null?void 0:r.chunk)?a=r==null?void 0:r.chunk:a=new ze(t):a=t;const o=new ue({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}}class lo{getStore(){}run(e,t){t()}}class ho{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new lo}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}}const Rr=new ho,hr=25;async function be(n){return z.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function Dn(...n){const e=$();for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags")e[r]=[...new Set(e[r].concat(t[r]??[]))];else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){const s=e.callbacks,i=t.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(Lt(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(Lt(o),!0);e.callbacks=a}else e.callbacks=new z(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{const s=r;e[s]=t[s]??e[s]}return e}const fo=new Set(["string","number","boolean"]);function $(n){var r;const e=n??Rr.getInstance().getStore();let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(e&&(t={...t,...e}),e!=null&&e.configurable)for(const s of Object.keys(e.configurable))fo.has(typeof e.configurable[s])&&!((r=t.metadata)!=null&&r[s])&&(t.metadata||(t.metadata={}),t.metadata[s]=e.configurable[s]);return t}function M(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:s,configurable:i}={}){const a=$(n);return e!==void 0&&(delete a.runName,a.callbacks=e),r!==void 0&&(a.recursionLimit=r),t!==void 0&&(a.maxConcurrency=t),s!==void 0&&(a.runName=s),i!==void 0&&(a.configurable={...a.configurable,...i}),a}class Rs extends Gt{constructor({config:e,onStart:t,onEnd:r,onError:s}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}class po{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const s=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||s.some(i=>{var a;return(a=this.includeTags)==null?void 0:a.includes(i)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&s.every(i=>{var a;return!((a=this.excludeTags)!=null&&a.includes(i))})),r}}function D(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class j extends fe{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Se({bound:this,kwargs:e,config:{}})}map(){return new Ut({bound:this})}withRetry(e){return new mo({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Se({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new go({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map($)}return Array.from({length:t},()=>$(e))}async batch(e,t,r){var u;const s=this._getOptionsList(t??{},e.length),i=((u=s[0])==null?void 0:u.maxConcurrency)??(r==null?void 0:r.maxConcurrency),a=new Ps({maxConcurrency:i,onFailedAttempt:c=>{throw c}}),o=e.map((c,l)=>a.call(async()=>{try{return await this.invoke(c,s[l])}catch(h){if(r!=null&&r.returnExceptions)return h;throw h}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=new Re(this._streamIterator(e,$(t)));return await r.setup,re.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e={}){const t=$({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,[t,r]}async _callWithConfig(e,t,r){const s=$(r),i=await be(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),D(t,"input"),void 0,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));let o;try{o=await e.call(this,t,s,a)}catch(u){throw await(a==null?void 0:a.handleChainError(u)),u}return await(a==null?void 0:a.handleChainEnd(D(o,"output"))),o}async _batchWithConfig(e,t,r,s){const i=this._getOptionsList(r??{},t.length),a=await Promise.all(i.map(be)),o=await Promise.all(a.map((c,l)=>c==null?void 0:c.handleChainStart(this.toJSON(),D(t[l],"input"),void 0,i[l].runType,void 0,void 0,i[l].runName??this.getName())));let u;try{u=await e.call(this,t,i,o,s)}catch(c){throw await Promise.all(o.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(o.map(c=>c==null?void 0:c.handleChainEnd(D(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let s,i=!0,a,o=!0;const u=$(r),c=await be(u);async function*l(){for await(const d of e){if(i)if(s===void 0)s=d;else try{s=ye(s,d)}catch{s=void 0,i=!1}yield d}}let h;try{const d=await uo(t.bind(this),l(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},void 0,u==null?void 0:u.runType,void 0,void 0,(u==null?void 0:u.runName)??this.getName()),u);h=d.setup;const p=m=>m.name==="log_stream_tracer",f=h==null?void 0:h.handlers.find(p);let v=d.output;f!==void 0&&h!==void 0&&(v=await f.tapOutputIterable(h.runId,d.output));for await(const m of v)if(yield m,o)if(a===void 0)a=m;else try{a=ye(a,m)}catch{a=void 0,o=!1}}catch(d){throw await(h==null?void 0:h.handleChainError(d,void 0,void 0,void 0,{inputs:D(s,"input")})),d}await(h==null?void 0:h.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:D(s,"input")}))}pipe(e){return new le({first:this,last:ge(e)})}pick(e){return this.pipe(new yo(e))}assign(e){return this.pipe(new xs(new xe({steps:e})))}async*transform(e,t){let r;for await(const s of e)r===void 0?r=s:r=ye(r,s);yield*this._streamIterator(r,$(t))}async*streamLog(e,t,r){const s=new Ln({...r,autoClose:!1,_schemaFormat:"original"}),i=$(t);yield*this._streamLog(e,s,i)}async*_streamLog(e,t,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[t];else if(Array.isArray(s))r.callbacks=s.concat([t]);else{const u=s.copy();u.inheritableHandlers.push(t),r.callbacks=u}const i=this.stream(e,r);async function a(){try{const u=await i;for await(const c of u){const l=new ue({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=a();try{for await(const u of t)yield u}finally{await o}}async*streamEvents(e,t,r){if(t.version!=="v1")throw new Error('Only version "v1" of the events schema is currently supported.');let s,i=!1;const a=$(t),o=a.tags??[],u=a.metadata??{},c=a.runName??this.getName(),l=new Ln({...r,autoClose:!1,_schemaFormat:"streaming_events"}),h=new po({...r}),d=this._streamLog(e,l,a);for await(const f of d){if(s?s=s.concat(f):s=qe.fromRunLogPatch(f),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const y={...s.state},g={run_id:y.id,event:`on_${y.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};h.includeEvent(g,y.type)&&(yield g)}const v=f.ops.filter(y=>y.path.startsWith("/logs/")).map(y=>y.path.split("/")[2]),m=[...new Set(v)];for(const y of m){let g,A={};const b=s.state.logs[y];if(b.end_time===void 0?b.streamed_output.length>0?g="stream":g="start":g="end",g==="start")b.inputs!==void 0&&(A.input=b.inputs);else if(g==="end")b.inputs!==void 0&&(A.input=b.inputs),A.output=b.final_output;else if(g==="stream"){const S=b.streamed_output.length;if(S!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${S} instead. Encountered in: "${b.name}"`);A={chunk:b.streamed_output[0]},b.streamed_output=[]}yield{event:`on_${b.type}_${g}`,name:b.name,run_id:b.id,tags:b.tags,metadata:b.metadata,data:A}}const{state:w}=s;if(w.streamed_output.length>0){const y=w.streamed_output.length;if(y!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${y} instead. Encountered in: "${w.name}"`);const g={chunk:w.streamed_output[0]};w.streamed_output=[];const A={event:`on_${w.type}_stream`,run_id:w.id,tags:o,metadata:u,name:c,data:g};h.includeEvent(A,w.type)&&(yield A)}}const p=s==null?void 0:s.state;if(p!==void 0){const f={event:`on_${p.type}_end`,name:c,run_id:p.id,tags:o,metadata:u,data:{output:p.final_output}};h.includeEvent(f,p.type)&&(yield f)}}static isRunnable(e){return e?e.lc_runnable:!1}withListeners({onStart:e,onEnd:t,onError:r}){return new Se({bound:this,config:{},configFactories:[s=>({callbacks:[new Rs({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class Se extends j{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Dn(this.config,...e);return Dn(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(t,this.kwargs))}async batch(e,t,r){const s=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig(i,this.kwargs))):await this._mergeConfig(t,this.kwargs);return this.bound.batch(e,s,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(t,this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(t,this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(t,this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig(t,this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&j.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Se({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new Rs({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class Ut extends j{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Ut({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,M(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new Ut({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class mo extends Se{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const s=e>1?`retry:attempt:${e}`:void 0;return M(t,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,t,r){return kt(s=>super.invoke(e,this._patchConfigForRetry(s,t,r)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,s){const i={};try{await kt(async a=>{const o=e.map((d,p)=>p).filter(d=>i[d.toString()]===void 0||i[d.toString()]instanceof Error),u=o.map(d=>e[d]),c=o.map(d=>this._patchConfigForRetry(a,t==null?void 0:t[d],r==null?void 0:r[d])),l=await super.batch(u,c,{...s,returnExceptions:!0});let h;for(let d=0;d<l.length;d+=1){const p=l[d],f=o[d];p instanceof Error&&h===void 0&&(h=p),i[f.toString()]=p}if(h)throw h;return l},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if((s==null?void 0:s.returnExceptions)!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class le extends j{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=$(t),s=await be(r),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),D(e,"input"),void 0,void 0,void 0,void 0,r==null?void 0:r.runName));let a=e,o;try{const u=[this.first,...this.middle];for(let c=0;c<u.length;c+=1)a=await u[c].invoke(a,M(r,{callbacks:i==null?void 0:i.getChild(`seq:step:${c+1}`)}));o=await this.last.invoke(a,M(r,{callbacks:i==null?void 0:i.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await(i==null?void 0:i.handleChainError(u)),u}return await(i==null?void 0:i.handleChainEnd(D(o,"output"))),o}async batch(e,t,r){const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(be)),a=await Promise.all(i.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),D(e[c],"input"),void 0,void 0,void 0,void 0,s[c].runName)));let o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,a.map((l,h)=>{const d=l==null?void 0:l.getChild(`seq:step:${u+1}`);return M(s[h],{callbacks:d})}),r)}catch(u){throw await Promise.all(a.map(c=>c==null?void 0:c.handleChainError(u))),u}return await Promise.all(a.map(u=>u==null?void 0:u.handleChainEnd(D(o,"output")))),o}async*_streamIterator(e,t){const r=await be(t),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),D(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),i=[this.first,...this.middle,this.last];let a=!0,o;async function*u(){yield e}try{let c=i[0].transform(u(),M(t,{callbacks:s==null?void 0:s.getChild("seq:step:1")}));for(let l=1;l<i.length;l+=1)c=await i[l].transform(c,M(t,{callbacks:s==null?void 0:s.getChild(`seq:step:${l+1}`)}));for await(const l of c)if(yield l,a)if(o===void 0)o=l;else try{o=ye(o,l)}catch{o=void 0,a=!1}}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}await(s==null?void 0:s.handleChainEnd(D(o,"output")))}pipe(e){return le.isRunnableSequence(e)?new le({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new le({first:this.first,middle:[...this.middle,this.last],last:ge(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&j.isRunnable(e)}static from([e,...t],r){return new le({first:ge(e),middle:t.slice(0,-1).map(ge),last:ge(t[t.length-1]),name:r})}}class xe extends j{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=ge(r)}static from(e){return new xe({steps:e})}async invoke(e,t){const r=$(t),s=await be(r),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,r==null?void 0:r.runName)),a={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{a[o]=await u.invoke(e,M(r,{callbacks:i==null?void 0:i.getChild(`map:key:${o}`)}))}))}catch(o){throw await(i==null?void 0:i.handleChainError(o)),o}return await(i==null?void 0:i.handleChainEnd(a)),a}async*_transform(e,t,r){const s={...this.steps},i=Ts(e,Object.keys(s).length),a=new Map(Object.entries(s).map(([o,u],c)=>{const l=u.transform(i[c],M(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(h=>({key:o,gen:l,result:h}))]}));for(;a.size;){const{key:o,result:u,gen:c}=await Promise.race(a.values());a.delete(o),u.done||(yield{[o]:u.value},a.set(o,c.next().then(l=>({key:o,gen:c,result:l}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Re(this.transform(r(),t));return await s.setup,re.fromAsyncGenerator(s)}}class an extends j{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new an({func:e})}async _invoke(e,t,r){return new Promise((s,i)=>{const a=M(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((t==null?void 0:t.recursionLimit)??hr)-1});Rr.getInstance().run(a,async()=>{try{let o=await this.func(e,{...a,config:a});if(o&&j.isRunnable(o)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...a,recursionLimit:(a.recursionLimit??hr)-1})}s(o)}catch(o){i(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let s;for await(const a of e)if(s===void 0)s=a;else try{s=ye(s,a)}catch{s=a}const i=await new Promise((a,o)=>{Rr.getInstance().run(r,async()=>{try{const u=await this.func(s,{...r,config:r});a(u)}catch(u){o(u)}})});if(i&&j.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const a=await i.stream(s,M(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??hr)-1}));for await(const o of a)yield o}else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Re(this.transform(r(),t));return await s.setup,re.fromAsyncGenerator(s)}}class go extends j{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await z.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),D(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let i;for(const a of this.runnables())try{const o=await a.invoke(e,M(t,{callbacks:s==null?void 0:s.getChild()}));return await(s==null?void 0:s.handleChainEnd(D(o,"output"))),o}catch(o){i===void 0&&(i=o)}throw i===void 0?new Error("No error stored at end of fallback."):(await(s==null?void 0:s.handleChainError(i)),i)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(u=>z.configure(u==null?void 0:u.callbacks,void 0,u==null?void 0:u.tags,void 0,u==null?void 0:u.metadata))),a=await Promise.all(i.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),D(e[c],"input"),void 0,void 0,void 0,void 0,s[c].runName)));let o;for(const u of this.runnables())try{const c=await u.batch(e,a.map((l,h)=>M(s[h],{callbacks:l==null?void 0:l.getChild()})),r);return await Promise.all(a.map((l,h)=>l==null?void 0:l.handleChainEnd(D(c[h],"output")))),c}catch(c){o===void 0&&(o=c)}throw o?(await Promise.all(a.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function ge(n){if(typeof n=="function")return new an({func:n});if(j.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=ge(r);return new xe({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class xs extends j{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof xe&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const s=this.mapper.getStepsKeys(),[i,a]=Ts(e),o=this.mapper.transform(a,M(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(const c of i){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([h])=>!s.includes(h)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Re(this.transform(r(),t));return await s.setup,re.fromAsyncGenerator(s)}}class yo extends j{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=new Re(this.transform(r(),t));return await s.setup,re.fromAsyncGenerator(s)}}class bo extends j{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=$(t);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,t){const r=$(t);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,r))if(yield a,i)if(s===void 0)s=a;else try{s=ye(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new xs(new xe({steps:e}))}}class wo extends j{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async r=>this.parseResult([{text:r}]),e,{...t,runType:"parser"}):this._callWithConfig(async r=>this.parseResult([{message:r,text:typeof r.content=="string"?r.content:JSON.stringify(r.content)}]),e,{...t,runType:"parser"})}}class _o extends wo{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class vo extends _o{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:typeof t.content=="string"?t.content:JSON.stringify(t.content)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class $s extends vo{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}}function Eo(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:i}=n;if(r&&s&&e)return`${s}/${e}`;if(r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i}function Ao(n){let e;return n.constructor.name===yi.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===bi.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}const Po=(n,e)=>n.reduce((t,r,s)=>{const i=Math.floor(s/e),a=t[i]||[];return t[i]=a.concat([r]),t},[]);class Co{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new Ps(e??{})}}class Oo extends Co{constructor(e,t){var c,l,h;const r={maxConcurrency:2,...e};super(r),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"dimensions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let s=(r==null?void 0:r.openAIApiKey)??H("OPENAI_API_KEY");const i=(r==null?void 0:r.azureOpenAIApiKey)??H("AZURE_OPENAI_API_KEY");if(!i&&!s)throw new Error("OpenAI or Azure OpenAI API key not found");const a=(r==null?void 0:r.azureOpenAIApiInstanceName)??H("AZURE_OPENAI_API_INSTANCE_NAME"),o=((r==null?void 0:r.azureOpenAIApiEmbeddingsDeploymentName)||(r==null?void 0:r.azureOpenAIApiDeploymentName))??(H("AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME")||H("AZURE_OPENAI_API_DEPLOYMENT_NAME")),u=(r==null?void 0:r.azureOpenAIApiVersion)??H("AZURE_OPENAI_API_VERSION");if(this.azureOpenAIBasePath=(r==null?void 0:r.azureOpenAIBasePath)??H("AZURE_OPENAI_BASE_PATH"),this.organization=((c=r==null?void 0:r.configuration)==null?void 0:c.organization)??H("OPENAI_ORGANIZATION"),this.modelName=(r==null?void 0:r.modelName)??this.modelName,this.batchSize=(r==null?void 0:r.batchSize)??(i?1:this.batchSize),this.stripNewLines=(r==null?void 0:r.stripNewLines)??this.stripNewLines,this.timeout=r==null?void 0:r.timeout,this.dimensions=r==null?void 0:r.dimensions,this.azureOpenAIApiVersion=u,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=o,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");s=s??""}this.clientConfig={apiKey:s,organization:this.organization,baseURL:t==null?void 0:t.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:(l=t==null?void 0:t.baseOptions)==null?void 0:l.headers,defaultQuery:(h=t==null?void 0:t.baseOptions)==null?void 0:h.params,...t,...e==null?void 0:e.configuration}}async embedDocuments(e){const t=Po(this.stripNewLines?e.map(a=>a.replace(/\n/g," ")):e,this.batchSize),r=t.map(a=>{const o={model:this.modelName,input:a};return this.dimensions&&(o.dimensions=this.dimensions),this.embeddingWithRetry(o)}),s=await Promise.all(r),i=[];for(let a=0;a<s.length;a+=1){const o=t[a],{data:u}=s[a];for(let c=0;c<o.length;c+=1)i.push(u[c].embedding)}return i}async embedQuery(e){const t={model:this.modelName,input:this.stripNewLines?e.replace(/\n/g," "):e};this.dimensions&&(t.dimensions=this.dimensions);const{data:r}=await this.embeddingWithRetry(t);return r[0].embedding}async embeddingWithRetry(e){if(!this.client){const r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},s=Eo(r),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new T(i)}const t={};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(r){throw Ao(r)}})}}const Io="modulepreload",So=function(n){return"/"+n},Bn={},dr=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){const i=document.getElementsByTagName("link");s=Promise.all(t.map(a=>{if(a=So(a),a in Bn)return;Bn[a]=!0;const o=a.endsWith(".css"),u=o?'[rel="stylesheet"]':"";if(!!r)for(let h=i.length-1;h>=0;h--){const d=i[h];if(d.href===a&&(!o||d.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${u}`))return;const l=document.createElement("link");if(l.rel=o?"stylesheet":Io,o||(l.as="script",l.crossOrigin=""),l.href=a,document.head.appendChild(l),o)return new Promise((h,d)=>{l.addEventListener("load",h),l.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${a}`)))})}))}return s.then(()=>e()).catch(i=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i})};class To extends j{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[i,a]of Object.entries(t))typeof a=="string"?r[i]=a:r[i]=await a();return{...r,...e}}async invoke(e,t){return this._callWithConfig(r=>this.formatPromptValue(r),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await dr(()=>Promise.resolve().then(()=>Un),void 0);return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await dr(()=>Promise.resolve().then(()=>Un),void 0);return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await dr(()=>import("./few_shot-BBZZZ-wJ.js"),__vite__mapDeps([]));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}class Ro extends To{async formatPromptValue(e){const t=await this.format(e);return new Bi(t)}}const Ns=n=>{const e=n.split(""),t=[],r=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")t.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")t.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const i=r("}",s);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const i=r("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");t.push({type:"literal",text:a}),s=i<0?e.length:i}}return t},xo=(n,e)=>Ns(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`Missing value for input ${r.name}`)}return t+r.text},""),xr={"f-string":xo},$o={"f-string":Ns},Le=(n,e,t)=>xr[e](n,t),No=(n,e)=>$o[e](n),jo=(n,e,t)=>{if(!(e in xr)){const r=Object.keys(xr);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=t.reduce((s,i)=>(s[i]="foo",s),{});Array.isArray(n)?n.forEach(s=>{if(s.type==="text")Le(s.text,e,r);else if(s.type==="image_url")if(typeof s.image_url=="string")Le(s.image_url,e,r);else{const i=s.image_url.url;Le(i,e,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):Le(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};class he extends Ro{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),jo(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return Le(this.template,this.templateFormat,t)}static fromExamples(e,t,r,s=`

`,i=""){const a=[i,...e,t].join(s);return new he({inputVariables:r,template:a})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){const s=new Set;return No(e,t).forEach(i=>{i.type==="variable"&&s.add(i.name)}),new he({inputVariables:[...s],templateFormat:t,template:e,...r})}async partial(e){const t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:r};return new he(s)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new he({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}const Un=Object.freeze(Object.defineProperty({__proto__:null,PromptTemplate:he},Symbol.toStringTag,{value:"Module"}));function ko(n,e){let t=0,r=0,s=0;for(let i=0;i<n.length;i++)t+=n[i]*e[i],r+=n[i]*n[i],s+=e[i]*e[i];return t/(Math.sqrt(r)*Math.sqrt(s))}class Lo extends j{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,t){throw new Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,$(t))}async getRelevantDocuments(e,t){const r=$(Qa(t)),s=await z.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,void 0,void 0,void 0,void 0,r.runName));try{const a=await this._getRelevantDocuments(e,i);return await(i==null?void 0:i.handleRetrieverEnd(a)),a}catch(a){throw await(i==null?void 0:i.handleRetrieverError(a)),a}}}class fr extends Lo{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t==null?void 0:t.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t==null?void 0:t.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class Do extends fe{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,t=4,r=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map(a=>a[0])}async similaritySearchWithScore(e,t=4,r=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,s,i,a){if(typeof e=="number")return new fr({vectorStore:this,k:e,filter:t,tags:[...s??[],this._vectorstoreType()],metadata:i,verbose:a,callbacks:r});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new fr({...o,searchKwargs:e.searchKwargs}):new fr({...o})}}}class pr{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent?e.pageContent.toString():this.pageContent,this.metadata=e.metadata??{}}}class on extends Do{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??ko}async addDocuments(e){const t=e.map(({pageContent:r})=>r);return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){const r=e.map((s,i)=>({content:t[i].pageContent,embedding:s,metadata:t[i].metadata}));this.memoryVectors=this.memoryVectors.concat(r)}async similaritySearchVectorWithScore(e,t,r){const s=u=>{if(!r)return!0;const c=new pr({metadata:u.metadata,pageContent:u.content});return r(c)},i=this.memoryVectors.filter(s);return i.map((u,c)=>({similarity:this.similarity(e,u.embedding),index:c})).sort((u,c)=>u.similarity>c.similarity?-1:0).slice(0,t).map(u=>[new pr({metadata:i[u.index].metadata,pageContent:i[u.index].content}),u.similarity])}static async fromTexts(e,t,r,s){const i=[];for(let a=0;a<e.length;a+=1){const o=Array.isArray(t)?t[a]:t,u=new pr({pageContent:e[a],metadata:o});i.push(u)}return on.fromDocuments(i,r,s)}static async fromDocuments(e,t,r){const s=new this(t,r);return await s.addDocuments(e),s}static async fromExistingIndex(e,t){return new this(e,t)}}var pe={exports:{}};const Bo={},Uo=Object.freeze(Object.defineProperty({__proto__:null,default:Bo},Symbol.toStringTag,{value:"Module"})),Jt=wi(Uo),Mo="dotenv",Fo="16.4.5",Ho="Loads environment variables from .env file",Vo="lib/main.js",zo="lib/main.d.ts",qo={".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},Go={"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard","lint-readme":"standard-markdown",pretest:"npm run lint && npm run dts-check",test:"tap tests/*.js --100 -Rspec","test:coverage":"tap --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},Ko={type:"git",url:"git://github.com/motdotla/dotenv.git"},Jo="https://dotenvx.com",Wo=["dotenv","env",".env","environment","variables","config","settings"],Qo="README.md",Yo="BSD-2-Clause",Xo={"@definitelytyped/dtslint":"^0.0.133","@types/node":"^18.11.3",decache:"^4.6.1",sinon:"^14.0.1",standard:"^17.0.0","standard-markdown":"^7.1.0","standard-version":"^9.5.0",tap:"^16.3.0",tar:"^6.1.11",typescript:"^4.8.4"},Zo={node:">=12"},eu={fs:!1},tu={name:Mo,version:Fo,description:Ho,main:Vo,types:zo,exports:qo,scripts:Go,repository:Ko,funding:Jo,keywords:Wo,readmeFilename:Qo,license:Yo,devDependencies:Xo,engines:Zo,browser:eu};var Me={};const $r=Jt,un=Jt,ru=Jt,nu=Jt,su=tu,cn=su.version,iu=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function au(n){const e={};let t=n.toString();t=t.replace(/\r\n?/mg,`
`);let r;for(;(r=iu.exec(t))!=null;){const s=r[1];let i=r[2]||"";i=i.trim();const a=i[0];i=i.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),a==='"'&&(i=i.replace(/\\n/g,`
`),i=i.replace(/\\r/g,"\r")),e[s]=i}return e}function ou(n){const e=ks(n),t=I.configDotenv({path:e});if(!t.parsed){const a=new Error(`MISSING_DATA: Cannot parse ${e} for an unknown reason`);throw a.code="MISSING_DATA",a}const r=js(n).split(","),s=r.length;let i;for(let a=0;a<s;a++)try{const o=r[a].trim(),u=lu(t,o);i=I.decrypt(u.ciphertext,u.key);break}catch(o){if(a+1>=s)throw o}return I.parse(i)}function uu(n){console.log(`[dotenv@${cn}][INFO] ${n}`)}function cu(n){console.log(`[dotenv@${cn}][WARN] ${n}`)}function Mt(n){console.log(`[dotenv@${cn}][DEBUG] ${n}`)}function js(n){return n&&n.DOTENV_KEY&&n.DOTENV_KEY.length>0?n.DOTENV_KEY:Me.DOTENV_KEY&&Me.DOTENV_KEY.length>0?Me.DOTENV_KEY:""}function lu(n,e){let t;try{t=new URL(e)}catch(o){if(o.code==="ERR_INVALID_URL"){const u=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw u.code="INVALID_DOTENV_KEY",u}throw o}const r=t.password;if(!r){const o=new Error("INVALID_DOTENV_KEY: Missing key part");throw o.code="INVALID_DOTENV_KEY",o}const s=t.searchParams.get("environment");if(!s){const o=new Error("INVALID_DOTENV_KEY: Missing environment part");throw o.code="INVALID_DOTENV_KEY",o}const i=`DOTENV_VAULT_${s.toUpperCase()}`,a=n.parsed[i];if(!a){const o=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${i} in your .env.vault file.`);throw o.code="NOT_FOUND_DOTENV_ENVIRONMENT",o}return{ciphertext:a,key:r}}function ks(n){let e=null;if(n&&n.path&&n.path.length>0)if(Array.isArray(n.path))for(const t of n.path)$r.existsSync(t)&&(e=t.endsWith(".vault")?t:`${t}.vault`);else e=n.path.endsWith(".vault")?n.path:`${n.path}.vault`;else e=un.resolve(process.cwd(),".env.vault");return $r.existsSync(e)?e:null}function Mn(n){return n[0]==="~"?un.join(ru.homedir(),n.slice(1)):n}function hu(n){uu("Loading env from encrypted .env.vault");const e=I._parseVault(n);let t=Me;return n&&n.processEnv!=null&&(t=n.processEnv),I.populate(t,e,n),{parsed:e}}function du(n){const e=un.resolve(process.cwd(),".env");let t="utf8";const r=!!(n&&n.debug);n&&n.encoding?t=n.encoding:r&&Mt("No encoding is specified. UTF-8 is used by default");let s=[e];if(n&&n.path)if(!Array.isArray(n.path))s=[Mn(n.path)];else{s=[];for(const u of n.path)s.push(Mn(u))}let i;const a={};for(const u of s)try{const c=I.parse($r.readFileSync(u,{encoding:t}));I.populate(a,c,n)}catch(c){r&&Mt(`Failed to load ${u} ${c.message}`),i=c}let o=Me;return n&&n.processEnv!=null&&(o=n.processEnv),I.populate(o,a,n),i?{parsed:a,error:i}:{parsed:a}}function fu(n){if(js(n).length===0)return I.configDotenv(n);const e=ks(n);return e?I._configVault(n):(cu(`You set DOTENV_KEY but you are missing a .env.vault file at ${e}. Did you forget to build it?`),I.configDotenv(n))}function pu(n,e){const t=Buffer.from(e.slice(-64),"hex");let r=Buffer.from(n,"base64");const s=r.subarray(0,12),i=r.subarray(-16);r=r.subarray(12,-16);try{const a=nu.createDecipheriv("aes-256-gcm",t,s);return a.setAuthTag(i),`${a.update(r)}${a.final()}`}catch(a){const o=a instanceof RangeError,u=a.message==="Invalid key length",c=a.message==="Unsupported state or unable to authenticate data";if(o||u){const l=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw l.code="INVALID_DOTENV_KEY",l}else if(c){const l=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw l.code="DECRYPTION_FAILED",l}else throw a}}function mu(n,e,t={}){const r=!!(t&&t.debug),s=!!(t&&t.override);if(typeof e!="object"){const i=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw i.code="OBJECT_REQUIRED",i}for(const i of Object.keys(e))Object.prototype.hasOwnProperty.call(n,i)?(s===!0&&(n[i]=e[i]),r&&Mt(s===!0?`"${i}" is already defined and WAS overwritten`:`"${i}" is already defined and was NOT overwritten`)):n[i]=e[i]}const I={configDotenv:du,_configVault:hu,_parseVault:ou,config:fu,decrypt:pu,parse:au,populate:mu};pe.exports.configDotenv=I.configDotenv;pe.exports._configVault=I._configVault;pe.exports._parseVault=I._parseVault;pe.exports.config=I.config;pe.exports.decrypt=I.decrypt;pe.exports.parse=I.parse;pe.exports.populate=I.populate;pe.exports=I;var ln={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};document.addEventListener("DOMContentLoaded",()=>{const n=localStorage.getItem("conversation"),e=document.getElementById("chatbot-conversation-container");let t=parseInt(Us("interactionCount"))||0;function r(){return"user-"+Q()}n&&(e.innerHTML=n,Ds(e)),document.addEventListener("submit",async s=>{s.preventDefault(),t<3?(await Pu(),t++,Ms("interactionCount",t,1),r()):Bs()})});const gu=ln.VITE_SUPAB_API_KEY,yu=ln.VITE_SUPA_URL,Ls=ln.VITE_OPEN_AI_API_KEY;console.log("keys: ",gu,yu,Ls);const bu="Given a question, convert it in a standalonequestion. question: {question} standalone question:",wu=he.fromTemplate(bu),_u=`You are Elder Bot, a helpful and enthusiastic missionary bot dedicated to answering questions about the Book of Mormon. Your responses are based solely on the provided context of the Book of Mormon. If you're unable to find a direct answer, kindly direct the questioner to further explore the teachings of the Book of Mormon at https://www.churchofjesuschrist.org/comeuntochrist/ps/book-of-mormon-lesson. Always cite appropriate verses and chapters when providing answers.

Please note that your responses are limited to questions related to the Book of Mormon. If the question is outside of this context, kindly inform the user that it is beyond your scope of knowledge.

Context: {context}
Question: {question}
Answer:
`,vu=he.fromTemplate(_u),Eu=wu.pipe(llm).pipe(new $s),Au=vu.pipe(llm).pipe(new $s);function Ds(n){n.scrollTop=n.scrollHeight}async function Pu(){const n=document.getElementById("user-input"),e=document.getElementById("chatbot-conversation-container");document.getElementById("typing-indicator-container");const t=n.value;n.value="";const r=document.createElement("div");r.classList.add("speech","speech-human"),e.appendChild(r),r.textContent=t,e.scrollTop=e.scrollHeight;let s=parseInt(Us("interactionCount"))||0;if(s>=3){Bs();return}s++,Ms("interactionCount",s,1);const i=await Ru.invoke({question:t}),a=document.createElement("div");a.classList.add("speech","speech-ai"),e.appendChild(a),a.textContent=i,e.scrollTop=e.scrollHeight,Ds(e),localStorage.setItem("conversation",e.innerHTML)}function Bs(){const n=document.getElementById("chatbot-conversation-container"),e=document.createElement("div");e.textContent="You have reached the maximum number of interactions for today. Please contact thechurchofjesuschrist.org for a better conversion",e.classList.add("speech","speech-ai"),n.appendChild(e),n.scrollTop=n.scrollHeight}function Us(n){const t=`; ${document.cookie}`.split(`; ${n}=`);if(t.length===2)return t.pop().split(";").shift()}function Ms(n,e,t){const r=new Date;r.setTime(r.getTime()+t*24*60*60*1e3);const s="expires="+r.toUTCString();document.cookie=n+"="+e+";"+s+";path=/"}const Cu=new Oo({openAIApiKey:Ls}),Ou=new on(Cu,{client,tableName:"documents",queryName:"match_documents"}),Iu=Ou.asRetriever();function Su(n){return n.map(e=>e.pageContent).join(`

`)}const Tu=le.from([n=>n.standalone_question,Iu,Su]),Ru=le.from([{standalone_question:Eu,original_input:new bo},{context:Tu,question:({original_input:n})=>n.question},Au]);export{To as B,dc as C,he as P,Ro as a,jo as c,Le as r};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
